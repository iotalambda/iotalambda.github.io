1:HL["/_next/static/media/3d9ea938b6afa941-s.p.woff2",{"as":"font","type":"font/woff2"}]
2:HL["/_next/static/media/7eaa4a2482b4df1a-s.p.woff2",{"as":"font","type":"font/woff2"}]
3:HL["/_next/static/css/488301a2e2aae266.css",{"as":"style"}]
0:["PsZqLCFMFDR2tkN75POzO",[[["",{"children":[["id","2023/11/03/Deep-dive-to-Azure-Functions-with-golang","c"],{"children":["__PAGE__?{\"id\":[\"2023\",\"11\",\"03\",\"Deep-dive-to-Azure-Functions-with-golang\"]}",{}]}]},"$undefined","$undefined",true],"$L4",[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/488301a2e2aae266.css","precedence":"next"}]],"$L5"]]]]
6:HL["/_next/static/css/301e7291452e98cd.css",{"as":"style"}]
7:I{"id":6685,"chunks":["685:static/chunks/685-a8c11ad368fada34.js","185:static/chunks/app/layout-0afbb0e01943be7f.js"],"name":"","async":false}
8:I{"id":7767,"chunks":["272:static/chunks/webpack-b2aba447c1dc2205.js","971:static/chunks/fd9d1056-a99b58d3cc150217.js","596:static/chunks/596-9d43875837bd0b65.js"],"name":"default","async":false}
9:I{"id":7920,"chunks":["272:static/chunks/webpack-b2aba447c1dc2205.js","971:static/chunks/fd9d1056-a99b58d3cc150217.js","596:static/chunks/596-9d43875837bd0b65.js"],"name":"default","async":false}
4:[null,["$","html",null,{"lang":"en","className":"__variable_965427 __variable_9c011f","children":["$","body",null,{"className":"bg-slate-200 dark:bg-slate-700","children":[["$","nav",null,{"className":"w-full flex flex-row justify-between bg-indigo-600 shadow-indigo-300 dark:shadow-indigo-800 shadow-2xl font-sans","children":["$","div",null,{"className":"p-2","children":["$","$L7",null,{"className":"text-2xl font-semibold text-neutral-100 dark:text-neutral-200","href":"/","children":[["$","h1",null,{"className":"inline","children":"üçî food for ai"}]," ",["$","span",null,{"className":"font-mono font-light text-xs","children":"food.joona.cloud"}]]}]}]}],["$","main",null,{"className":"mt-4","children":["$","$L8",null,{"parallelRouterKey":"children","segmentPath":["children"],"loading":"$undefined","loadingStyles":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","template":["$","$L9",null,{}],"templateStyles":"$undefined","notFound":[["$","title",null,{"children":"404: This page could not be found."}],["$","div",null,{"style":{"fontFamily":"system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"","height":"100vh","textAlign":"center","display":"flex","flexDirection":"column","alignItems":"center","justifyContent":"center"},"children":["$","div",null,{"children":[["$","style",null,{"dangerouslySetInnerHTML":{"__html":"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}"}}],["$","h1",null,{"className":"next-error-h1","style":{"display":"inline-block","margin":"0 20px 0 0","padding":"0 23px 0 0","fontSize":24,"fontWeight":500,"verticalAlign":"top","lineHeight":"49px"},"children":"404"}],["$","div",null,{"style":{"display":"inline-block"},"children":["$","h2",null,{"style":{"fontSize":14,"fontWeight":400,"lineHeight":"49px","margin":0},"children":"This page could not be found."}]}]]}]}]],"notFoundStyles":[],"childProp":{"current":["$","$L8",null,{"parallelRouterKey":"children","segmentPath":["children",["id","2023/11/03/Deep-dive-to-Azure-Functions-with-golang","c"],"children"],"loading":"$undefined","loadingStyles":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","template":["$","$L9",null,{}],"templateStyles":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","childProp":{"current":["$La","$Lb",null],"segment":"__PAGE__?{\"id\":[\"2023\",\"11\",\"03\",\"Deep-dive-to-Azure-Functions-with-golang\"]}"},"styles":[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/301e7291452e98cd.css","precedence":"next"}]]}],"segment":["id","2023/11/03/Deep-dive-to-Azure-Functions-with-golang","c"]},"styles":[]}]}]]}]}],null]
5:[["$","meta","0",{"charSet":"utf-8"}],["$","title","1",{"children":"Deep dive to Azure Functions with Go | Food for AI blog"}],["$","meta","2",{"name":"description","content":"Blog about .NET, Azure, React and whatever comes to mind."}],["$","meta","3",{"name":"viewport","content":"width=device-width, initial-scale=1"}],["$","link","4",{"rel":"icon","href":"/favicon.ico","type":"image/x-icon","sizes":"16x16"}],["$","meta","5",{"name":"next-size-adjust"}]]
c:T710a,<p>Azure Functions has supported <em>Custom Handlers</em> since 2020. With Custom Handlers any web server that is able to run on one the available Azure Functions platforms can function as a handler. So in this article we'll delve into the details of implementing a timer triggered Azure Function with Go ‚Äì Go not being a first-class citizen in the Azure Functions world (unlike C#, Java, JavaScript, TypeScript, Python and PowerShell).</p>
<p>My goal was to create a scheduled task that is able to scrape data from a web page periodically and send me a push notification if the data has changed. Ultimately I ended up creating a relatively generic solution for this purpose, available in the git repo.</p>
<h2 id="setting-up-the-project"><a href="#setting-up-the-project">Setting up the project</a></h2>
<p>Following the <a href="https://learn.microsoft.com/en-us/azure/azure-functions/create-first-function-vs-code-other?tabs=go%2Clinux">Microsoft tutorial</a>, we end up with an empty Azure Functions project and several open questions. We'd like to create a timer triggered function, so we can simply ditch the default HTTP triggered function and execute <code>func new -l Custom -t TimerTrigger -n timer</code>.</p>
<p>In the newly created <code>timer</code> directory we now have a <code>function.json</code> file:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="json" data-theme="light"><code data-language="json" data-theme="light"><span class="line"><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #005CC5">"bindings"</span><span style="color: #24292E">: [</span></span>
<span class="line"><span style="color: #24292E">    {</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #005CC5">"name"</span><span style="color: #24292E">: </span><span style="color: #032F62">"myTimer"</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #005CC5">"type"</span><span style="color: #24292E">: </span><span style="color: #032F62">"timerTrigger"</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #005CC5">"direction"</span><span style="color: #24292E">: </span><span style="color: #032F62">"in"</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #005CC5">"schedule"</span><span style="color: #24292E">: </span><span style="color: #032F62">"0 */5 * * * *"</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">  ]</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre><pre data-language="json" data-theme="dark"><code data-language="json" data-theme="dark"><span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #79B8FF">"bindings"</span><span style="color: #E1E4E8">: [</span></span>
<span class="line"><span style="color: #E1E4E8">    {</span></span>
<span class="line"><span style="color: #E1E4E8">      </span><span style="color: #79B8FF">"name"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"myTimer"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">      </span><span style="color: #79B8FF">"type"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"timerTrigger"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">      </span><span style="color: #79B8FF">"direction"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"in"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">      </span><span style="color: #79B8FF">"schedule"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"0 */5 * * * *"</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"><span style="color: #E1E4E8">  ]</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre></div>
<p>It's all quite clear. The <code>name</code> property seems a bit suspicious, but I suppose it's just a name for an individual schedule (could be e.g. "hourly"), and not something that affects the control flow that much.</p>
<p>Next the <code>host.json</code> file. Our Go web server implementation will be an executable, so the <code>customHandler</code> section should be configured as follows:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="json" data-theme="light"><code data-language="json" data-theme="light"><span class="line"><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #005CC5">"version"</span><span style="color: #24292E">: </span><span style="color: #032F62">"2.0"</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #005CC5">"logging"</span><span style="color: #24292E">: {</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #005CC5">"applicationInsights"</span><span style="color: #24292E">: {</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #005CC5">"samplingSettings"</span><span style="color: #24292E">: {</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #005CC5">"isEnabled"</span><span style="color: #24292E">: </span><span style="color: #005CC5">true</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #005CC5">"excludedTypes"</span><span style="color: #24292E">: </span><span style="color: #032F62">"Request"</span></span>
<span class="line"><span style="color: #24292E">      }</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">  },</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #005CC5">"extensionBundle"</span><span style="color: #24292E">: {</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #005CC5">"id"</span><span style="color: #24292E">: </span><span style="color: #032F62">"Microsoft.Azure.Functions.ExtensionBundle"</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #005CC5">"version"</span><span style="color: #24292E">: </span><span style="color: #032F62">"[4.*, 5.0.0)"</span></span>
<span class="line"><span style="color: #24292E">  },</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #005CC5">"customHandler"</span><span style="color: #24292E">: {</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #005CC5">"description"</span><span style="color: #24292E">: {</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #005CC5">"defaultExecutablePath"</span><span style="color: #24292E">: </span><span style="color: #032F62">"build/beenotif"</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #005CC5">"workingDirectory"</span><span style="color: #24292E">: </span><span style="color: #032F62">""</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">      </span><span style="color: #005CC5">"arguments"</span><span style="color: #24292E">: []</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre><pre data-language="json" data-theme="dark"><code data-language="json" data-theme="dark"><span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #79B8FF">"version"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"2.0"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #79B8FF">"logging"</span><span style="color: #E1E4E8">: {</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">"applicationInsights"</span><span style="color: #E1E4E8">: {</span></span>
<span class="line"><span style="color: #E1E4E8">      </span><span style="color: #79B8FF">"samplingSettings"</span><span style="color: #E1E4E8">: {</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #79B8FF">"isEnabled"</span><span style="color: #E1E4E8">: </span><span style="color: #79B8FF">true</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #79B8FF">"excludedTypes"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"Request"</span></span>
<span class="line"><span style="color: #E1E4E8">      }</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"><span style="color: #E1E4E8">  },</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #79B8FF">"extensionBundle"</span><span style="color: #E1E4E8">: {</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">"id"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"Microsoft.Azure.Functions.ExtensionBundle"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">"version"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"[4.*, 5.0.0)"</span></span>
<span class="line"><span style="color: #E1E4E8">  },</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #79B8FF">"customHandler"</span><span style="color: #E1E4E8">: {</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">"description"</span><span style="color: #E1E4E8">: {</span></span>
<span class="line"><span style="color: #E1E4E8">      </span><span style="color: #79B8FF">"defaultExecutablePath"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"build/beenotif"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">      </span><span style="color: #79B8FF">"workingDirectory"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">""</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">      </span><span style="color: #79B8FF">"arguments"</span><span style="color: #E1E4E8">: []</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"><span style="color: #E1E4E8">  }</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre></div>
<p>and therefore <code>build</code> should be added to <code>.gitignore</code>. Initially I used <code>bin/beenotif</code> as the <code>defaultExecutablePath</code>, but for some reason Azure Functions deployment did not want to upload the <code>bin</code> directory contents to the Function App at all, so there must be some undocumented logic which prevents that.</p>
<p>Finally, we need to initialize a Go module:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="sh" data-theme="light"><code data-language="sh" data-theme="light"><span class="line"><span style="color: #6F42C1">go</span><span style="color: #24292E"> </span><span style="color: #032F62">mod</span><span style="color: #24292E"> </span><span style="color: #032F62">init</span><span style="color: #24292E"> </span><span style="color: #032F62">beenotif</span></span></code></pre><pre data-language="sh" data-theme="dark"><code data-language="sh" data-theme="dark"><span class="line"><span style="color: #B392F0">go</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">mod</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">init</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">beenotif</span></span></code></pre></div>
<p>with a temporarily empty <code>main.go</code>:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="go" data-theme="light"><code data-language="go" data-theme="light"><span class="line"><span style="color: #D73A49">package</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">func</span><span style="color: #24292E"> </span><span style="color: #6F42C1">main</span><span style="color: #24292E">() {</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre><pre data-language="go" data-theme="dark"><code data-language="go" data-theme="dark"><span class="line"><span style="color: #F97583">package</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">main</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">func</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">main</span><span style="color: #E1E4E8">() {</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre></div>
<p>and our Function App is able to build and run locally:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="sh" data-theme="light"><code data-language="sh" data-theme="light"><span class="line"><span style="color: #6F42C1">go</span><span style="color: #24292E"> </span><span style="color: #032F62">build</span><span style="color: #24292E"> </span><span style="color: #005CC5">-o</span><span style="color: #24292E"> </span><span style="color: #032F62">build/</span><span style="color: #24292E"> &#x26;&#x26; </span><span style="color: #6F42C1">func</span><span style="color: #24292E"> </span><span style="color: #032F62">start</span></span></code></pre><pre data-language="sh" data-theme="dark"><code data-language="sh" data-theme="dark"><span class="line"><span style="color: #B392F0">go</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">build</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">-o</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">build/</span><span style="color: #E1E4E8"> &#x26;&#x26; </span><span style="color: #B392F0">func</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">start</span></span></code></pre></div>
<h2 id="the-handler"><a href="#the-handler">The handler</a></h2>
<p>Microsoft's tutorial page offers an example on how to create an HTTP triggered function, but finding out how to create a timer triggered one took some trial and effort. Apparently, an HTTP handler with a pattern <code>/functionNameHere</code> will be the one invoked based on the CRON schedule - functionNameHere being the name used in the <code>func new</code> command. So in our case the correct pattern is <code>/timer</code>:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="go" data-theme="light"><code data-language="go" data-theme="light"><span class="line"><span style="color: #24292E">http.</span><span style="color: #005CC5">HandleFunc</span><span style="color: #24292E">(</span><span style="color: #032F62">"/timer"</span><span style="color: #24292E">, </span><span style="color: #D73A49">func</span><span style="color: #24292E">(w http.ResponseWriter, r </span><span style="color: #D73A49">*</span><span style="color: #24292E">http.Request) {</span></span>
<span class="line"><span style="color: #24292E">		fmt.</span><span style="color: #005CC5">Print</span><span style="color: #24292E">(</span><span style="color: #032F62">"Hey!</span><span style="color: #005CC5">\n</span><span style="color: #032F62">"</span><span style="color: #24292E">)</span></span>
<span class="line"><span style="color: #24292E">		w.</span><span style="color: #005CC5">Header</span><span style="color: #24292E">().</span><span style="color: #005CC5">Set</span><span style="color: #24292E">(</span><span style="color: #032F62">"Content-Type"</span><span style="color: #24292E">, </span><span style="color: #032F62">"application/json"</span><span style="color: #24292E">)</span></span>
<span class="line"><span style="color: #24292E">		w.</span><span style="color: #005CC5">WriteHeader</span><span style="color: #24292E">(</span><span style="color: #005CC5">201</span><span style="color: #24292E">)</span></span>
<span class="line"><span style="color: #24292E">		_, err </span><span style="color: #D73A49">=</span><span style="color: #24292E"> w.</span><span style="color: #005CC5">Write</span><span style="color: #24292E">([]</span><span style="color: #005CC5">byte</span><span style="color: #24292E">(</span><span style="color: #032F62">"{}"</span><span style="color: #24292E">))</span></span>
<span class="line"><span style="color: #24292E">		</span><span style="color: #D73A49">if</span><span style="color: #24292E"> err </span><span style="color: #D73A49">!=</span><span style="color: #24292E"> </span><span style="color: #005CC5">nil</span><span style="color: #24292E"> {</span></span>
<span class="line"><span style="color: #24292E">			log.</span><span style="color: #005CC5">Fatal</span><span style="color: #24292E">(</span><span style="color: #032F62">"Could not write response."</span><span style="color: #24292E">)</span></span>
<span class="line"><span style="color: #24292E">		}</span></span>
<span class="line"><span style="color: #24292E">})</span></span></code></pre><pre data-language="go" data-theme="dark"><code data-language="go" data-theme="dark"><span class="line"><span style="color: #E1E4E8">http.</span><span style="color: #79B8FF">HandleFunc</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"/timer"</span><span style="color: #E1E4E8">, </span><span style="color: #F97583">func</span><span style="color: #E1E4E8">(w http.ResponseWriter, r </span><span style="color: #F97583">*</span><span style="color: #E1E4E8">http.Request) {</span></span>
<span class="line"><span style="color: #E1E4E8">		fmt.</span><span style="color: #79B8FF">Print</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"Hey!</span><span style="color: #79B8FF">\n</span><span style="color: #9ECBFF">"</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">		w.</span><span style="color: #79B8FF">Header</span><span style="color: #E1E4E8">().</span><span style="color: #79B8FF">Set</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"Content-Type"</span><span style="color: #E1E4E8">, </span><span style="color: #9ECBFF">"application/json"</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">		w.</span><span style="color: #79B8FF">WriteHeader</span><span style="color: #E1E4E8">(</span><span style="color: #79B8FF">201</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">		_, err </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> w.</span><span style="color: #79B8FF">Write</span><span style="color: #E1E4E8">([]</span><span style="color: #79B8FF">byte</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"{}"</span><span style="color: #E1E4E8">))</span></span>
<span class="line"><span style="color: #E1E4E8">		</span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> err </span><span style="color: #F97583">!=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">nil</span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">			log.</span><span style="color: #79B8FF">Fatal</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"Could not write response."</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">		}</span></span>
<span class="line"><span style="color: #E1E4E8">})</span></span></code></pre></div>
<p>Note that the handler must return something, or otherwise the function execution <a href="https://learn.microsoft.com/en-us/answers/questions/614450/custom-handler-function-not-marking-run-as-complet">will never be marked as completed</a>.</p>
<h2 id="scraping-with-chromedp"><a href="#scraping-with-chromedp">Scraping with <code>chromedp</code></a></h2>
<p><code>chromedp</code> offers a surprisingly effective toolkit for our web scraping needs. The page we need to do scraping on is an SPA, so a simple <code>GET</code> wouldn't do it, but instead we need to launch a headless browser in our service, download the SPA and let the SPA's JavaScript do its thing before scraping:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="go" data-theme="light"><code data-language="go" data-theme="light"><span class="line"><span style="color: #24292E">err </span><span style="color: #D73A49">:=</span><span style="color: #24292E"> chromedp.</span><span style="color: #005CC5">Run</span><span style="color: #24292E">(dpctx,</span></span>
<span class="line"><span style="color: #24292E">	chromedp.</span><span style="color: #005CC5">Navigate</span><span style="color: #24292E">(config.TargetUrl),</span></span>
<span class="line"><span style="color: #24292E">	chromedp.</span><span style="color: #005CC5">Sleep</span><span style="color: #24292E">(time.</span><span style="color: #005CC5">Duration</span><span style="color: #24292E">(config.WaitSeconds)</span><span style="color: #D73A49">*</span><span style="color: #24292E">time.Second),</span></span>
<span class="line"><span style="color: #24292E">	chromedp.</span><span style="color: #005CC5">EvaluateAsDevTools</span><span style="color: #24292E">(config.StringArrayJs, </span><span style="color: #D73A49">&#x26;</span><span style="color: #24292E">items),</span></span>
<span class="line"><span style="color: #24292E">)</span></span></code></pre><pre data-language="go" data-theme="dark"><code data-language="go" data-theme="dark"><span class="line"><span style="color: #E1E4E8">err </span><span style="color: #F97583">:=</span><span style="color: #E1E4E8"> chromedp.</span><span style="color: #79B8FF">Run</span><span style="color: #E1E4E8">(dpctx,</span></span>
<span class="line"><span style="color: #E1E4E8">	chromedp.</span><span style="color: #79B8FF">Navigate</span><span style="color: #E1E4E8">(config.TargetUrl),</span></span>
<span class="line"><span style="color: #E1E4E8">	chromedp.</span><span style="color: #79B8FF">Sleep</span><span style="color: #E1E4E8">(time.</span><span style="color: #79B8FF">Duration</span><span style="color: #E1E4E8">(config.WaitSeconds)</span><span style="color: #F97583">*</span><span style="color: #E1E4E8">time.Second),</span></span>
<span class="line"><span style="color: #E1E4E8">	chromedp.</span><span style="color: #79B8FF">EvaluateAsDevTools</span><span style="color: #E1E4E8">(config.StringArrayJs, </span><span style="color: #F97583">&#x26;</span><span style="color: #E1E4E8">items),</span></span>
<span class="line"><span style="color: #E1E4E8">)</span></span></code></pre></div>
<p>With <code>EvaluateAsDevTools</code> we are able to run JavaScript and DOM queries exactly like in a full fledged Chrome.</p>
<p><code>chromedp</code> requires a <code>chrome</code> executable to function and apparently there <a href="https://learn.microsoft.com/en-us/answers/questions/1354174/cannot-find-chrome-binary-in-azure-function-app">has</a> <a href="https://anthonychu.ca/post/azure-functions-headless-chromium-puppeteer-playwright/">been</a> <a href="https://stackoverflow.com/questions/65609204/puppeteer-throws-launch-exception-when-deployed-on-azure-functions-node-on-linux">some</a> issues with it in the Consumption Plan. One of the ways to deal with this is naturally to have the Function App running in a container with all the necessary dependencies. But Consumption Plan does not support Docker, so I'd need to pay a non-zero amount of money for other tiers and that's unacceptable. But we can simply omit this issue by downloading prebuilt Chromium binaries and deploying them along the application.</p>
<p>In <a href="https://www.chromium.org/getting-involved/download-chromium/">chromium.org</a> there's a link to a <a href="https://github.com/scheib/chromium-latest-linux">repo</a> with a <a href="https://github.com/scheib/chromium-latest-linux/blob/master/update.sh">script</a> that downloads the latest binaries. That could be tweaked for our needs and our directory structure! The tweaked version is in <a href="https://github.com/iotalambda/beenotif/blob/main/publish.sh">publish.sh</a>. This script file is meant to be executed either manually before deploying from VSCode or automatically by pipelines.</p>
<p>The last thing to do is tell <code>chromedp</code> where the binary is. We can implement our own <code>ExecAllocator</code>:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="go" data-theme="light"><code data-language="go" data-theme="light"><span class="line"><span style="color: #24292E">allocatorCtx, _ </span><span style="color: #D73A49">:=</span><span style="color: #24292E"> chromedp.</span><span style="color: #005CC5">NewExecAllocator</span><span style="color: #24292E">(</span></span>
<span class="line"><span style="color: #24292E">	ctx,</span></span>
<span class="line"><span style="color: #24292E">	</span><span style="color: #005CC5">append</span><span style="color: #24292E">([]</span><span style="color: #D73A49">func</span><span style="color: #24292E">(allocator </span><span style="color: #D73A49">*</span><span style="color: #24292E">chromedp.ExecAllocator){</span></span>
<span class="line"><span style="color: #24292E">		chromedp.</span><span style="color: #005CC5">ExecPath</span><span style="color: #24292E">(sc.ChromiumPath),</span></span>
<span class="line"><span style="color: #24292E">	}, chromedp.DefaultExecAllocatorOptions[:]</span><span style="color: #D73A49">...</span><span style="color: #24292E">)</span><span style="color: #D73A49">...</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">)</span></span></code></pre><pre data-language="go" data-theme="dark"><code data-language="go" data-theme="dark"><span class="line"><span style="color: #E1E4E8">allocatorCtx, _ </span><span style="color: #F97583">:=</span><span style="color: #E1E4E8"> chromedp.</span><span style="color: #79B8FF">NewExecAllocator</span><span style="color: #E1E4E8">(</span></span>
<span class="line"><span style="color: #E1E4E8">	ctx,</span></span>
<span class="line"><span style="color: #E1E4E8">	</span><span style="color: #79B8FF">append</span><span style="color: #E1E4E8">([]</span><span style="color: #F97583">func</span><span style="color: #E1E4E8">(allocator </span><span style="color: #F97583">*</span><span style="color: #E1E4E8">chromedp.ExecAllocator){</span></span>
<span class="line"><span style="color: #E1E4E8">		chromedp.</span><span style="color: #79B8FF">ExecPath</span><span style="color: #E1E4E8">(sc.ChromiumPath),</span></span>
<span class="line"><span style="color: #E1E4E8">	}, chromedp.DefaultExecAllocatorOptions[:]</span><span style="color: #F97583">...</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">...</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">)</span></span></code></pre></div>
<p>It devours a context and returns another one, which we must later provide to <code>chromedp.Run(...)</code>, so that the prebuilt Chromium binary is really used.</p>
<h2 id="bonus-a-brief-note-about-azure-tables"><a href="#bonus-a-brief-note-about-azure-tables"><strong>BONUS</strong>: A brief note about Azure Tables</a></h2>
<p>I needed a cheap lightweight storage to back my scraper and decided to go with <em>Azure Tables</em> as I had the Storage Account there anyway due to Azure Functions. I invested some time in testing different Go libraries for Azure Tables and there seems to be at least three options, some official, some unoffical, some no longer maintained. But as for right now, the way to go seems to be <a href="https://github.com/Azure/azure-sdk-for-go/tree/main/sdk/data/aztables">azure-sdk-for-go aztables</a>.</p>b:["$","div",null,{"className":"flex justify-center","children":["$","div",null,{"className":"md:px-10 min-w-0 max-w-7xl mb-12","children":["$","article",null,{"children":[["$","header",null,{"className":"px-5 mb-4 py-10 relative","children":[["$","h1",null,{"className":"text-3xl leading-none tracking-tight text-gray-900 md:text-4xl lg:text-5xl dark:text-gray-100","children":"Deep dive to Azure Functions with Go"}],["$","time",null,{"dateTime":"2023-11-03 00:00","className":"pl-1 font-serif text-slate-400 bottom-0 absolute","children":[["$","svg",null,{"className":"h-4 w-4 inline-block","width":"24","height":"24","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 24 24","fill":"none","stroke":"currentColor","strokeWidth":"2","strokeLinecap":"round","strokeLinejoin":"round","children":[["$","path",null,{"d":"M12 19l7-7 3 3-7 7-3-3z"}]," ",["$","path",null,{"d":"M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"}]," ",["$","path",null,{"d":"M2 2l7.586 7.586"}]," ",["$","circle",null,{"cx":"11","cy":"11","r":"2"}]]}]," ","2023-11-03 00:00"]}]]}],["$","div",null,{"className":"bg-slate-100 dark:bg-slate-800 p-5 pb-12 rounded shadow-lg","children":[[["$","p",null,{"className":"italic text-slate-400 p-4","dangerouslySetInnerHTML":{"__html":"The code discussed in this blog post is available on <a href=\"https://github.com/iotalambda/beenotif\">GitHub</a>."}}],["$","hr",null,{"className":"h-px my-4 bg-gray-200 border-0 dark:bg-gray-700"}]],["$","div",null,{"className":"space-y-4","dangerouslySetInnerHTML":{"__html":"$c"}}]]}]]}]}]}]
a:null
