<!DOCTYPE html><html lang="en" class="__variable_965427 __variable_9c011f"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" as="font" href="/_next/static/media/3d9ea938b6afa941-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="preload" as="font" href="/_next/static/media/7eaa4a2482b4df1a-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/_next/static/css/488301a2e2aae266.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/301e7291452e98cd.css" data-precedence="next"/><link rel="preload" href="/_next/static/chunks/webpack-b2aba447c1dc2205.js" as="script" fetchPriority="low"/><script src="/_next/static/chunks/fd9d1056-a99b58d3cc150217.js" async=""></script><script src="/_next/static/chunks/596-9d43875837bd0b65.js" async=""></script><script src="/_next/static/chunks/main-app-40cca1cf35ae5286.js" async=""></script><title>EF Core authentication with DefaultAzureCredential | Food for AI blog</title><meta name="description" content="Blog about .NET, Azure, React and whatever comes to mind."/><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="16x16"/><meta name="next-size-adjust"/><script src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js" noModule=""></script></head><body class="bg-slate-200 dark:bg-slate-700"><nav class="w-full flex flex-row justify-between bg-indigo-600 shadow-indigo-300 dark:shadow-indigo-800 shadow-2xl font-sans"><div class="p-2"><a class="text-2xl font-semibold text-neutral-100 dark:text-neutral-200" href="/"><h1 class="inline">üçî food for ai</h1> <span class="font-mono font-light text-xs">food.joona.cloud</span></a></div></nav><main class="mt-4"><div class="flex justify-center"><div class="md:px-10 min-w-0 max-w-7xl mb-12"><article><header class="px-5 mb-4 py-10 relative"><h1 class="text-3xl leading-none tracking-tight text-gray-900 md:text-4xl lg:text-5xl dark:text-gray-100">EF Core authentication with DefaultAzureCredential</h1><time dateTime="2023-09-21 21:00" class="pl-1 font-serif text-slate-400 bottom-0 absolute"><svg class="h-4 w-4 inline-block" width="24" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"></path> <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path> <path d="M2 2l7.586 7.586"></path> <circle cx="11" cy="11" r="2"></circle></svg> <!-- -->2023-09-21 21:00</time></header><div class="bg-slate-100 dark:bg-slate-800 p-5 pb-12 rounded shadow-lg"><p class="italic text-slate-400 p-4">This article was written based on Microsoft.EntityFrameworkCore 7.0.10.0 and Visual Studio 2022 17.6.6.</p><hr class="h-px my-4 bg-gray-200 border-0 dark:bg-gray-700"/><div class="space-y-4"><p>If you use Azure and don't wish to bake any secrets into your appsettings file, you should use <code>DefaultAzureCredential</code>. You can simply new up an <code>DefaultAzureCredential</code> instance and start requesting access tokens. The nicest part is that it is context aware:</p>
<ul>
<li><strong>In Visual Studio</strong>, when developing things locally, your Visual Studio account is used</li>
<li><strong>In Azure</strong>, the local identity, such as Managed Identity is used.</li>
</ul>
<p>This means that you can fully leverage Azure AD in accessing your cloud resources and take a big leap towards <a href="https://en.wikipedia.org/wiki/Zero_trust_security_model">a zero-trust architecture</a>.</p>
<p>At the moment, EF Core does not provide a straight-forward way to use <code>DefaultAzureCredential</code> for authentication, which is a problem. There are some workarounds, such as <a href="https://stackoverflow.com/q/54187241">hacking the <code>DbContext</code></a> which is not nice, and <a href="https://stackoverflow.com/a/63820411">adding interceptors</a> which I haven't had much luck with. <a href="https://learn.microsoft.com/en-us/azure/azure-sql/database/azure-sql-dotnet-entity-framework-core-quickstart?view=azuresql&#x26;tabs=visual-studio%2Cservice-connector%2Cportal#add-the-code-to-connect-to-azure-sql-database">The official Microsoft recommendation</a> is to simply use <code>Authentication=Active Directory Default</code> in the connection string, but this can also be tricky if your account belongs to different tenants: there is no way to select the Azure tenant, so Visual Studio will probably just pick "the first one in the list".</p>
<h2 id="custom-sql-authentication-provider"><a href="#custom-sql-authentication-provider">Custom SQL authentication provider</a></h2>
<p>In .NET, there is a way to <em>overwrite <code>SqlAuthenticationProviders</code></em>. You can create your own provider that uses <code>DefaultAzureCredentials</code> internally and makes sure that the desired tenant is selected:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="csharp" data-theme="light"><code data-language="csharp" data-theme="light"><span class="line"><span style="color: #D73A49">public</span><span style="color: #24292E"> </span><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">CustomActiveDirectoryDefaultAuthenticationProvider</span><span style="color: #24292E"> : </span><span style="color: #6F42C1">SqlAuthenticationProvider</span></span>
<span class="line"><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">private</span><span style="color: #24292E"> </span><span style="color: #D73A49">readonly</span><span style="color: #24292E"> </span><span style="color: #D73A49">string</span><span style="color: #24292E"> </span><span style="color: #6F42C1">tenantId</span><span style="color: #24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">public</span><span style="color: #24292E"> </span><span style="color: #6F42C1">CustomActiveDirectoryDefaultAuthenticationProvider</span><span style="color: #24292E">(</span><span style="color: #D73A49">string</span><span style="color: #24292E"> </span><span style="color: #6F42C1">tenantId</span><span style="color: #24292E">)</span></span>
<span class="line"><span style="color: #24292E">    {</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">this</span><span style="color: #24292E">.tenantId </span><span style="color: #D73A49">=</span><span style="color: #24292E"> tenantId;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">public</span><span style="color: #24292E"> </span><span style="color: #D73A49">override</span><span style="color: #24292E"> </span><span style="color: #D73A49">async</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Task</span><span style="color: #24292E">&#x3C;</span><span style="color: #6F42C1">SqlAuthenticationToken</span><span style="color: #24292E">> </span><span style="color: #6F42C1">AcquireTokenAsync</span><span style="color: #24292E">(</span><span style="color: #6F42C1">SqlAuthenticationParameters</span><span style="color: #24292E"> </span><span style="color: #6F42C1">parameters</span><span style="color: #24292E">)</span></span>
<span class="line"><span style="color: #24292E">    {</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">var</span><span style="color: #24292E"> </span><span style="color: #6F42C1">context</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #6F42C1">TokenRequestContext</span><span style="color: #24292E">(</span><span style="color: #D73A49">new</span><span style="color: #24292E">[] { </span><span style="color: #032F62">"https://database.windows.net//.default"</span><span style="color: #24292E"> });</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">var</span><span style="color: #24292E"> </span><span style="color: #6F42C1">options</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #6F42C1">DefaultAzureCredentialOptions</span></span>
<span class="line"><span style="color: #24292E">        {</span></span>
<span class="line"><span style="color: #24292E">            VisualStudioTenantId </span><span style="color: #D73A49">=</span><span style="color: #24292E"> tenantId,</span></span>
<span class="line"><span style="color: #24292E">            ExcludeInteractiveBrowserCredential </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">true</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">            ExcludeAzureCliCredential </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">true</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">            ExcludeAzurePowerShellCredential </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">true</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">            ExcludeEnvironmentCredential </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">true</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">            ExcludeManagedIdentityCredential </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">false</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">            ExcludeSharedTokenCacheCredential </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">true</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">            ExcludeVisualStudioCodeCredential </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">true</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">            ExcludeVisualStudioCredential </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">false</span></span>
<span class="line"><span style="color: #24292E">        };</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">var</span><span style="color: #24292E"> </span><span style="color: #6F42C1">token</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">await</span><span style="color: #24292E"> </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #6F42C1">DefaultAzureCredential</span><span style="color: #24292E">(options).</span><span style="color: #6F42C1">GetTokenAsync</span><span style="color: #24292E">(context);</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #6F42C1">SqlAuthenticationToken</span><span style="color: #24292E">(token.Token, token.ExpiresOn);</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">public</span><span style="color: #24292E"> </span><span style="color: #D73A49">override</span><span style="color: #24292E"> </span><span style="color: #D73A49">bool</span><span style="color: #24292E"> </span><span style="color: #6F42C1">IsSupported</span><span style="color: #24292E">(</span><span style="color: #6F42C1">SqlAuthenticationMethod</span><span style="color: #24292E"> </span><span style="color: #6F42C1">authenticationMethod</span><span style="color: #24292E">)</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">=></span><span style="color: #24292E"> authenticationMethod.</span><span style="color: #6F42C1">Equals</span><span style="color: #24292E">(SqlAuthenticationMethod.ActiveDirectoryDefault);</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre><pre data-language="csharp" data-theme="dark"><code data-language="csharp" data-theme="dark"><span class="line"><span style="color: #F97583">public</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">class</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">CustomActiveDirectoryDefaultAuthenticationProvider</span><span style="color: #E1E4E8"> : </span><span style="color: #B392F0">SqlAuthenticationProvider</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">private</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">readonly</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">string</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">tenantId</span><span style="color: #E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">public</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">CustomActiveDirectoryDefaultAuthenticationProvider</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">string</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">tenantId</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">    {</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">this</span><span style="color: #E1E4E8">.tenantId </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> tenantId;</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">public</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">override</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">async</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Task</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #B392F0">SqlAuthenticationToken</span><span style="color: #E1E4E8">> </span><span style="color: #B392F0">AcquireTokenAsync</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">SqlAuthenticationParameters</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">parameters</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">    {</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">var</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">context</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">TokenRequestContext</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">new</span><span style="color: #E1E4E8">[] { </span><span style="color: #9ECBFF">"https://database.windows.net//.default"</span><span style="color: #E1E4E8"> });</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">var</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">options</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">DefaultAzureCredentialOptions</span></span>
<span class="line"><span style="color: #E1E4E8">        {</span></span>
<span class="line"><span style="color: #E1E4E8">            VisualStudioTenantId </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> tenantId,</span></span>
<span class="line"><span style="color: #E1E4E8">            ExcludeInteractiveBrowserCredential </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">true</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">            ExcludeAzureCliCredential </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">true</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">            ExcludeAzurePowerShellCredential </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">true</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">            ExcludeEnvironmentCredential </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">true</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">            ExcludeManagedIdentityCredential </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">false</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">            ExcludeSharedTokenCacheCredential </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">true</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">            ExcludeVisualStudioCodeCredential </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">true</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">            ExcludeVisualStudioCredential </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">false</span></span>
<span class="line"><span style="color: #E1E4E8">        };</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">var</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">token</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">DefaultAzureCredential</span><span style="color: #E1E4E8">(options).</span><span style="color: #B392F0">GetTokenAsync</span><span style="color: #E1E4E8">(context);</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">SqlAuthenticationToken</span><span style="color: #E1E4E8">(token.Token, token.ExpiresOn);</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">public</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">override</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">bool</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">IsSupported</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">SqlAuthenticationMethod</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">authenticationMethod</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> authenticationMethod.</span><span style="color: #B392F0">Equals</span><span style="color: #E1E4E8">(SqlAuthenticationMethod.ActiveDirectoryDefault);</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre></div>
<p>The key point is that now we can provide a value for <code>VisualStudioTenantId</code>.</p>
<p>Please notice that all other methods except for Visual Studio Credential based authentication are excluded. This is because <code>DefaultAzureCredential</code> iterates over and attempts each authentication method. If one fails it will try the next one (unless excluded), which can take a moment and slow down your inner loop. By excluding all unnecessary methods, this problem is avoided.</p>
<p>You can register this provider in your application's DI:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="csharp" data-theme="light"><code data-language="csharp" data-theme="light"><span class="line"><span style="color: #24292E">SqlAuthenticationProvider.</span><span style="color: #6F42C1">SetProvider</span><span style="color: #24292E">(</span></span>
<span class="line"><span style="color: #24292E">    SqlAuthenticationMethod.ActiveDirectoryDefault,</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #6F42C1">CustomActiveDirectoryDefaultAuthenticationProvider</span><span style="color: #24292E">(myAzureTenantId));</span></span></code></pre><pre data-language="csharp" data-theme="dark"><code data-language="csharp" data-theme="dark"><span class="line"><span style="color: #E1E4E8">SqlAuthenticationProvider.</span><span style="color: #B392F0">SetProvider</span><span style="color: #E1E4E8">(</span></span>
<span class="line"><span style="color: #E1E4E8">    SqlAuthenticationMethod.ActiveDirectoryDefault,</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">CustomActiveDirectoryDefaultAuthenticationProvider</span><span style="color: #E1E4E8">(myAzureTenantId));</span></span></code></pre></div>
<p>And now the default <code>ActiveDirectoryDefault</code> authentication method is <strong>overwritten</strong> with your custom one! You can also register your <code>DbContext</code> with SQL Server (or Azure SQL) provider as usual:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="csharp" data-theme="light"><code data-language="csharp" data-theme="light"><span class="line"><span style="color: #24292E">services.</span><span style="color: #6F42C1">AddDbContext</span><span style="color: #24292E">&#x3C;</span><span style="color: #6F42C1">MyDbContext</span><span style="color: #24292E">>(</span><span style="color: #6F42C1">o</span><span style="color: #24292E"> </span><span style="color: #D73A49">=></span></span>
<span class="line"><span style="color: #24292E">    o.</span><span style="color: #6F42C1">UseSqlServer</span><span style="color: #24292E">(</span><span style="color: #032F62">"server=tcp:my-azure-sql.database.windows.net,1433;database=myDb;Authentication=Active Directory Default;Connection Timeout=60"</span><span style="color: #24292E">));</span></span></code></pre><pre data-language="csharp" data-theme="dark"><code data-language="csharp" data-theme="dark"><span class="line"><span style="color: #E1E4E8">services.</span><span style="color: #B392F0">AddDbContext</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #B392F0">MyDbContext</span><span style="color: #E1E4E8">>(</span><span style="color: #B392F0">o</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=></span></span>
<span class="line"><span style="color: #E1E4E8">    o.</span><span style="color: #B392F0">UseSqlServer</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"server=tcp:my-azure-sql.database.windows.net,1433;database=myDb;Authentication=Active Directory Default;Connection Timeout=60"</span><span style="color: #E1E4E8">));</span></span></code></pre></div>
<p>And, as long as you have <em>configured Azure Service Authentication in Visual Studio</em>, you now have access to the database using your Visual Studio credentials in Visual Studio and a Managed Identity in Azure.</p>
<p>I'd also recommend to set a <code>Connection Timeout</code> that is big enough to withstand the time that it takes to fetch a token when you don't have a fresh one in your cache. Usually it's fast, but at times it can take a while.</p>
<h2 id="bonus-setting-up-and-troubleshooting-azure-service-authentication-in-visual-studio"><a href="#bonus-setting-up-and-troubleshooting-azure-service-authentication-in-visual-studio"><strong>BONUS</strong>: Setting up and troubleshooting Azure Service Authentication in Visual Studio</a></h2>
<p>Set up the authentication by hitting <code>CTRL</code>+<code>Q</code> and searching "Azure Service Authentication". Select your account from the dropdown. Sometimes the dropdown doesn't work and it can also crash Visual Studio, so it may or may not take couple of attempts.</p>
<p>If your token has expired, you need to open up the "Azure Service Authentication" window again and re-enter your credentials. Sometimes you also need to restart Visual Studio after this.</p>
<p>If you seem to be able to enter your credentials, but you have an authentication problem that persists, it could be due to your cached token being invalid one way or another. For example, the token was received without MFA but your desired tenant requires MFA. One way to <em>really</em> refresh the token on-demand is to use <em>System web browser</em> and remove token from the login page's local storage. Hit <code>CTRL</code>+<code>Q</code> and search for "sign-in" and choose "System web browser" from the dropdown. If you now try to go re-enter your credentials, the login screen is opened in your default browser.</p></div></div></article></div></div></main><script src="/_next/static/chunks/webpack-b2aba447c1dc2205.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/media/3d9ea938b6afa941-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n2:HL[\"/_next/static/media/7eaa4a2482b4df1a-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n3:HL[\"/_next/static/css/488301a2e2aae266.css\",{\"as\":\"style\"}]\n0:\"$L4\"\n"])</script><script>self.__next_f.push([1,"5:HL[\"/_next/static/css/301e7291452e98cd.css\",{\"as\":\"style\"}]\n"])</script><script>self.__next_f.push([1,"6:I{\"id\":7948,\"chunks\":[\"272:static/chunks/webpack-b2aba447c1dc2205.js\",\"971:static/chunks/fd9d1056-a99b58d3cc150217.js\",\"596:static/chunks/596-9d43875837bd0b65.js\"],\"name\":\"default\",\"async\":false}\n8:I{\"id\":6628,\"chunks\":[\"272:static/chunks/webpack-b2aba447c1dc2205.js\",\"971:static/chunks/fd9d1056-a99b58d3cc150217.js\",\"596:static/chunks/596-9d43875837bd0b65.js\"],\"name\":\"\",\"async\":false}\n9:I{\"id\":6685,\"chunks\":[\"685:static/chunks/685-a8c11ad368fada34.js\",\"185:static/chunks/app/layout-0afbb0e01943be7f.js\"],\"na"])</script><script>self.__next_f.push([1,"me\":\"\",\"async\":false}\na:I{\"id\":7767,\"chunks\":[\"272:static/chunks/webpack-b2aba447c1dc2205.js\",\"971:static/chunks/fd9d1056-a99b58d3cc150217.js\",\"596:static/chunks/596-9d43875837bd0b65.js\"],\"name\":\"default\",\"async\":false}\nb:I{\"id\":7920,\"chunks\":[\"272:static/chunks/webpack-b2aba447c1dc2205.js\",\"971:static/chunks/fd9d1056-a99b58d3cc150217.js\",\"596:static/chunks/596-9d43875837bd0b65.js\"],\"name\":\"default\",\"async\":false}\n"])</script><script>self.__next_f.push([1,"4:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/488301a2e2aae266.css\",\"precedence\":\"next\"}]],[\"$\",\"$L6\",null,{\"buildId\":\"PsZqLCFMFDR2tkN75POzO\",\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/2023/09/21/EF-Core-authentication-with-DefaultAzureCredential\",\"initialTree\":[\"\",{\"children\":[[\"id\",\"2023/09/21/EF-Core-authentication-with-DefaultAzureCredential\",\"c\"],{\"children\":[\"__PAGE__?{\\\"id\\\":[\\\"2023\\\",\\\"09\\\",\\\"21\\\",\\\"EF-Core-authentication-with-DefaultAzureCredential\\\"]}\",{}]}]},\"$undefined\",\"$undefined\",true],\"initialHead\":[false,\"$L7\"],\"globalErrorComponent\":\"$8\",\"children\":[null,[\"$\",\"html\",null,{\"lang\":\"en\",\"className\":\"__variable_965427 __variable_9c011f\",\"children\":[\"$\",\"body\",null,{\"className\":\"bg-slate-200 dark:bg-slate-700\",\"children\":[[\"$\",\"nav\",null,{\"className\":\"w-full flex flex-row justify-between bg-indigo-600 shadow-indigo-300 dark:shadow-indigo-800 shadow-2xl font-sans\",\"children\":[\"$\",\"div\",null,{\"className\":\"p-2\",\"children\":[\"$\",\"$L9\",null,{\"className\":\"text-2xl font-semibold text-neutral-100 dark:text-neutral-200\",\"href\":\"/\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"inline\",\"children\":\"üçî food for ai\"}],\" \",[\"$\",\"span\",null,{\"className\":\"font-mono font-light text-xs\",\"children\":\"food.joona.cloud\"}]]}]}]}],[\"$\",\"main\",null,{\"className\":\"mt-4\",\"children\":[\"$\",\"$La\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[],\"childProp\":{\"current\":[\"$\",\"$La\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",[\"id\",\"2023/09/21/EF-Core-authentication-with-DefaultAzureCredential\",\"c\"],\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$Lc\",\"$Ld\",null],\"segment\":\"__PAGE__?{\\\"id\\\":[\\\"2023\\\",\\\"09\\\",\\\"21\\\",\\\"EF-Core-authentication-with-DefaultAzureCredential\\\"]}\"},\"styles\":[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/301e7291452e98cd.css\",\"precedence\":\"next\"}]]}],\"segment\":[\"id\",\"2023/09/21/EF-Core-authentication-with-DefaultAzureCredential\",\"c\"]},\"styles\":[]}]}]]}]}],null]}]]\n"])</script><script>self.__next_f.push([1,"e:T5df2,"])</script><script>self.__next_f.push([1,"\u003cp\u003eIf you use Azure and don't wish to bake any secrets into your appsettings file, you should use \u003ccode\u003eDefaultAzureCredential\u003c/code\u003e. You can simply new up an \u003ccode\u003eDefaultAzureCredential\u003c/code\u003e instance and start requesting access tokens. The nicest part is that it is context aware:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eIn Visual Studio\u003c/strong\u003e, when developing things locally, your Visual Studio account is used\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eIn Azure\u003c/strong\u003e, the local identity, such as Managed Identity is used.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThis means that you can fully leverage Azure AD in accessing your cloud resources and take a big leap towards \u003ca href=\"https://en.wikipedia.org/wiki/Zero_trust_security_model\"\u003ea zero-trust architecture\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eAt the moment, EF Core does not provide a straight-forward way to use \u003ccode\u003eDefaultAzureCredential\u003c/code\u003e for authentication, which is a problem. There are some workarounds, such as \u003ca href=\"https://stackoverflow.com/q/54187241\"\u003ehacking the \u003ccode\u003eDbContext\u003c/code\u003e\u003c/a\u003e which is not nice, and \u003ca href=\"https://stackoverflow.com/a/63820411\"\u003eadding interceptors\u003c/a\u003e which I haven't had much luck with. \u003ca href=\"https://learn.microsoft.com/en-us/azure/azure-sql/database/azure-sql-dotnet-entity-framework-core-quickstart?view=azuresql\u0026#x26;tabs=visual-studio%2Cservice-connector%2Cportal#add-the-code-to-connect-to-azure-sql-database\"\u003eThe official Microsoft recommendation\u003c/a\u003e is to simply use \u003ccode\u003eAuthentication=Active Directory Default\u003c/code\u003e in the connection string, but this can also be tricky if your account belongs to different tenants: there is no way to select the Azure tenant, so Visual Studio will probably just pick \"the first one in the list\".\u003c/p\u003e\n\u003ch2 id=\"custom-sql-authentication-provider\"\u003e\u003ca href=\"#custom-sql-authentication-provider\"\u003eCustom SQL authentication provider\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eIn .NET, there is a way to \u003cem\u003eoverwrite \u003ccode\u003eSqlAuthenticationProviders\u003c/code\u003e\u003c/em\u003e. You can create your own provider that uses \u003ccode\u003eDefaultAzureCredentials\u003c/code\u003e internally and makes sure that the desired tenant is selected:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre data-language=\"csharp\" data-theme=\"light\"\u003e\u003ccode data-language=\"csharp\" data-theme=\"light\"\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D73A49\"\u003epublic\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003eclass\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eCustomActiveDirectoryDefaultAuthenticationProvider\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e : \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eSqlAuthenticationProvider\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003eprivate\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003ereadonly\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003estring\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003etenantId\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003epublic\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eCustomActiveDirectoryDefaultAuthenticationProvider\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003estring\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003etenantId\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e    {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003ethis\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e.tenantId \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e tenantId;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003epublic\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003eoverride\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003easync\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eTask\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eSqlAuthenticationToken\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eAcquireTokenAsync\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eSqlAuthenticationParameters\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eparameters\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e    {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003evar\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003econtext\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003enew\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eTokenRequestContext\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003enew\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e[] { \u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e\"https://database.windows.net//.default\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e });\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003evar\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eoptions\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003enew\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eDefaultAzureCredentialOptions\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e        {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e            VisualStudioTenantId \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e tenantId,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e            ExcludeInteractiveBrowserCredential \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003etrue\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e            ExcludeAzureCliCredential \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003etrue\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e            ExcludeAzurePowerShellCredential \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003etrue\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e            ExcludeEnvironmentCredential \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003etrue\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e            ExcludeManagedIdentityCredential \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003efalse\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e            ExcludeSharedTokenCacheCredential \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003etrue\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e            ExcludeVisualStudioCodeCredential \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003etrue\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e            ExcludeVisualStudioCredential \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003efalse\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e        };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003evar\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003etoken\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003eawait\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003enew\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eDefaultAzureCredential\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(options).\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eGetTokenAsync\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(context);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003ereturn\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003enew\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eSqlAuthenticationToken\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(token.Token, token.ExpiresOn);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003epublic\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003eoverride\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003ebool\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eIsSupported\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eSqlAuthenticationMethod\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eauthenticationMethod\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e=\u003e\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e authenticationMethod.\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eEquals\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(SqlAuthenticationMethod.ActiveDirectoryDefault);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cpre data-language=\"csharp\" data-theme=\"dark\"\u003e\u003ccode data-language=\"csharp\" data-theme=\"dark\"\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #F97583\"\u003epublic\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003eclass\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eCustomActiveDirectoryDefaultAuthenticationProvider\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e : \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eSqlAuthenticationProvider\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003eprivate\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003ereadonly\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003estring\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003etenantId\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003epublic\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eCustomActiveDirectoryDefaultAuthenticationProvider\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003estring\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003etenantId\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e    {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003ethis\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e.tenantId \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e tenantId;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003epublic\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003eoverride\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003easync\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eTask\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eSqlAuthenticationToken\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eAcquireTokenAsync\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eSqlAuthenticationParameters\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eparameters\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e    {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003evar\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003econtext\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003enew\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eTokenRequestContext\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003enew\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e[] { \u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e\"https://database.windows.net//.default\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e });\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003evar\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eoptions\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003enew\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eDefaultAzureCredentialOptions\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e        {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e            VisualStudioTenantId \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e tenantId,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e            ExcludeInteractiveBrowserCredential \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003etrue\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e            ExcludeAzureCliCredential \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003etrue\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e            ExcludeAzurePowerShellCredential \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003etrue\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e            ExcludeEnvironmentCredential \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003etrue\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e            ExcludeManagedIdentityCredential \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003efalse\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e            ExcludeSharedTokenCacheCredential \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003etrue\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e            ExcludeVisualStudioCodeCredential \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003etrue\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e            ExcludeVisualStudioCredential \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003efalse\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e        };\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003evar\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003etoken\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003eawait\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003enew\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eDefaultAzureCredential\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(options).\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eGetTokenAsync\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(context);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003ereturn\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003enew\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eSqlAuthenticationToken\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(token.Token, token.ExpiresOn);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003epublic\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003eoverride\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003ebool\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eIsSupported\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eSqlAuthenticationMethod\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eauthenticationMethod\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e        \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e=\u003e\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e authenticationMethod.\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eEquals\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(SqlAuthenticationMethod.ActiveDirectoryDefault);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe key point is that now we can provide a value for \u003ccode\u003eVisualStudioTenantId\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003ePlease notice that all other methods except for Visual Studio Credential based authentication are excluded. This is because \u003ccode\u003eDefaultAzureCredential\u003c/code\u003e iterates over and attempts each authentication method. If one fails it will try the next one (unless excluded), which can take a moment and slow down your inner loop. By excluding all unnecessary methods, this problem is avoided.\u003c/p\u003e\n\u003cp\u003eYou can register this provider in your application's DI:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre data-language=\"csharp\" data-theme=\"light\"\u003e\u003ccode data-language=\"csharp\" data-theme=\"light\"\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003eSqlAuthenticationProvider.\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eSetProvider\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e    SqlAuthenticationMethod.ActiveDirectoryDefault,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003enew\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eCustomActiveDirectoryDefaultAuthenticationProvider\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(myAzureTenantId));\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cpre data-language=\"csharp\" data-theme=\"dark\"\u003e\u003ccode data-language=\"csharp\" data-theme=\"dark\"\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003eSqlAuthenticationProvider.\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eSetProvider\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e    SqlAuthenticationMethod.ActiveDirectoryDefault,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003enew\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eCustomActiveDirectoryDefaultAuthenticationProvider\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(myAzureTenantId));\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAnd now the default \u003ccode\u003eActiveDirectoryDefault\u003c/code\u003e authentication method is \u003cstrong\u003eoverwritten\u003c/strong\u003e with your custom one! You can also register your \u003ccode\u003eDbContext\u003c/code\u003e with SQL Server (or Azure SQL) provider as usual:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre data-language=\"csharp\" data-theme=\"light\"\u003e\u003ccode data-language=\"csharp\" data-theme=\"light\"\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003eservices.\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eAddDbContext\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eMyDbContext\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e\u003e(\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eo\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e=\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e    o.\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eUseSqlServer\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e\"server=tcp:my-azure-sql.database.windows.net,1433;database=myDb;Authentication=Active Directory Default;Connection Timeout=60\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cpre data-language=\"csharp\" data-theme=\"dark\"\u003e\u003ccode data-language=\"csharp\" data-theme=\"dark\"\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003eservices.\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eAddDbContext\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eMyDbContext\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e\u003e(\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eo\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e=\u003e\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e    o.\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eUseSqlServer\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e\"server=tcp:my-azure-sql.database.windows.net,1433;database=myDb;Authentication=Active Directory Default;Connection Timeout=60\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e));\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAnd, as long as you have \u003cem\u003econfigured Azure Service Authentication in Visual Studio\u003c/em\u003e, you now have access to the database using your Visual Studio credentials in Visual Studio and a Managed Identity in Azure.\u003c/p\u003e\n\u003cp\u003eI'd also recommend to set a \u003ccode\u003eConnection Timeout\u003c/code\u003e that is big enough to withstand the time that it takes to fetch a token when you don't have a fresh one in your cache. Usually it's fast, but at times it can take a while.\u003c/p\u003e\n\u003ch2 id=\"bonus-setting-up-and-troubleshooting-azure-service-authentication-in-visual-studio\"\u003e\u003ca href=\"#bonus-setting-up-and-troubleshooting-azure-service-authentication-in-visual-studio\"\u003e\u003cstrong\u003eBONUS\u003c/strong\u003e: Setting up and troubleshooting Azure Service Authentication in Visual Studio\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eSet up the authentication by hitting \u003ccode\u003eCTRL\u003c/code\u003e+\u003ccode\u003eQ\u003c/code\u003e and searching \"Azure Service Authentication\". Select your account from the dropdown. Sometimes the dropdown doesn't work and it can also crash Visual Studio, so it may or may not take couple of attempts.\u003c/p\u003e\n\u003cp\u003eIf your token has expired, you need to open up the \"Azure Service Authentication\" window again and re-enter your credentials. Sometimes you also need to restart Visual Studio after this.\u003c/p\u003e\n\u003cp\u003eIf you seem to be able to enter your credentials, but you have an authentication problem that persists, it could be due to your cached token being invalid one way or another. For example, the token was received without MFA but your desired tenant requires MFA. One way to \u003cem\u003ereally\u003c/em\u003e refresh the token on-demand is to use \u003cem\u003eSystem web browser\u003c/em\u003e and remove token from the login page's local storage. Hit \u003ccode\u003eCTRL\u003c/code\u003e+\u003ccode\u003eQ\u003c/code\u003e and search for \"sign-in\" and choose \"System web browser\" from the dropdown. If you now try to go re-enter your credentials, the login screen is opened in your default browser.\u003c/p\u003e"])</script><script>self.__next_f.push([1,"d:[\"$\",\"div\",null,{\"className\":\"flex justify-center\",\"children\":[\"$\",\"div\",null,{\"className\":\"md:px-10 min-w-0 max-w-7xl mb-12\",\"children\":[\"$\",\"article\",null,{\"children\":[[\"$\",\"header\",null,{\"className\":\"px-5 mb-4 py-10 relative\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"text-3xl leading-none tracking-tight text-gray-900 md:text-4xl lg:text-5xl dark:text-gray-100\",\"children\":\"EF Core authentication with DefaultAzureCredential\"}],[\"$\",\"time\",null,{\"dateTime\":\"2023-09-21 21:00\",\"className\":\"pl-1 font-serif text-slate-400 bottom-0 absolute\",\"children\":[[\"$\",\"svg\",null,{\"className\":\"h-4 w-4 inline-block\",\"width\":\"24\",\"height\":\"24\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"viewBox\":\"0 0 24 24\",\"fill\":\"none\",\"stroke\":\"currentColor\",\"strokeWidth\":\"2\",\"strokeLinecap\":\"round\",\"strokeLinejoin\":\"round\",\"children\":[[\"$\",\"path\",null,{\"d\":\"M12 19l7-7 3 3-7 7-3-3z\"}],\" \",[\"$\",\"path\",null,{\"d\":\"M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z\"}],\" \",[\"$\",\"path\",null,{\"d\":\"M2 2l7.586 7.586\"}],\" \",[\"$\",\"circle\",null,{\"cx\":\"11\",\"cy\":\"11\",\"r\":\"2\"}]]}],\" \",\"2023-09-21 21:00\"]}]]}],[\"$\",\"div\",null,{\"className\":\"bg-slate-100 dark:bg-slate-800 p-5 pb-12 rounded shadow-lg\",\"children\":[[[\"$\",\"p\",null,{\"className\":\"italic text-slate-400 p-4\",\"dangerouslySetInnerHTML\":{\"__html\":\"This article was written based on Microsoft.EntityFrameworkCore 7.0.10.0 and Visual Studio 2022 17.6.6.\"}}],[\"$\",\"hr\",null,{\"className\":\"h-px my-4 bg-gray-200 border-0 dark:bg-gray-700\"}]],[\"$\",\"div\",null,{\"className\":\"space-y-4\",\"dangerouslySetInnerHTML\":{\"__html\":\"$e\"}}]]}]]}]}]}]\n"])</script><script>self.__next_f.push([1,"7:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"1\",{\"children\":\"EF Core authentication with DefaultAzureCredential | Food for AI blog\"}],[\"$\",\"meta\",\"2\",{\"name\":\"description\",\"content\":\"Blog about .NET, Azure, React and whatever comes to mind.\"}],[\"$\",\"meta\",\"3\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"link\",\"4\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"16x16\"}],[\"$\",\"meta\",\"5\",{\"name\":\"next-size-adjust\"}]]\nc:null\n"])</script></body></html>