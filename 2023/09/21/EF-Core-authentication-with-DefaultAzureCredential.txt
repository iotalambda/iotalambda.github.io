1:HL["/_next/static/media/3d9ea938b6afa941-s.p.woff2",{"as":"font","type":"font/woff2"}]
2:HL["/_next/static/media/7eaa4a2482b4df1a-s.p.woff2",{"as":"font","type":"font/woff2"}]
3:HL["/_next/static/css/488301a2e2aae266.css",{"as":"style"}]
0:["pOqyhynUi3dv4a-kveJeb",[[["",{"children":[["id","2023/09/21/EF-Core-authentication-with-DefaultAzureCredential","c"],{"children":["__PAGE__?{\"id\":[\"2023\",\"09\",\"21\",\"EF-Core-authentication-with-DefaultAzureCredential\"]}",{}]}]},"$undefined","$undefined",true],"$L4",[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/488301a2e2aae266.css","precedence":"next"}]],"$L5"]]]]
6:HL["/_next/static/css/301e7291452e98cd.css",{"as":"style"}]
7:I{"id":6685,"chunks":["685:static/chunks/685-a8c11ad368fada34.js","185:static/chunks/app/layout-0afbb0e01943be7f.js"],"name":"","async":false}
8:I{"id":7767,"chunks":["272:static/chunks/webpack-b2aba447c1dc2205.js","971:static/chunks/fd9d1056-a99b58d3cc150217.js","596:static/chunks/596-9d43875837bd0b65.js"],"name":"default","async":false}
9:I{"id":7920,"chunks":["272:static/chunks/webpack-b2aba447c1dc2205.js","971:static/chunks/fd9d1056-a99b58d3cc150217.js","596:static/chunks/596-9d43875837bd0b65.js"],"name":"default","async":false}
4:[null,["$","html",null,{"lang":"en","className":"__variable_965427 __variable_9c011f","children":["$","body",null,{"className":"bg-slate-200 dark:bg-slate-700","children":[["$","nav",null,{"className":"w-full flex flex-row justify-between bg-indigo-600 shadow-indigo-300 dark:shadow-indigo-800 shadow-2xl font-sans","children":["$","div",null,{"className":"p-2","children":["$","$L7",null,{"className":"text-2xl font-semibold text-neutral-100 dark:text-neutral-200","href":"/","children":[["$","h1",null,{"className":"inline","children":"üçî food for ai"}]," ",["$","span",null,{"className":"font-mono font-light text-xs","children":"food.joona.cloud"}]]}]}]}],["$","main",null,{"className":"mt-4","children":["$","$L8",null,{"parallelRouterKey":"children","segmentPath":["children"],"loading":"$undefined","loadingStyles":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","template":["$","$L9",null,{}],"templateStyles":"$undefined","notFound":[["$","title",null,{"children":"404: This page could not be found."}],["$","div",null,{"style":{"fontFamily":"system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"","height":"100vh","textAlign":"center","display":"flex","flexDirection":"column","alignItems":"center","justifyContent":"center"},"children":["$","div",null,{"children":[["$","style",null,{"dangerouslySetInnerHTML":{"__html":"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}"}}],["$","h1",null,{"className":"next-error-h1","style":{"display":"inline-block","margin":"0 20px 0 0","padding":"0 23px 0 0","fontSize":24,"fontWeight":500,"verticalAlign":"top","lineHeight":"49px"},"children":"404"}],["$","div",null,{"style":{"display":"inline-block"},"children":["$","h2",null,{"style":{"fontSize":14,"fontWeight":400,"lineHeight":"49px","margin":0},"children":"This page could not be found."}]}]]}]}]],"notFoundStyles":[],"childProp":{"current":["$","$L8",null,{"parallelRouterKey":"children","segmentPath":["children",["id","2023/09/21/EF-Core-authentication-with-DefaultAzureCredential","c"],"children"],"loading":"$undefined","loadingStyles":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","template":["$","$L9",null,{}],"templateStyles":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","childProp":{"current":["$La","$Lb",null],"segment":"__PAGE__?{\"id\":[\"2023\",\"09\",\"21\",\"EF-Core-authentication-with-DefaultAzureCredential\"]}"},"styles":[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/301e7291452e98cd.css","precedence":"next"}]]}],"segment":["id","2023/09/21/EF-Core-authentication-with-DefaultAzureCredential","c"]},"styles":[]}]}]]}]}],null]
5:[["$","meta","0",{"charSet":"utf-8"}],["$","title","1",{"children":"EF Core authentication with DefaultAzureCredential | Food for AI blog"}],["$","meta","2",{"name":"description","content":"Blog about .NET, Azure, React and whatever comes to mind."}],["$","meta","3",{"name":"viewport","content":"width=device-width, initial-scale=1"}],["$","link","4",{"rel":"icon","href":"/favicon.ico","type":"image/x-icon","sizes":"16x16"}],["$","meta","5",{"name":"next-size-adjust"}]]
c:T5df2,<p>If you use Azure and don't wish to bake any secrets into your appsettings file, you should use <code>DefaultAzureCredential</code>. You can simply new up an <code>DefaultAzureCredential</code> instance and start requesting access tokens. The nicest part is that it is context aware:</p>
<ul>
<li><strong>In Visual Studio</strong>, when developing things locally, your Visual Studio account is used</li>
<li><strong>In Azure</strong>, the local identity, such as Managed Identity is used.</li>
</ul>
<p>This means that you can fully leverage Azure AD in accessing your cloud resources and take a big leap towards <a href="https://en.wikipedia.org/wiki/Zero_trust_security_model">a zero-trust architecture</a>.</p>
<p>At the moment, EF Core does not provide a straight-forward way to use <code>DefaultAzureCredential</code> for authentication, which is a problem. There are some workarounds, such as <a href="https://stackoverflow.com/q/54187241">hacking the <code>DbContext</code></a> which is not nice, and <a href="https://stackoverflow.com/a/63820411">adding interceptors</a> which I haven't had much luck with. <a href="https://learn.microsoft.com/en-us/azure/azure-sql/database/azure-sql-dotnet-entity-framework-core-quickstart?view=azuresql&#x26;tabs=visual-studio%2Cservice-connector%2Cportal#add-the-code-to-connect-to-azure-sql-database">The official Microsoft recommendation</a> is to simply use <code>Authentication=Active Directory Default</code> in the connection string, but this can also be tricky if your account belongs to different tenants: there is no way to select the Azure tenant, so Visual Studio will probably just pick "the first one in the list".</p>
<h2 id="custom-sql-authentication-provider"><a href="#custom-sql-authentication-provider">Custom SQL authentication provider</a></h2>
<p>In .NET, there is a way to <em>overwrite <code>SqlAuthenticationProviders</code></em>. You can create your own provider that uses <code>DefaultAzureCredentials</code> internally and makes sure that the desired tenant is selected:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="csharp" data-theme="light"><code data-language="csharp" data-theme="light"><span class="line"><span style="color: #D73A49">public</span><span style="color: #24292E"> </span><span style="color: #D73A49">class</span><span style="color: #24292E"> </span><span style="color: #6F42C1">CustomActiveDirectoryDefaultAuthenticationProvider</span><span style="color: #24292E"> : </span><span style="color: #6F42C1">SqlAuthenticationProvider</span></span>
<span class="line"><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">private</span><span style="color: #24292E"> </span><span style="color: #D73A49">readonly</span><span style="color: #24292E"> </span><span style="color: #D73A49">string</span><span style="color: #24292E"> </span><span style="color: #6F42C1">tenantId</span><span style="color: #24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">public</span><span style="color: #24292E"> </span><span style="color: #6F42C1">CustomActiveDirectoryDefaultAuthenticationProvider</span><span style="color: #24292E">(</span><span style="color: #D73A49">string</span><span style="color: #24292E"> </span><span style="color: #6F42C1">tenantId</span><span style="color: #24292E">)</span></span>
<span class="line"><span style="color: #24292E">    {</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">this</span><span style="color: #24292E">.tenantId </span><span style="color: #D73A49">=</span><span style="color: #24292E"> tenantId;</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">public</span><span style="color: #24292E"> </span><span style="color: #D73A49">override</span><span style="color: #24292E"> </span><span style="color: #D73A49">async</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Task</span><span style="color: #24292E">&#x3C;</span><span style="color: #6F42C1">SqlAuthenticationToken</span><span style="color: #24292E">> </span><span style="color: #6F42C1">AcquireTokenAsync</span><span style="color: #24292E">(</span><span style="color: #6F42C1">SqlAuthenticationParameters</span><span style="color: #24292E"> </span><span style="color: #6F42C1">parameters</span><span style="color: #24292E">)</span></span>
<span class="line"><span style="color: #24292E">    {</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">var</span><span style="color: #24292E"> </span><span style="color: #6F42C1">context</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #6F42C1">TokenRequestContext</span><span style="color: #24292E">(</span><span style="color: #D73A49">new</span><span style="color: #24292E">[] { </span><span style="color: #032F62">"https://database.windows.net//.default"</span><span style="color: #24292E"> });</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">var</span><span style="color: #24292E"> </span><span style="color: #6F42C1">options</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #6F42C1">DefaultAzureCredentialOptions</span></span>
<span class="line"><span style="color: #24292E">        {</span></span>
<span class="line"><span style="color: #24292E">            VisualStudioTenantId </span><span style="color: #D73A49">=</span><span style="color: #24292E"> tenantId,</span></span>
<span class="line"><span style="color: #24292E">            ExcludeInteractiveBrowserCredential </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">true</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">            ExcludeAzureCliCredential </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">true</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">            ExcludeAzurePowerShellCredential </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">true</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">            ExcludeEnvironmentCredential </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">true</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">            ExcludeManagedIdentityCredential </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">false</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">            ExcludeSharedTokenCacheCredential </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">true</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">            ExcludeVisualStudioCodeCredential </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">true</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">            ExcludeVisualStudioCredential </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">false</span></span>
<span class="line"><span style="color: #24292E">        };</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">var</span><span style="color: #24292E"> </span><span style="color: #6F42C1">token</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">await</span><span style="color: #24292E"> </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #6F42C1">DefaultAzureCredential</span><span style="color: #24292E">(options).</span><span style="color: #6F42C1">GetTokenAsync</span><span style="color: #24292E">(context);</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #6F42C1">SqlAuthenticationToken</span><span style="color: #24292E">(token.Token, token.ExpiresOn);</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">public</span><span style="color: #24292E"> </span><span style="color: #D73A49">override</span><span style="color: #24292E"> </span><span style="color: #D73A49">bool</span><span style="color: #24292E"> </span><span style="color: #6F42C1">IsSupported</span><span style="color: #24292E">(</span><span style="color: #6F42C1">SqlAuthenticationMethod</span><span style="color: #24292E"> </span><span style="color: #6F42C1">authenticationMethod</span><span style="color: #24292E">)</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #D73A49">=></span><span style="color: #24292E"> authenticationMethod.</span><span style="color: #6F42C1">Equals</span><span style="color: #24292E">(SqlAuthenticationMethod.ActiveDirectoryDefault);</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre><pre data-language="csharp" data-theme="dark"><code data-language="csharp" data-theme="dark"><span class="line"><span style="color: #F97583">public</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">class</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">CustomActiveDirectoryDefaultAuthenticationProvider</span><span style="color: #E1E4E8"> : </span><span style="color: #B392F0">SqlAuthenticationProvider</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">private</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">readonly</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">string</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">tenantId</span><span style="color: #E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">public</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">CustomActiveDirectoryDefaultAuthenticationProvider</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">string</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">tenantId</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">    {</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">this</span><span style="color: #E1E4E8">.tenantId </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> tenantId;</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">public</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">override</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">async</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Task</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #B392F0">SqlAuthenticationToken</span><span style="color: #E1E4E8">> </span><span style="color: #B392F0">AcquireTokenAsync</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">SqlAuthenticationParameters</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">parameters</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">    {</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">var</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">context</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">TokenRequestContext</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">new</span><span style="color: #E1E4E8">[] { </span><span style="color: #9ECBFF">"https://database.windows.net//.default"</span><span style="color: #E1E4E8"> });</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">var</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">options</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">DefaultAzureCredentialOptions</span></span>
<span class="line"><span style="color: #E1E4E8">        {</span></span>
<span class="line"><span style="color: #E1E4E8">            VisualStudioTenantId </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> tenantId,</span></span>
<span class="line"><span style="color: #E1E4E8">            ExcludeInteractiveBrowserCredential </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">true</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">            ExcludeAzureCliCredential </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">true</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">            ExcludeAzurePowerShellCredential </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">true</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">            ExcludeEnvironmentCredential </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">true</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">            ExcludeManagedIdentityCredential </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">false</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">            ExcludeSharedTokenCacheCredential </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">true</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">            ExcludeVisualStudioCodeCredential </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">true</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">            ExcludeVisualStudioCredential </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">false</span></span>
<span class="line"><span style="color: #E1E4E8">        };</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">var</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">token</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">DefaultAzureCredential</span><span style="color: #E1E4E8">(options).</span><span style="color: #B392F0">GetTokenAsync</span><span style="color: #E1E4E8">(context);</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">SqlAuthenticationToken</span><span style="color: #E1E4E8">(token.Token, token.ExpiresOn);</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">public</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">override</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">bool</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">IsSupported</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">SqlAuthenticationMethod</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">authenticationMethod</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> authenticationMethod.</span><span style="color: #B392F0">Equals</span><span style="color: #E1E4E8">(SqlAuthenticationMethod.ActiveDirectoryDefault);</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre></div>
<p>The key point is that now we can provide a value for <code>VisualStudioTenantId</code>.</p>
<p>Please notice that all other methods except for Visual Studio Credential based authentication are excluded. This is because <code>DefaultAzureCredential</code> iterates over and attempts each authentication method. If one fails it will try the next one (unless excluded), which can take a moment and slow down your inner loop. By excluding all unnecessary methods, this problem is avoided.</p>
<p>You can register this provider in your application's DI:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="csharp" data-theme="light"><code data-language="csharp" data-theme="light"><span class="line"><span style="color: #24292E">SqlAuthenticationProvider.</span><span style="color: #6F42C1">SetProvider</span><span style="color: #24292E">(</span></span>
<span class="line"><span style="color: #24292E">    SqlAuthenticationMethod.ActiveDirectoryDefault,</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #6F42C1">CustomActiveDirectoryDefaultAuthenticationProvider</span><span style="color: #24292E">(myAzureTenantId));</span></span></code></pre><pre data-language="csharp" data-theme="dark"><code data-language="csharp" data-theme="dark"><span class="line"><span style="color: #E1E4E8">SqlAuthenticationProvider.</span><span style="color: #B392F0">SetProvider</span><span style="color: #E1E4E8">(</span></span>
<span class="line"><span style="color: #E1E4E8">    SqlAuthenticationMethod.ActiveDirectoryDefault,</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">CustomActiveDirectoryDefaultAuthenticationProvider</span><span style="color: #E1E4E8">(myAzureTenantId));</span></span></code></pre></div>
<p>And now the default <code>ActiveDirectoryDefault</code> authentication method is <strong>overwritten</strong> with your custom one! You can also register your <code>DbContext</code> with SQL Server (or Azure SQL) provider as usual:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="csharp" data-theme="light"><code data-language="csharp" data-theme="light"><span class="line"><span style="color: #24292E">services.</span><span style="color: #6F42C1">AddDbContext</span><span style="color: #24292E">&#x3C;</span><span style="color: #6F42C1">MyDbContext</span><span style="color: #24292E">>(</span><span style="color: #6F42C1">o</span><span style="color: #24292E"> </span><span style="color: #D73A49">=></span></span>
<span class="line"><span style="color: #24292E">    o.</span><span style="color: #6F42C1">UseSqlServer</span><span style="color: #24292E">(</span><span style="color: #032F62">"server=tcp:my-azure-sql.database.windows.net,1433;database=myDb;Authentication=Active Directory Default;Connection Timeout=60"</span><span style="color: #24292E">));</span></span></code></pre><pre data-language="csharp" data-theme="dark"><code data-language="csharp" data-theme="dark"><span class="line"><span style="color: #E1E4E8">services.</span><span style="color: #B392F0">AddDbContext</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #B392F0">MyDbContext</span><span style="color: #E1E4E8">>(</span><span style="color: #B392F0">o</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=></span></span>
<span class="line"><span style="color: #E1E4E8">    o.</span><span style="color: #B392F0">UseSqlServer</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"server=tcp:my-azure-sql.database.windows.net,1433;database=myDb;Authentication=Active Directory Default;Connection Timeout=60"</span><span style="color: #E1E4E8">));</span></span></code></pre></div>
<p>And, as long as you have <em>configured Azure Service Authentication in Visual Studio</em>, you now have access to the database using your Visual Studio credentials in Visual Studio and a Managed Identity in Azure.</p>
<p>I'd also recommend to set a <code>Connection Timeout</code> that is big enough to withstand the time that it takes to fetch a token when you don't have a fresh one in your cache. Usually it's fast, but at times it can take a while.</p>
<h2 id="bonus-setting-up-and-troubleshooting-azure-service-authentication-in-visual-studio"><a href="#bonus-setting-up-and-troubleshooting-azure-service-authentication-in-visual-studio"><strong>BONUS</strong>: Setting up and troubleshooting Azure Service Authentication in Visual Studio</a></h2>
<p>Set up the authentication by hitting <code>CTRL</code>+<code>Q</code> and searching "Azure Service Authentication". Select your account from the dropdown. Sometimes the dropdown doesn't work and it can also crash Visual Studio, so it may or may not take couple of attempts.</p>
<p>If your token has expired, you need to open up the "Azure Service Authentication" window again and re-enter your credentials. Sometimes you also need to restart Visual Studio after this.</p>
<p>If you seem to be able to enter your credentials, but you have an authentication problem that persists, it could be due to your cached token being invalid one way or another. For example, the token was received without MFA but your desired tenant requires MFA. One way to <em>really</em> refresh the token on-demand is to use <em>System web browser</em> and remove token from the login page's local storage. Hit <code>CTRL</code>+<code>Q</code> and search for "sign-in" and choose "System web browser" from the dropdown. If you now try to go re-enter your credentials, the login screen is opened in your default browser.</p>b:["$","div",null,{"className":"flex justify-center","children":["$","div",null,{"className":"md:px-10 min-w-0 max-w-7xl mb-12","children":["$","article",null,{"children":[["$","header",null,{"className":"px-5 mb-4 py-10 relative","children":[["$","h1",null,{"className":"text-3xl leading-none tracking-tight text-gray-900 md:text-4xl lg:text-5xl dark:text-gray-100","children":"EF Core authentication with DefaultAzureCredential"}],["$","time",null,{"dateTime":"2023-09-21 21:00","className":"pl-1 font-serif text-slate-400 bottom-0 absolute","children":[["$","svg",null,{"className":"h-4 w-4 inline-block","width":"24","height":"24","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 24 24","fill":"none","stroke":"currentColor","strokeWidth":"2","strokeLinecap":"round","strokeLinejoin":"round","children":[["$","path",null,{"d":"M12 19l7-7 3 3-7 7-3-3z"}]," ",["$","path",null,{"d":"M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"}]," ",["$","path",null,{"d":"M2 2l7.586 7.586"}]," ",["$","circle",null,{"cx":"11","cy":"11","r":"2"}]]}]," ","2023-09-21 21:00"]}]]}],["$","div",null,{"className":"bg-slate-100 dark:bg-slate-800 p-5 pb-12 rounded shadow-lg","children":[[["$","p",null,{"className":"italic text-slate-400 p-4","dangerouslySetInnerHTML":{"__html":"This article was written based on Microsoft.EntityFrameworkCore 7.0.10.0 and Visual Studio 2022 17.6.6."}}],["$","hr",null,{"className":"h-px my-4 bg-gray-200 border-0 dark:bg-gray-700"}]],["$","div",null,{"className":"space-y-4","dangerouslySetInnerHTML":{"__html":"$c"}}]]}]]}]}]}]
a:null
