<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />

    

    

    <title>Debuggable scripting with TypeScript and ClearScript | Internal Static Void</title>
    <meta name="author" content="John Doe" />
    <meta name="keywords" content="" />
    <meta name="description" content="The code samples provided in this blog post are available at ClearScriptV8Poc.When your system grows, you may or may not want to consider supporting scripting for more dynamic and advanced customization. Ideally, an untrusted developer/customizer sho" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />

    
    <link rel="alternate" href="/atom.xml" title="Internal Static Void" type="application/atom+xml">
    
    
    <link rel="icon" href="/images/favicon.ico">
    

    <style type="text/css">
    @font-face {
        font-family: 'icomoon';
        src: url("/fonts/icomoon.eot?q628ml");
        src: url("/fonts/icomoon.eot?q628ml#iefix") format('embedded-opentype'),
             url("/fonts/icomoon.ttf?q628ml") format('truetype'),
             url("/fonts/icomoon.woff?q628ml") format('woff'),
             url("/fonts/icomoon.svg?q628ml#icomoon") format('svg');
        font-weight: normal;
        font-style: normal;
    }
    </style>
    
<link rel="stylesheet" href="/css/style.css">


    <!--[if lt IE 9]><style type="text/css">.nav-inner {top:0;}.author-meta {position:static;top:0;}.search-form {height:36px;}</style><script type="text/javascript" src="https://unpkg.com/html5shiv@3.7.3/dist/html5shiv.min.js"></script><![endif]-->
<meta name="generator" content="Hexo 5.3.0"></head>
<body>

    <main class="app">
        <header id="header" class="header clearfix">
    <div id="nav" class="nav">
    <div class="nav-mobile">
        <button id="open-panel" class="open-panel nav-mobile-item"><i class="icon-documents"></i></button>
        <h1 class="nav-mobile-title nav-mobile-item">Internal Static Void</h1>
        <button id="open-menus" class="open-panel nav-mobile-item"><i class="icon-library"></i></button>
    </div>

    <nav id="nav-inner" class="nav-inner">
        
            <a class="nav-item" href="/">
                <span class="nav-text">All</span>
            </a>
        
            <a class="nav-item" href="/categories/azure">
                <span class="nav-text">Azure</span>
            </a>
        
            <a class="nav-item" href="/categories/dotnet">
                <span class="nav-text">dotnet</span>
            </a>
        
    </nav>
</div>

    <aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="icon-search-stroke"></i></button><input type="hidden" name="sitesearch" value="http://example.com"></form>

        
        
        
        

        
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Create-a-script"><span class="toc-number">1.</span> <span class="toc-text">Create a script</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Build-the-script"><span class="toc-number">2.</span> <span class="toc-text">Build the script</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Implement-the-host"><span class="toc-number">3.</span> <span class="toc-text">Implement the host</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Debug-the-script"><span class="toc-number">4.</span> <span class="toc-text">Debug the script</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Considerations"><span class="toc-number">5.</span> <span class="toc-text">Considerations</span></a></li></ol>
        
    </div>
</aside>

</header>

        <div id="content" class="content">
            <div id="wrapper" class="wrapper" style="max-width: 800px">
                <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            Debuggable scripting with TypeScript and ClearScript
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://example.com/2022/11/28/debuggable-scripting-with-typescript-and-clearscript/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2022-11-28T21:00:00.000Z" itemprop="datePublished">2022-11-28</time>
</a>

            

        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <p><i>The code samples provided in this blog post are available at <a target="_blank" rel="noopener" href="https://github.com/iotalambda/ClearScriptV8Poc">ClearScriptV8Poc</a>.</i></p>
<p>When your system grows, you may or may not want to consider supporting <i>scripting</i> for more dynamic and advanced customization. Ideally, an untrusted developer/customizer should be able to upload a script to the system, which is then part of the final flow of execution.</p>
<p><i>Pretty much everyone knows JavaScript to some extent</i>, so it is probably the most comfortable choice for a scripting language. Though, when there are complex contracts that the customizer must comply with and rely on, having <i>types</i> can save you from a world of pain. Probably it wouldn¬¥t be too much to ask if we required our customizers to use TypeScript instead.</p>
<p>Besides types and choosing a language, it is also necessary to offer the customizers a way to debug their scripts - especially once the script logic has evolved into a no-longer-trivial state. In this blog post we will explore <i>a</i> way to potentially achieve it:</p>
<ul>
<li><b>Use TypeScript as the scripting language</b></li>
<li><b>Use .NET &amp; ClearScript for running the scripts</b></li>
<li><b>Use Edge DevTools for debugging them.</b></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/microsoft/ClearScript">ClearScript</a> is a seemingly well supported .NET based wrapper around <a target="_blank" rel="noopener" href="https://v8.dev/">V8</a>, Google¬¥s famous JavaScript engine. This means that ClearScript supports ECMAScript just as much as V8 implements it. There are several other means for running JS on .NET, such as <a target="_blank" rel="noopener" href="https://github.com/sebastienros/jint">Jint</a>, which is a JavaScript interpreter and in many situations faster that ClearScript. Though, in our scenario we want to be able to leverage existing tooling around V8 such as debuggers supporting the <a target="_blank" rel="noopener" href="https://v8.dev/docs/inspector">V8 Inspector Protocol</a>.</p>
<p>ClearScript doesn¬¥t implement Node APIs or Web APIs, which in itself offers us a relatively closed sandbox. Still, a buggy or malicious script could hog all the CPU and memory or simply run in a loop forever. These things are not discussed in this blog post but surely should be considered for a production ready solution.</p>
<h2 id="Create-a-script"><a href="#Create-a-script" class="headerlink" title="Create a script"></a>Create a script</h2><p>First, let¬¥s create a simple piece of TypeScript that we¬¥d like to run on our hypothetical service:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> run = (): <span class="function"><span class="params">number</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;Enter run&#x27;</span>);</span><br><span class="line">  <span class="keyword">let</span> value = <span class="number">5</span>;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;Break&#x27;</span>);</span><br><span class="line">  <span class="keyword">debugger</span>;</span><br><span class="line">  value += <span class="number">2</span>;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;Exit run&#x27;</span>);</span><br><span class="line">  <span class="keyword">return</span> value;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Our sample here doesn¬¥t utilize the type system that much, but at least it has the return type <code>: number</code> set. That‚Äôs enough for us for now üòé Also we will use ES6 style modules for our purposes. Ideally the customizer would create and publish a module as a package and then our system would be able to import it.</p>
<p>Note that the script uses <code>console</code>, which is part of Web API but not V8. Therefore the platform that we will create must provide the global <code>console</code> object or otherwise it will be <code>undefined</code>.</p>
<h2 id="Build-the-script"><a href="#Build-the-script" class="headerlink" title="Build the script"></a>Build the script</h2><p>Next, let¬¥s add <code>tsconfig.json</code>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tsconfig.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;compilerOptions&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;outDir&quot;</span>: <span class="string">&quot;./dist/&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;sourceMap&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">&quot;target&quot;</span>: <span class="string">&quot;es5&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;module&quot;</span>: <span class="string">&quot;es6&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;moduleResolution&quot;</span>: <span class="string">&quot;node&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The transpiled JavaScript should contain an ES6 style module. Notice that we enable <i>source map</i> file generation with <code>&quot;sourceMap&quot;: true</code>. The source map files will contain a mapping between the TypeScript source code and the transpiled JavaScript ‚Äúbinary‚Äù. V8 knows only JavaScript, so source maps can be used to tell debuggers how the executed JavaScript is connected to the TypeScript source code. The output will essentially be two files: <code>index.js</code> and <code>index.js.map</code> but both of them are immediately consumed by Webpack.</p>
<p>So Webpack is the build tool of our choice (could have used e.g. <code>esbuild</code> as well):</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; fileURLToPath &#125; <span class="keyword">from</span> <span class="string">&#x27;url&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> __dirname = path.dirname(fileURLToPath(<span class="keyword">import</span>.meta.url));</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  mode: <span class="string">&#x27;development&#x27;</span>,</span><br><span class="line">  entry: <span class="string">&#x27;./src/index.ts&#x27;</span>,</span><br><span class="line">  devtool: <span class="string">&#x27;inline-source-map&#x27;</span>,</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.ts$/</span>,</span><br><span class="line">        use: <span class="string">&#x27;ts-loader&#x27;</span>,</span><br><span class="line">        exclude: <span class="regexp">/node_modules/</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">  resolve: &#123;</span><br><span class="line">    extensions: [<span class="string">&#x27;.ts&#x27;</span>, <span class="string">&#x27;.js&#x27;</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">  output: &#123;</span><br><span class="line">    filename: <span class="string">&#x27;bundle.js&#x27;</span>,</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">&#x27;dist&#x27;</span>),</span><br><span class="line">    library: &#123;</span><br><span class="line">      type: <span class="string">&#x27;module&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  experiments: &#123;</span><br><span class="line">    outputModule: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>We use <code>ts-loader</code> to load the TypeScript files and finally output <code>bundle.js</code> which exports a module. Notice the line <code>devtool: inline-source-map</code>: we bundle the previously generated <code>.js.map</code> files into <code>bundle.js</code> so that the debugger will later be able to catch the source map from <code>bundle.js</code>. We could have also used just <code>devtools: source-map</code> to generate a separate <code>bundle.js.map</code> but we¬¥ll use the inline version for simplicity.</p>
<p>After running <code>npx webpack</code> <code>bundle.js</code> is generated under <code>/dist/</code> and the file contains the inline source maps as expected.</p>
<h2 id="Implement-the-host"><a href="#Implement-the-host" class="headerlink" title="Implement the host"></a>Implement the host</h2><p>Next, let¬¥s create a ClearScript V8 host that will run the script:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Program.cs</span></span><br><span class="line"><span class="keyword">using</span> Microsoft.ClearScript;</span><br><span class="line"><span class="keyword">using</span> Microsoft.ClearScript.JavaScript;</span><br><span class="line"><span class="keyword">using</span> Microsoft.ClearScript.V8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> engine = <span class="keyword">new</span> V8ScriptEngine(V8ScriptEngineFlags.EnableDebugging, <span class="number">9222</span>);</span><br><span class="line"><span class="built_in">dynamic</span> setupConsole = engine.Evaluate(<span class="string">&quot;writeLine =&gt; console = &#123; log: message =&gt; writeLine(message) &#125;&quot;</span>);</span><br><span class="line">setupConsole(<span class="keyword">new</span> Action&lt;<span class="built_in">string</span>&gt;(Console.WriteLine));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> js = File.ReadAllText(<span class="string">&quot;..\\..\\..\\..\\..\\demo\\dist\\bundle.js&quot;</span>);</span><br><span class="line">engine.DocumentSettings.AddSystemDocument(<span class="string">&quot;bundle&quot;</span>, ModuleCategory.Standard, js);</span><br><span class="line"><span class="built_in">dynamic</span> exports = engine.Evaluate(<span class="keyword">new</span> DocumentInfo &#123; Category = ModuleCategory.Standard &#125;, <span class="string">&quot;import * as exports from &#x27;bundle&#x27;; exports&quot;</span>);</span><br><span class="line"></span><br><span class="line">Console.WriteLine(<span class="string">&quot;Open your debugger and hit enter&quot;</span>);</span><br><span class="line">Console.ReadLine();</span><br><span class="line">exports.run();</span><br></pre></td></tr></table></figure>
<ul>
<li><b>line 6</b>: Setup the ClearScript V8 with <code>ScriptEngineFlags.EnableDebugging</code> which starts a listener in port <code>9222</code> which is the standard port for debugging node.js</li>
<li><b>lines 7-8</b>: Create the global <code>console</code> object, so that <code>console.log</code> will <code>Console.WriteLine</code>. Note that we could have also used <code>engine.AddHostObject(&quot;console&quot;, ...)</code> to create the <code>console</code> object, but this would have also exposed the standard <code>System.Object</code> members such as <code>GetHashCode</code> to the script. We prefer not having those as part of our API that we provide to our customizers.</li>
<li><b>lines 10-12</b>: Load the previously generated bundle and then import &amp; export it in an inline code block so that it can be marshalled with a CLR object <code>dynamic exports</code></li>
<li><b>lines 14-16</b>: Wait for a debugger to attach to the listener. Depending on the debugger, it may take a second or two. Once the debugger has been attached, user should hit ENTER and then the <code>run()</code> function exported by our TypeScript module will be executed.</li>
</ul>
<h2 id="Debug-the-script"><a href="#Debug-the-script" class="headerlink" title="Debug the script"></a>Debug the script</h2><p>Finally, let¬¥s try debugging:</p>
<ol>
<li>Open up Edge Remote Targets by browsing to <code>edge://inspect</code></li>
<li>Run the .NET Console app</li>
<li>Wait for Edge to locate the listener and then click <code>inspect</code></li>
<li>Hit ENTER in the Console app</li>
<li>Wait for Edge DevTools debugger to attach to the process</li>
</ol>
<p>and then the debugger in Edge DevTools will break at the <code>debugger</code> statement of the original TypeScript code! AND the inspected function has the <code>: number</code> return type üòé.</p>
<p><img src="/images/scriptable-debugging-edge.png"></p>
<h2 id="Considerations"><a href="#Considerations" class="headerlink" title="Considerations"></a>Considerations</h2><p>As we can see, ClearScript supports the desired flow. Though as explained earlier, there are some caveats too. Besides the mentioned risks in executing untrusted code, one has to be aware that V8 is not Node.js and therefore ClearScript doesn¬¥t include Node¬¥s event loop. This means that the hypothetical script host would be single threaded per <code>V8ScriptEngine</code> instance (and each instance has a non-trivial memory overhead). But one could work around this to some extent by <a target="_blank" rel="noopener" href="https://github.com/Microsoft/ClearScript/issues/53#issuecomment-387387543">pooling <code>V8ScriptEngine</code> instances</a>.</p>
<p>Also in a real-life debugging scenario, the customizer would use <i>remote debugging</i> which is enabled in ClearScript with <code>V8ScriptEngineFlags.EnableRemoteDebugging</code> flag. This naturally exposes new attack vectors that must be addressed appropriately. <a target="_blank" rel="noopener" href="https://nodejs.org/en/docs/guides/debugging-getting-started/#enabling-remote-debugging-scenarios">The official Node.js guide for remote debugging</a> is a good starting point.</p>

        
    </section>
</article>



<a id="pagenext" href="/2021/03/04/anemic-models-and-deserialization-in-asp-net-core/" class="article-next" title="Anemic models and deserialization in ASP.NET Core"><i class="icon-arrow-right"></i></a>





            </div>
        </div>
        <footer class="footer">
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Theme by <a href="https://github.com/sanonz/hexo-theme-concise" target="_blank">Concise</a>

    
</footer>

    </main>

    <script type="text/javascript" src="https://unpkg.com/jquery@1.9.1/jquery.min.js"></script>
    <script type="text/javascript">
    $(function() {
        var nodes = {
            nav: $('#nav'),
            aside: $('#aside'),
            asideInner: $('#aside-inner'),
            navInner: $('#nav-inner')
        };

        var doing = false;
        nodes.asideInner.on('webkitAnimationEnd mozAnimationEnd oAnimationEnd oanimationend animationend', function() {
            if (nodes.aside.hasClass('mobile-open')) {
                nodes.aside.removeClass('mobile-open');
            } else {
                nodes.aside.removeClass('mobile-close panel-show');
            }
            doing = false;
        });
        $('#open-panel, #aside-mask').on('click', function() {
            if (doing) {
                return;
            }

            if (nodes.aside.hasClass('panel-show')) {
                nodes.aside.addClass('mobile-close');
            } else {
                nodes.aside.addClass('mobile-open panel-show');
            }
        });
        $('#open-menus').on('click', function() {
            nodes.navInner.slideToggle('normal', slideDone);
        });

        if (window.innerWidth <= 960) {
            setTimeout(function() {
                nodes.navInner.slideUp('normal', slideDone);
            }, 3000);
        }

        function slideDone() {
            if (nodes.navInner.css('display') !== 'none') {
                nodes.navInner.css('display', '');
            }
        }

        $(window).on('resize', function() {
            if ($(this).width() > 960) {
                nodes.navInner.css('display', '');
            }
        });
    });
    </script>
    
        
<script src="/js/scrollspy.min.js"></script>

        <script type="text/javascript">
        $(document.body).scrollspy({target: '#aside-inner'});

        $(window).on('resize', function() {
            var hw = $('#header').width();
            var ww = $('#wrapper').width();
            var space = ($(this).width() - hw - ww) / 2 / 2;

            var pageprev = $('#pageprev');
            var pagenext = $('#pagenext');
            var avg = (pageprev.width() + pagenext.width()) / 2

            if(space > avg) {
                var len = space - avg / 2;
                var styles = {position: 'fixed', top: '50%', marginTop: - (pageprev.width() + pagenext.width()) / 4}
                pageprev.css($.extend({left: hw + len}, styles));
                pagenext.css($.extend({right: len}, styles));
            } else {
                pageprev.removeAttr('style');
                pagenext.removeAttr('style');
            }
        }).trigger('resize');
        </script>
    

</body>
</html>
