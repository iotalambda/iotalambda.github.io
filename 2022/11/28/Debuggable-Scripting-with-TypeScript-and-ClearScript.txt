1:HL["/_next/static/media/3d9ea938b6afa941-s.p.woff2",{"as":"font","type":"font/woff2"}]
2:HL["/_next/static/media/7eaa4a2482b4df1a-s.p.woff2",{"as":"font","type":"font/woff2"}]
3:HL["/_next/static/css/488301a2e2aae266.css",{"as":"style"}]
0:["mDQqNfJVq-sFMUm8lVrTq",[[["",{"children":[["id","2022/11/28/Debuggable-Scripting-with-TypeScript-and-ClearScript","c"],{"children":["__PAGE__?{\"id\":[\"2022\",\"11\",\"28\",\"Debuggable-Scripting-with-TypeScript-and-ClearScript\"]}",{}]}]},"$undefined","$undefined",true],"$L4",[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/488301a2e2aae266.css","precedence":"next"}]],"$L5"]]]]
6:HL["/_next/static/css/301e7291452e98cd.css",{"as":"style"}]
7:I{"id":6685,"chunks":["685:static/chunks/685-a8c11ad368fada34.js","185:static/chunks/app/layout-0afbb0e01943be7f.js"],"name":"","async":false}
8:I{"id":7767,"chunks":["272:static/chunks/webpack-b2aba447c1dc2205.js","971:static/chunks/fd9d1056-a99b58d3cc150217.js","596:static/chunks/596-9d43875837bd0b65.js"],"name":"default","async":false}
9:I{"id":7920,"chunks":["272:static/chunks/webpack-b2aba447c1dc2205.js","971:static/chunks/fd9d1056-a99b58d3cc150217.js","596:static/chunks/596-9d43875837bd0b65.js"],"name":"default","async":false}
4:[null,["$","html",null,{"lang":"en","className":"__variable_965427 __variable_9c011f","children":["$","body",null,{"className":"bg-slate-200 dark:bg-slate-700","children":[["$","nav",null,{"className":"w-full flex flex-row justify-between bg-indigo-600 shadow-indigo-300 dark:shadow-indigo-800 shadow-2xl font-sans","children":["$","div",null,{"className":"p-2","children":["$","$L7",null,{"className":"text-2xl font-semibold text-neutral-100 dark:text-neutral-200","href":"/","children":[["$","h1",null,{"className":"inline","children":"üçî food for ai"}]," ",["$","span",null,{"className":"font-mono font-light text-xs","children":"food.joona.cloud"}]]}]}]}],["$","main",null,{"className":"mt-4","children":["$","$L8",null,{"parallelRouterKey":"children","segmentPath":["children"],"loading":"$undefined","loadingStyles":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","template":["$","$L9",null,{}],"templateStyles":"$undefined","notFound":[["$","title",null,{"children":"404: This page could not be found."}],["$","div",null,{"style":{"fontFamily":"system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"","height":"100vh","textAlign":"center","display":"flex","flexDirection":"column","alignItems":"center","justifyContent":"center"},"children":["$","div",null,{"children":[["$","style",null,{"dangerouslySetInnerHTML":{"__html":"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}"}}],["$","h1",null,{"className":"next-error-h1","style":{"display":"inline-block","margin":"0 20px 0 0","padding":"0 23px 0 0","fontSize":24,"fontWeight":500,"verticalAlign":"top","lineHeight":"49px"},"children":"404"}],["$","div",null,{"style":{"display":"inline-block"},"children":["$","h2",null,{"style":{"fontSize":14,"fontWeight":400,"lineHeight":"49px","margin":0},"children":"This page could not be found."}]}]]}]}]],"notFoundStyles":[],"childProp":{"current":["$","$L8",null,{"parallelRouterKey":"children","segmentPath":["children",["id","2022/11/28/Debuggable-Scripting-with-TypeScript-and-ClearScript","c"],"children"],"loading":"$undefined","loadingStyles":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","template":["$","$L9",null,{}],"templateStyles":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","childProp":{"current":["$La","$Lb",null],"segment":"__PAGE__?{\"id\":[\"2022\",\"11\",\"28\",\"Debuggable-Scripting-with-TypeScript-and-ClearScript\"]}"},"styles":[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/301e7291452e98cd.css","precedence":"next"}]]}],"segment":["id","2022/11/28/Debuggable-Scripting-with-TypeScript-and-ClearScript","c"]},"styles":[]}]}]]}]}],null]
5:[["$","meta","0",{"charSet":"utf-8"}],["$","title","1",{"children":"Debuggable Scripting with TypeScript and ClearScript | Food for AI blog"}],["$","meta","2",{"name":"description","content":"Blog about .NET, Azure, React and whatever comes to mind."}],["$","meta","3",{"name":"viewport","content":"width=device-width, initial-scale=1"}],["$","link","4",{"rel":"icon","href":"/favicon.ico","type":"image/x-icon","sizes":"16x16"}],["$","meta","5",{"name":"next-size-adjust"}]]
c:T889d,<p>When a system grows, you may want to consider supporting scripting for more dynamic and advanced customization. Ideally, an untrusted developer or customizer should be able to upload a script to the system, which becomes part of the final flow of execution.</p>
<p>Although JavaScript is a popular choice for a scripting language, when there are complex contracts that the customizer must comply with and rely on, having types can save you from a world of pain. It wouldn't be too much to ask if we required our customizers to use TypeScript instead.</p>
<p>Besides types and choosing a language, it is also necessary to offer the customizers a way to debug their scripts, especially once the script logic has evolved into a no-longer-trivial state. In this blog post, we will explore a way to potentially achieve this:</p>
<ul>
<li><strong>Use TypeScript as the scripting language</strong></li>
<li><strong>Use .NET and ClearScript to run the scripts</strong></li>
<li><strong>Use Edge DevTools for debugging them</strong></li>
</ul>
<p><a href="https://github.com/microsoft/ClearScript">ClearScript</a> is a seemingly well-supported .NET-based wrapper around V8, Google's JavaScript engine. This means that ClearScript supports ECMAScript just as much as V8 implements it. There are several other means for running JavaScript on .NET, such as <a href="https://github.com/sebastienros/jint">Jint</a>, which is a JavaScript interpreter and in many situations faster than ClearScript. However, in our scenario, we want to be able to leverage existing tooling around V8 such as debuggers supporting the <a href="https://v8.dev/docs/inspector">V8 Inspector Protocol</a>.</p>
<p>ClearScript does not implement Node APIs or Web APIs, which in itself offers us a relatively closed sandbox. However, a buggy or malicious script could still hog all the CPU and memory or simply run in a loop forever. These things are not discussed in this blog post, but they should be considered for a production-ready solution.</p>
<h2 id="create-a-script"><a href="#create-a-script">Create a script</a></h2>
<p>First, let's create a simple piece of TypeScript that we'd like to run on our hypothetical service:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="ts" data-theme="light"><code data-language="ts" data-theme="light"><span class="line"><span style="color: #6A737D">// index.ts</span></span>
<span class="line"><span style="color: #D73A49">export</span><span style="color: #24292E"> </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">run</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> ()</span><span style="color: #D73A49">:</span><span style="color: #24292E"> </span><span style="color: #005CC5">number</span><span style="color: #24292E"> </span><span style="color: #D73A49">=></span><span style="color: #24292E"> {</span></span>
<span class="line"><span style="color: #24292E">  console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #032F62">"Enter run"</span><span style="color: #24292E">)</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">let</span><span style="color: #24292E"> value </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">5</span></span>
<span class="line"><span style="color: #24292E">  console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #032F62">"Break"</span><span style="color: #24292E">)</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">debugger</span></span>
<span class="line"><span style="color: #24292E">  value </span><span style="color: #D73A49">+=</span><span style="color: #24292E"> </span><span style="color: #005CC5">2</span></span>
<span class="line"><span style="color: #24292E">  console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #032F62">"Exit run"</span><span style="color: #24292E">)</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> value</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre><pre data-language="ts" data-theme="dark"><code data-language="ts" data-theme="dark"><span class="line"><span style="color: #6A737D">// index.ts</span></span>
<span class="line"><span style="color: #F97583">export</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">run</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> ()</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">number</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"Enter run"</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">let</span><span style="color: #E1E4E8"> value </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">5</span></span>
<span class="line"><span style="color: #E1E4E8">  console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"Break"</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">debugger</span></span>
<span class="line"><span style="color: #E1E4E8">  value </span><span style="color: #F97583">+=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">2</span></span>
<span class="line"><span style="color: #E1E4E8">  console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"Exit run"</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> value</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre></div>
<p>Our sample here doesn't utilize the type system that much, but at least it has the return type <code>: number</code> set. That's enough for us for now. Also, we will use ES6-style modules for our purposes. Ideally, the customizer would create and publish a module as a package, and then our system would be able to import it.</p>
<p>Note that the script uses <code>console</code>, which is part of the Web API but not V8. Therefore, the platform that we will create must provide the global <code>console</code> object, or it will be <code>undefined</code>.</p>
<h2 id="build-the-script"><a href="#build-the-script">Build the script</a></h2>
<p>Next, let¬¥s add <code>tsconfig.json</code>:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="json" data-theme="light"><code data-language="json" data-theme="light"><span class="line"><span style="color: #6A737D">// tsconfig.json</span></span>
<span class="line"><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #005CC5">"compilerOptions"</span><span style="color: #24292E">: {</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #005CC5">"outDir"</span><span style="color: #24292E">: </span><span style="color: #032F62">"./dist/"</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #005CC5">"sourceMap"</span><span style="color: #24292E">: </span><span style="color: #005CC5">true</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #005CC5">"target"</span><span style="color: #24292E">: </span><span style="color: #032F62">"es5"</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #005CC5">"module"</span><span style="color: #24292E">: </span><span style="color: #032F62">"es6"</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #005CC5">"moduleResolution"</span><span style="color: #24292E">: </span><span style="color: #032F62">"node"</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre><pre data-language="json" data-theme="dark"><code data-language="json" data-theme="dark"><span class="line"><span style="color: #6A737D">// tsconfig.json</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #79B8FF">"compilerOptions"</span><span style="color: #E1E4E8">: {</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">"outDir"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"./dist/"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">"sourceMap"</span><span style="color: #E1E4E8">: </span><span style="color: #79B8FF">true</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">"target"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"es5"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">"module"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"es6"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">"moduleResolution"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"node"</span></span>
<span class="line"><span style="color: #E1E4E8">  }</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre></div>
<p>The transpiled JavaScript should contain an ES6-style module. Notice that we enable <em>source map</em> file generation with <code>"sourceMap": true</code>. The source map files will contain a mapping between the TypeScript source code and the transpiled JavaScript "binary". V8 knows only JavaScript so source maps can be used to tell debuggers how the executed JavaScript is connected to the TypeScript source code. The output will essentially be two files: <code>index.js</code> and <code>index.js.map</code>, but both of them are immediately consumed by Webpack.</p>
<p>So Webpack is the build tool of our choice (could have used e.g. <code>esbuild</code> as well):</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="js" data-theme="light"><code data-language="js" data-theme="light"><span class="line"><span style="color: #6A737D">// webpack.config.js</span></span>
<span class="line"><span style="color: #D73A49">import</span><span style="color: #24292E"> path </span><span style="color: #D73A49">from</span><span style="color: #24292E"> </span><span style="color: #032F62">"path"</span></span>
<span class="line"><span style="color: #D73A49">import</span><span style="color: #24292E"> { fileURLToPath } </span><span style="color: #D73A49">from</span><span style="color: #24292E"> </span><span style="color: #032F62">"url"</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">__dirname</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> path.</span><span style="color: #6F42C1">dirname</span><span style="color: #24292E">(</span><span style="color: #6F42C1">fileURLToPath</span><span style="color: #24292E">(</span><span style="color: #D73A49">import</span><span style="color: #24292E">.</span><span style="color: #005CC5">meta</span><span style="color: #24292E">.url))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">export</span><span style="color: #24292E"> </span><span style="color: #D73A49">default</span><span style="color: #24292E"> {</span></span>
<span class="line"><span style="color: #24292E">  mode: </span><span style="color: #032F62">"development"</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">  entry: </span><span style="color: #032F62">"./src/index.ts"</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">  devtool: </span><span style="color: #032F62">"inline-source-map"</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">  module: {</span></span>
<span class="line"><span style="color: #24292E">    rules: [</span></span>
<span class="line"><span style="color: #24292E">      {</span></span>
<span class="line"><span style="color: #24292E">        test:</span><span style="color: #032F62"> /</span><span style="color: #22863A; font-weight: bold">\.</span><span style="color: #032F62">ts</span><span style="color: #D73A49">$</span><span style="color: #032F62">/</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">        use: </span><span style="color: #032F62">"ts-loader"</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">        exclude:</span><span style="color: #032F62"> /node_modules/</span></span>
<span class="line"><span style="color: #24292E">      }</span></span>
<span class="line"><span style="color: #24292E">    ]</span></span>
<span class="line"><span style="color: #24292E">  },</span></span>
<span class="line"><span style="color: #24292E">  resolve: {</span></span>
<span class="line"><span style="color: #24292E">    extensions: [</span><span style="color: #032F62">".ts"</span><span style="color: #24292E">, </span><span style="color: #032F62">".js"</span><span style="color: #24292E">]</span></span>
<span class="line"><span style="color: #24292E">  },</span></span>
<span class="line"><span style="color: #24292E">  output: {</span></span>
<span class="line"><span style="color: #24292E">    filename: </span><span style="color: #032F62">"bundle.js"</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">    path: path.</span><span style="color: #6F42C1">resolve</span><span style="color: #24292E">(__dirname, </span><span style="color: #032F62">"dist"</span><span style="color: #24292E">),</span></span>
<span class="line"><span style="color: #24292E">    library: {</span></span>
<span class="line"><span style="color: #24292E">      type: </span><span style="color: #032F62">"module"</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">  },</span></span>
<span class="line"><span style="color: #24292E">  experiments: {</span></span>
<span class="line"><span style="color: #24292E">    outputModule: </span><span style="color: #005CC5">true</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre><pre data-language="js" data-theme="dark"><code data-language="js" data-theme="dark"><span class="line"><span style="color: #6A737D">// webpack.config.js</span></span>
<span class="line"><span style="color: #F97583">import</span><span style="color: #E1E4E8"> path </span><span style="color: #F97583">from</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"path"</span></span>
<span class="line"><span style="color: #F97583">import</span><span style="color: #E1E4E8"> { fileURLToPath } </span><span style="color: #F97583">from</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"url"</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">__dirname</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> path.</span><span style="color: #B392F0">dirname</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">fileURLToPath</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">import</span><span style="color: #E1E4E8">.</span><span style="color: #79B8FF">meta</span><span style="color: #E1E4E8">.url))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">export</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">default</span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  mode: </span><span style="color: #9ECBFF">"development"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">  entry: </span><span style="color: #9ECBFF">"./src/index.ts"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">  devtool: </span><span style="color: #9ECBFF">"inline-source-map"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">  module: {</span></span>
<span class="line"><span style="color: #E1E4E8">    rules: [</span></span>
<span class="line"><span style="color: #E1E4E8">      {</span></span>
<span class="line"><span style="color: #E1E4E8">        test:</span><span style="color: #DBEDFF"> </span><span style="color: #9ECBFF">/</span><span style="color: #85E89D; font-weight: bold">\.</span><span style="color: #DBEDFF">ts</span><span style="color: #F97583">$</span><span style="color: #9ECBFF">/</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        use: </span><span style="color: #9ECBFF">"ts-loader"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        exclude:</span><span style="color: #DBEDFF"> </span><span style="color: #9ECBFF">/</span><span style="color: #DBEDFF">node_modules</span><span style="color: #9ECBFF">/</span></span>
<span class="line"><span style="color: #E1E4E8">      }</span></span>
<span class="line"><span style="color: #E1E4E8">    ]</span></span>
<span class="line"><span style="color: #E1E4E8">  },</span></span>
<span class="line"><span style="color: #E1E4E8">  resolve: {</span></span>
<span class="line"><span style="color: #E1E4E8">    extensions: [</span><span style="color: #9ECBFF">".ts"</span><span style="color: #E1E4E8">, </span><span style="color: #9ECBFF">".js"</span><span style="color: #E1E4E8">]</span></span>
<span class="line"><span style="color: #E1E4E8">  },</span></span>
<span class="line"><span style="color: #E1E4E8">  output: {</span></span>
<span class="line"><span style="color: #E1E4E8">    filename: </span><span style="color: #9ECBFF">"bundle.js"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">    path: path.</span><span style="color: #B392F0">resolve</span><span style="color: #E1E4E8">(__dirname, </span><span style="color: #9ECBFF">"dist"</span><span style="color: #E1E4E8">),</span></span>
<span class="line"><span style="color: #E1E4E8">    library: {</span></span>
<span class="line"><span style="color: #E1E4E8">      type: </span><span style="color: #9ECBFF">"module"</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"><span style="color: #E1E4E8">  },</span></span>
<span class="line"><span style="color: #E1E4E8">  experiments: {</span></span>
<span class="line"><span style="color: #E1E4E8">    outputModule: </span><span style="color: #79B8FF">true</span></span>
<span class="line"><span style="color: #E1E4E8">  }</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre></div>
<p>We use <code>ts-loader</code> to load the TypeScript files and finally output <code>bundle.js</code>, which exports a module. Notice the line <code>devtool: inline-source-map</code>: we bundle the previously generated <code>.js.map</code> files into <code>bundle.js</code> so that the debugger will later be able to catch the source map from <code>bundle.js</code>. We could have also used just <code>devtools: source-map</code> to generate a separate <code>bundle.js.map</code>, but we'll use the inline version for simplicity.</p>
<p>After running <code>npx webpack</code>, <code>bundle.js</code> is generated under <code>/dist/</code>, and the file contains the inline source maps as expected.</p>
<h2 id="implementing-the-host"><a href="#implementing-the-host">Implementing the host</a></h2>
<p>Next, let¬¥s create a ClearScript V8 host that will run the script:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="csharp" data-theme="light"><code data-language="csharp" data-theme="light"><span class="line"><span style="color: #6A737D">// Program.cs</span></span>
<span class="line"><span style="color: #D73A49">using</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Microsoft</span><span style="color: #24292E">.</span><span style="color: #6F42C1">ClearScript</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #D73A49">using</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Microsoft</span><span style="color: #24292E">.</span><span style="color: #6F42C1">ClearScript</span><span style="color: #24292E">.</span><span style="color: #6F42C1">JavaScript</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #D73A49">using</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Microsoft</span><span style="color: #24292E">.</span><span style="color: #6F42C1">ClearScript</span><span style="color: #24292E">.</span><span style="color: #6F42C1">V8</span><span style="color: #24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">var</span><span style="color: #24292E"> </span><span style="color: #6F42C1">engine</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #6F42C1">V8ScriptEngine</span><span style="color: #24292E">(V8ScriptEngineFlags.EnableDebugging, </span><span style="color: #005CC5">9222</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #D73A49">dynamic</span><span style="color: #24292E"> </span><span style="color: #6F42C1">setupConsole</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> engine.</span><span style="color: #6F42C1">Evaluate</span><span style="color: #24292E">(</span><span style="color: #032F62">"writeLine => console = { log: message => writeLine(message) }"</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #6F42C1">setupConsole</span><span style="color: #24292E">(</span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Action</span><span style="color: #24292E">&#x3C;</span><span style="color: #D73A49">string</span><span style="color: #24292E">>(Console.WriteLine));</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">var</span><span style="color: #24292E"> </span><span style="color: #6F42C1">js</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> File.</span><span style="color: #6F42C1">ReadAllText</span><span style="color: #24292E">(</span><span style="color: #032F62">"..</span><span style="color: #005CC5">\\</span><span style="color: #032F62">..</span><span style="color: #005CC5">\\</span><span style="color: #032F62">..</span><span style="color: #005CC5">\\</span><span style="color: #032F62">..</span><span style="color: #005CC5">\\</span><span style="color: #032F62">..</span><span style="color: #005CC5">\\</span><span style="color: #032F62">demo</span><span style="color: #005CC5">\\</span><span style="color: #032F62">dist</span><span style="color: #005CC5">\\</span><span style="color: #032F62">bundle.js"</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">engine.DocumentSettings.</span><span style="color: #6F42C1">AddSystemDocument</span><span style="color: #24292E">(</span><span style="color: #032F62">"bundle"</span><span style="color: #24292E">, ModuleCategory.Standard, js);</span></span>
<span class="line"><span style="color: #D73A49">dynamic</span><span style="color: #24292E"> </span><span style="color: #6F42C1">exports</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> engine.</span><span style="color: #6F42C1">Evaluate</span><span style="color: #24292E">(</span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #6F42C1">DocumentInfo</span><span style="color: #24292E"> { Category </span><span style="color: #D73A49">=</span><span style="color: #24292E"> ModuleCategory.Standard }, </span><span style="color: #032F62">"import * as exports from 'bundle'; exports"</span><span style="color: #24292E">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">Console.</span><span style="color: #6F42C1">WriteLine</span><span style="color: #24292E">(</span><span style="color: #032F62">"Open your debugger and hit enter"</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">Console.</span><span style="color: #6F42C1">ReadLine</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">exports.</span><span style="color: #6F42C1">run</span><span style="color: #24292E">();</span></span></code></pre><pre data-language="csharp" data-theme="dark"><code data-language="csharp" data-theme="dark"><span class="line"><span style="color: #6A737D">// Program.cs</span></span>
<span class="line"><span style="color: #F97583">using</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Microsoft</span><span style="color: #E1E4E8">.</span><span style="color: #B392F0">ClearScript</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #F97583">using</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Microsoft</span><span style="color: #E1E4E8">.</span><span style="color: #B392F0">ClearScript</span><span style="color: #E1E4E8">.</span><span style="color: #B392F0">JavaScript</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #F97583">using</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Microsoft</span><span style="color: #E1E4E8">.</span><span style="color: #B392F0">ClearScript</span><span style="color: #E1E4E8">.</span><span style="color: #B392F0">V8</span><span style="color: #E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">var</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">engine</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">V8ScriptEngine</span><span style="color: #E1E4E8">(V8ScriptEngineFlags.EnableDebugging, </span><span style="color: #79B8FF">9222</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #F97583">dynamic</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">setupConsole</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> engine.</span><span style="color: #B392F0">Evaluate</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"writeLine => console = { log: message => writeLine(message) }"</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #B392F0">setupConsole</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Action</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #F97583">string</span><span style="color: #E1E4E8">>(Console.WriteLine));</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">var</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">js</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> File.</span><span style="color: #B392F0">ReadAllText</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"..</span><span style="color: #79B8FF">\\</span><span style="color: #9ECBFF">..</span><span style="color: #79B8FF">\\</span><span style="color: #9ECBFF">..</span><span style="color: #79B8FF">\\</span><span style="color: #9ECBFF">..</span><span style="color: #79B8FF">\\</span><span style="color: #9ECBFF">..</span><span style="color: #79B8FF">\\</span><span style="color: #9ECBFF">demo</span><span style="color: #79B8FF">\\</span><span style="color: #9ECBFF">dist</span><span style="color: #79B8FF">\\</span><span style="color: #9ECBFF">bundle.js"</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #E1E4E8">engine.DocumentSettings.</span><span style="color: #B392F0">AddSystemDocument</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"bundle"</span><span style="color: #E1E4E8">, ModuleCategory.Standard, js);</span></span>
<span class="line"><span style="color: #F97583">dynamic</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">exports</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> engine.</span><span style="color: #B392F0">Evaluate</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">DocumentInfo</span><span style="color: #E1E4E8"> { Category </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> ModuleCategory.Standard }, </span><span style="color: #9ECBFF">"import * as exports from 'bundle'; exports"</span><span style="color: #E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">Console.</span><span style="color: #B392F0">WriteLine</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"Open your debugger and hit enter"</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #E1E4E8">Console.</span><span style="color: #B392F0">ReadLine</span><span style="color: #E1E4E8">();</span></span>
<span class="line"><span style="color: #E1E4E8">exports.</span><span style="color: #B392F0">run</span><span style="color: #E1E4E8">();</span></span></code></pre></div>
<ul>
<li><strong>Line 6</strong>: Set up the ClearScript V8 with <code>ScriptEngineFlags.EnableDebugging</code>, which starts a listener on port <code>9222</code>, the standard port for debugging Node.js.</li>
<li><strong>Lines 7-8</strong>: Create the global <code>console</code> object so that <code>console.log</code> will <code>Console.WriteLine</code>. Note that we could have also used <code>engine.AddHostObject("console", ...)</code> to create the <code>console</code> object, but this would have also exposed the standard <code>System.Object</code> members such as <code>GetHashCode</code> to the script. We prefer not having those as part of our API that we provide to our customizers.</li>
<li><strong>Lines 10-12</strong>: Load the previously generated bundle and then import and export it in an inline code block so that it can be marshaled with a CLR object <code>dynamic exports</code>.</li>
<li><strong>Lines 14-16</strong>: Wait for a debugger to attach to the listener. Depending on the debugger, it may take a second or two. Once the debugger has been attached, the user should hit ENTER, and then the <code>run()</code> function exported by our TypeScript module will be executed.</li>
</ul>
<h2 id="debug-the-script"><a href="#debug-the-script">Debug the script</a></h2>
<p>Finally, let's try debugging:</p>
<ol>
<li>Open up Edge Remote Targets by browsing to <code>edge://inspect</code>.</li>
<li>Run the .NET console app.</li>
<li>Wait for Edge to locate the listener and then click <code>inspect</code>.</li>
<li>Hit ENTER in the console app.</li>
<li>Wait for Edge DevTools debugger to attach to the process.</li>
</ol>
<p>Then, the debugger in Edge DevTools will break at the <code>debugger</code> statement of the original TypeScript code! <em>And</em> the inspected function has the <code>: number</code> return type üòé.</p>
<p><img src="/debuggable-scripting-edge.png" alt=""></p>
<h2 id="considerations"><a href="#considerations">Considerations</a></h2>
<p>As we can see, ClearScript supports the desired flow. However, as explained earlier, there are some caveats too. Besides the mentioned risks in executing untrusted code, one has to be aware that V8 is not Node.js and therefore ClearScript doesn't include Node's event loop. This means that the hypothetical script host would be single-threaded per <code>V8ScriptEngine</code> instance (and each instance has a non-trivial memory overhead). But one could work around this to some extent by <a href="https://github.com/Microsoft/ClearScript/issues/53#issuecomment-387387543">pooling <code>V8ScriptEngine</code> instances</a>.</p>
<p>Also, in a real-life debugging scenario, the customizer would use <em>remote debugging</em>, which is enabled in ClearScript with the <code>V8ScriptEngineFlags.EnableRemoteDebugging</code> flag. This naturally exposes new attack vectors that must be addressed appropriately. <a href="https://nodejs.org/en/docs/guides/debugging-getting-started/#enabling-remote-debugging-scenarios">The official Node.js guide for remote debugging</a> is a good starting point.</p>b:["$","div",null,{"className":"flex justify-center","children":["$","div",null,{"className":"md:px-10 min-w-0 max-w-7xl mb-12","children":["$","article",null,{"children":[["$","header",null,{"className":"px-5 mb-4 py-10 relative","children":[["$","h1",null,{"className":"text-3xl leading-none tracking-tight text-gray-900 md:text-4xl lg:text-5xl dark:text-gray-100","children":"Debuggable Scripting with TypeScript and ClearScript"}],["$","time",null,{"dateTime":"2022-11-28 21:00","className":"pl-1 font-serif text-slate-400 bottom-0 absolute","children":[["$","svg",null,{"className":"h-4 w-4 inline-block","width":"24","height":"24","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 24 24","fill":"none","stroke":"currentColor","strokeWidth":"2","strokeLinecap":"round","strokeLinejoin":"round","children":[["$","path",null,{"d":"M12 19l7-7 3 3-7 7-3-3z"}]," ",["$","path",null,{"d":"M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"}]," ",["$","path",null,{"d":"M2 2l7.586 7.586"}]," ",["$","circle",null,{"cx":"11","cy":"11","r":"2"}]]}]," ","2022-11-28 21:00"]}]]}],["$","div",null,{"className":"bg-slate-100 dark:bg-slate-800 p-5 pb-12 rounded shadow-lg","children":[[["$","p",null,{"className":"italic text-slate-400 p-4","dangerouslySetInnerHTML":{"__html":"The code samples provided in this blog post are available at <a href=\"https://github.com/iotalambda/ClearScriptV8Poc\">ClearScriptV8Poc</a>."}}],["$","hr",null,{"className":"h-px my-4 bg-gray-200 border-0 dark:bg-gray-700"}]],["$","div",null,{"className":"space-y-4","dangerouslySetInnerHTML":{"__html":"$c"}}]]}]]}]}]}]
a:null
