<!DOCTYPE html><html lang="en" class="__variable_965427 __variable_9c011f"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" as="font" href="/_next/static/media/3d9ea938b6afa941-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="preload" as="font" href="/_next/static/media/7eaa4a2482b4df1a-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/_next/static/css/488301a2e2aae266.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/301e7291452e98cd.css" data-precedence="next"/><link rel="preload" href="/_next/static/chunks/webpack-b2aba447c1dc2205.js" as="script" fetchPriority="low"/><script src="/_next/static/chunks/fd9d1056-a99b58d3cc150217.js" async=""></script><script src="/_next/static/chunks/596-9d43875837bd0b65.js" async=""></script><script src="/_next/static/chunks/main-app-40cca1cf35ae5286.js" async=""></script><title>Debuggable Scripting with TypeScript and ClearScript | Food for AI blog</title><meta name="description" content="Blog about .NET, Azure, React and whatever comes to mind."/><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="16x16"/><meta name="next-size-adjust"/><script src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js" noModule=""></script></head><body class="bg-slate-200 dark:bg-slate-700"><nav class="w-full flex flex-row justify-between bg-indigo-600 shadow-indigo-300 dark:shadow-indigo-800 shadow-2xl font-sans"><div class="p-2"><a class="text-2xl font-semibold text-neutral-100 dark:text-neutral-200" href="/"><h1 class="inline">üçî food for ai</h1> <span class="font-mono font-light text-xs">food.joona.cloud</span></a></div></nav><main class="mt-4"><div class="flex justify-center"><div class="md:px-10 min-w-0 max-w-7xl mb-12"><article><header class="px-5 mb-4 py-10 relative"><h1 class="text-3xl leading-none tracking-tight text-gray-900 md:text-4xl lg:text-5xl dark:text-gray-100">Debuggable Scripting with TypeScript and ClearScript</h1><time dateTime="2022-11-28 21:00" class="pl-1 font-serif text-slate-400 bottom-0 absolute"><svg class="h-4 w-4 inline-block" width="24" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"></path> <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path> <path d="M2 2l7.586 7.586"></path> <circle cx="11" cy="11" r="2"></circle></svg> <!-- -->2022-11-28 21:00</time></header><div class="bg-slate-100 dark:bg-slate-800 p-5 pb-12 rounded shadow-lg"><p class="italic text-slate-400 p-4">The code samples provided in this blog post are available at <a href="https://github.com/iotalambda/ClearScriptV8Poc">ClearScriptV8Poc</a>.</p><hr class="h-px my-4 bg-gray-200 border-0 dark:bg-gray-700"/><div class="space-y-4"><p>When a system grows, you may want to consider supporting scripting for more dynamic and advanced customization. Ideally, an untrusted developer or customizer should be able to upload a script to the system, which becomes part of the final flow of execution.</p>
<p>Although JavaScript is a popular choice for a scripting language, when there are complex contracts that the customizer must comply with and rely on, having types can save you from a world of pain. It wouldn't be too much to ask if we required our customizers to use TypeScript instead.</p>
<p>Besides types and choosing a language, it is also necessary to offer the customizers a way to debug their scripts, especially once the script logic has evolved into a no-longer-trivial state. In this blog post, we will explore a way to potentially achieve this:</p>
<ul>
<li><strong>Use TypeScript as the scripting language</strong></li>
<li><strong>Use .NET and ClearScript to run the scripts</strong></li>
<li><strong>Use Edge DevTools for debugging them</strong></li>
</ul>
<p><a href="https://github.com/microsoft/ClearScript">ClearScript</a> is a seemingly well-supported .NET-based wrapper around V8, Google's JavaScript engine. This means that ClearScript supports ECMAScript just as much as V8 implements it. There are several other means for running JavaScript on .NET, such as <a href="https://github.com/sebastienros/jint">Jint</a>, which is a JavaScript interpreter and in many situations faster than ClearScript. However, in our scenario, we want to be able to leverage existing tooling around V8 such as debuggers supporting the <a href="https://v8.dev/docs/inspector">V8 Inspector Protocol</a>.</p>
<p>ClearScript does not implement Node APIs or Web APIs, which in itself offers us a relatively closed sandbox. However, a buggy or malicious script could still hog all the CPU and memory or simply run in a loop forever. These things are not discussed in this blog post, but they should be considered for a production-ready solution.</p>
<h2 id="create-a-script"><a href="#create-a-script">Create a script</a></h2>
<p>First, let's create a simple piece of TypeScript that we'd like to run on our hypothetical service:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="ts" data-theme="light"><code data-language="ts" data-theme="light"><span class="line"><span style="color: #6A737D">// index.ts</span></span>
<span class="line"><span style="color: #D73A49">export</span><span style="color: #24292E"> </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">run</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> ()</span><span style="color: #D73A49">:</span><span style="color: #24292E"> </span><span style="color: #005CC5">number</span><span style="color: #24292E"> </span><span style="color: #D73A49">=></span><span style="color: #24292E"> {</span></span>
<span class="line"><span style="color: #24292E">  console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #032F62">"Enter run"</span><span style="color: #24292E">)</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">let</span><span style="color: #24292E"> value </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">5</span></span>
<span class="line"><span style="color: #24292E">  console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #032F62">"Break"</span><span style="color: #24292E">)</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">debugger</span></span>
<span class="line"><span style="color: #24292E">  value </span><span style="color: #D73A49">+=</span><span style="color: #24292E"> </span><span style="color: #005CC5">2</span></span>
<span class="line"><span style="color: #24292E">  console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #032F62">"Exit run"</span><span style="color: #24292E">)</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> value</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre><pre data-language="ts" data-theme="dark"><code data-language="ts" data-theme="dark"><span class="line"><span style="color: #6A737D">// index.ts</span></span>
<span class="line"><span style="color: #F97583">export</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">run</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> ()</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">number</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=></span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"Enter run"</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">let</span><span style="color: #E1E4E8"> value </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">5</span></span>
<span class="line"><span style="color: #E1E4E8">  console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"Break"</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">debugger</span></span>
<span class="line"><span style="color: #E1E4E8">  value </span><span style="color: #F97583">+=</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">2</span></span>
<span class="line"><span style="color: #E1E4E8">  console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"Exit run"</span><span style="color: #E1E4E8">)</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> value</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre></div>
<p>Our sample here doesn't utilize the type system that much, but at least it has the return type <code>: number</code> set. That's enough for us for now. Also, we will use ES6-style modules for our purposes. Ideally, the customizer would create and publish a module as a package, and then our system would be able to import it.</p>
<p>Note that the script uses <code>console</code>, which is part of the Web API but not V8. Therefore, the platform that we will create must provide the global <code>console</code> object, or it will be <code>undefined</code>.</p>
<h2 id="build-the-script"><a href="#build-the-script">Build the script</a></h2>
<p>Next, let¬¥s add <code>tsconfig.json</code>:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="json" data-theme="light"><code data-language="json" data-theme="light"><span class="line"><span style="color: #6A737D">// tsconfig.json</span></span>
<span class="line"><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #005CC5">"compilerOptions"</span><span style="color: #24292E">: {</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #005CC5">"outDir"</span><span style="color: #24292E">: </span><span style="color: #032F62">"./dist/"</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #005CC5">"sourceMap"</span><span style="color: #24292E">: </span><span style="color: #005CC5">true</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #005CC5">"target"</span><span style="color: #24292E">: </span><span style="color: #032F62">"es5"</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #005CC5">"module"</span><span style="color: #24292E">: </span><span style="color: #032F62">"es6"</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #005CC5">"moduleResolution"</span><span style="color: #24292E">: </span><span style="color: #032F62">"node"</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre><pre data-language="json" data-theme="dark"><code data-language="json" data-theme="dark"><span class="line"><span style="color: #6A737D">// tsconfig.json</span></span>
<span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #79B8FF">"compilerOptions"</span><span style="color: #E1E4E8">: {</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">"outDir"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"./dist/"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">"sourceMap"</span><span style="color: #E1E4E8">: </span><span style="color: #79B8FF">true</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">"target"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"es5"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">"module"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"es6"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">"moduleResolution"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"node"</span></span>
<span class="line"><span style="color: #E1E4E8">  }</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre></div>
<p>The transpiled JavaScript should contain an ES6-style module. Notice that we enable <em>source map</em> file generation with <code>"sourceMap": true</code>. The source map files will contain a mapping between the TypeScript source code and the transpiled JavaScript "binary". V8 knows only JavaScript so source maps can be used to tell debuggers how the executed JavaScript is connected to the TypeScript source code. The output will essentially be two files: <code>index.js</code> and <code>index.js.map</code>, but both of them are immediately consumed by Webpack.</p>
<p>So Webpack is the build tool of our choice (could have used e.g. <code>esbuild</code> as well):</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="js" data-theme="light"><code data-language="js" data-theme="light"><span class="line"><span style="color: #6A737D">// webpack.config.js</span></span>
<span class="line"><span style="color: #D73A49">import</span><span style="color: #24292E"> path </span><span style="color: #D73A49">from</span><span style="color: #24292E"> </span><span style="color: #032F62">"path"</span></span>
<span class="line"><span style="color: #D73A49">import</span><span style="color: #24292E"> { fileURLToPath } </span><span style="color: #D73A49">from</span><span style="color: #24292E"> </span><span style="color: #032F62">"url"</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">__dirname</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> path.</span><span style="color: #6F42C1">dirname</span><span style="color: #24292E">(</span><span style="color: #6F42C1">fileURLToPath</span><span style="color: #24292E">(</span><span style="color: #D73A49">import</span><span style="color: #24292E">.</span><span style="color: #005CC5">meta</span><span style="color: #24292E">.url))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">export</span><span style="color: #24292E"> </span><span style="color: #D73A49">default</span><span style="color: #24292E"> {</span></span>
<span class="line"><span style="color: #24292E">  mode: </span><span style="color: #032F62">"development"</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">  entry: </span><span style="color: #032F62">"./src/index.ts"</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">  devtool: </span><span style="color: #032F62">"inline-source-map"</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">  module: {</span></span>
<span class="line"><span style="color: #24292E">    rules: [</span></span>
<span class="line"><span style="color: #24292E">      {</span></span>
<span class="line"><span style="color: #24292E">        test:</span><span style="color: #032F62"> /</span><span style="color: #22863A; font-weight: bold">\.</span><span style="color: #032F62">ts</span><span style="color: #D73A49">$</span><span style="color: #032F62">/</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">        use: </span><span style="color: #032F62">"ts-loader"</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">        exclude:</span><span style="color: #032F62"> /node_modules/</span></span>
<span class="line"><span style="color: #24292E">      }</span></span>
<span class="line"><span style="color: #24292E">    ]</span></span>
<span class="line"><span style="color: #24292E">  },</span></span>
<span class="line"><span style="color: #24292E">  resolve: {</span></span>
<span class="line"><span style="color: #24292E">    extensions: [</span><span style="color: #032F62">".ts"</span><span style="color: #24292E">, </span><span style="color: #032F62">".js"</span><span style="color: #24292E">]</span></span>
<span class="line"><span style="color: #24292E">  },</span></span>
<span class="line"><span style="color: #24292E">  output: {</span></span>
<span class="line"><span style="color: #24292E">    filename: </span><span style="color: #032F62">"bundle.js"</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">    path: path.</span><span style="color: #6F42C1">resolve</span><span style="color: #24292E">(__dirname, </span><span style="color: #032F62">"dist"</span><span style="color: #24292E">),</span></span>
<span class="line"><span style="color: #24292E">    library: {</span></span>
<span class="line"><span style="color: #24292E">      type: </span><span style="color: #032F62">"module"</span></span>
<span class="line"><span style="color: #24292E">    }</span></span>
<span class="line"><span style="color: #24292E">  },</span></span>
<span class="line"><span style="color: #24292E">  experiments: {</span></span>
<span class="line"><span style="color: #24292E">    outputModule: </span><span style="color: #005CC5">true</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre><pre data-language="js" data-theme="dark"><code data-language="js" data-theme="dark"><span class="line"><span style="color: #6A737D">// webpack.config.js</span></span>
<span class="line"><span style="color: #F97583">import</span><span style="color: #E1E4E8"> path </span><span style="color: #F97583">from</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"path"</span></span>
<span class="line"><span style="color: #F97583">import</span><span style="color: #E1E4E8"> { fileURLToPath } </span><span style="color: #F97583">from</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"url"</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">__dirname</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> path.</span><span style="color: #B392F0">dirname</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">fileURLToPath</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">import</span><span style="color: #E1E4E8">.</span><span style="color: #79B8FF">meta</span><span style="color: #E1E4E8">.url))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">export</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">default</span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  mode: </span><span style="color: #9ECBFF">"development"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">  entry: </span><span style="color: #9ECBFF">"./src/index.ts"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">  devtool: </span><span style="color: #9ECBFF">"inline-source-map"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">  module: {</span></span>
<span class="line"><span style="color: #E1E4E8">    rules: [</span></span>
<span class="line"><span style="color: #E1E4E8">      {</span></span>
<span class="line"><span style="color: #E1E4E8">        test:</span><span style="color: #DBEDFF"> </span><span style="color: #9ECBFF">/</span><span style="color: #85E89D; font-weight: bold">\.</span><span style="color: #DBEDFF">ts</span><span style="color: #F97583">$</span><span style="color: #9ECBFF">/</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        use: </span><span style="color: #9ECBFF">"ts-loader"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        exclude:</span><span style="color: #DBEDFF"> </span><span style="color: #9ECBFF">/</span><span style="color: #DBEDFF">node_modules</span><span style="color: #9ECBFF">/</span></span>
<span class="line"><span style="color: #E1E4E8">      }</span></span>
<span class="line"><span style="color: #E1E4E8">    ]</span></span>
<span class="line"><span style="color: #E1E4E8">  },</span></span>
<span class="line"><span style="color: #E1E4E8">  resolve: {</span></span>
<span class="line"><span style="color: #E1E4E8">    extensions: [</span><span style="color: #9ECBFF">".ts"</span><span style="color: #E1E4E8">, </span><span style="color: #9ECBFF">".js"</span><span style="color: #E1E4E8">]</span></span>
<span class="line"><span style="color: #E1E4E8">  },</span></span>
<span class="line"><span style="color: #E1E4E8">  output: {</span></span>
<span class="line"><span style="color: #E1E4E8">    filename: </span><span style="color: #9ECBFF">"bundle.js"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">    path: path.</span><span style="color: #B392F0">resolve</span><span style="color: #E1E4E8">(__dirname, </span><span style="color: #9ECBFF">"dist"</span><span style="color: #E1E4E8">),</span></span>
<span class="line"><span style="color: #E1E4E8">    library: {</span></span>
<span class="line"><span style="color: #E1E4E8">      type: </span><span style="color: #9ECBFF">"module"</span></span>
<span class="line"><span style="color: #E1E4E8">    }</span></span>
<span class="line"><span style="color: #E1E4E8">  },</span></span>
<span class="line"><span style="color: #E1E4E8">  experiments: {</span></span>
<span class="line"><span style="color: #E1E4E8">    outputModule: </span><span style="color: #79B8FF">true</span></span>
<span class="line"><span style="color: #E1E4E8">  }</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre></div>
<p>We use <code>ts-loader</code> to load the TypeScript files and finally output <code>bundle.js</code>, which exports a module. Notice the line <code>devtool: inline-source-map</code>: we bundle the previously generated <code>.js.map</code> files into <code>bundle.js</code> so that the debugger will later be able to catch the source map from <code>bundle.js</code>. We could have also used just <code>devtools: source-map</code> to generate a separate <code>bundle.js.map</code>, but we'll use the inline version for simplicity.</p>
<p>After running <code>npx webpack</code>, <code>bundle.js</code> is generated under <code>/dist/</code>, and the file contains the inline source maps as expected.</p>
<h2 id="implementing-the-host"><a href="#implementing-the-host">Implementing the host</a></h2>
<p>Next, let¬¥s create a ClearScript V8 host that will run the script:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="csharp" data-theme="light"><code data-language="csharp" data-theme="light"><span class="line"><span style="color: #6A737D">// Program.cs</span></span>
<span class="line"><span style="color: #D73A49">using</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Microsoft</span><span style="color: #24292E">.</span><span style="color: #6F42C1">ClearScript</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #D73A49">using</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Microsoft</span><span style="color: #24292E">.</span><span style="color: #6F42C1">ClearScript</span><span style="color: #24292E">.</span><span style="color: #6F42C1">JavaScript</span><span style="color: #24292E">;</span></span>
<span class="line"><span style="color: #D73A49">using</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Microsoft</span><span style="color: #24292E">.</span><span style="color: #6F42C1">ClearScript</span><span style="color: #24292E">.</span><span style="color: #6F42C1">V8</span><span style="color: #24292E">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">var</span><span style="color: #24292E"> </span><span style="color: #6F42C1">engine</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #6F42C1">V8ScriptEngine</span><span style="color: #24292E">(V8ScriptEngineFlags.EnableDebugging, </span><span style="color: #005CC5">9222</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #D73A49">dynamic</span><span style="color: #24292E"> </span><span style="color: #6F42C1">setupConsole</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> engine.</span><span style="color: #6F42C1">Evaluate</span><span style="color: #24292E">(</span><span style="color: #032F62">"writeLine => console = { log: message => writeLine(message) }"</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #6F42C1">setupConsole</span><span style="color: #24292E">(</span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Action</span><span style="color: #24292E">&#x3C;</span><span style="color: #D73A49">string</span><span style="color: #24292E">>(Console.WriteLine));</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">var</span><span style="color: #24292E"> </span><span style="color: #6F42C1">js</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> File.</span><span style="color: #6F42C1">ReadAllText</span><span style="color: #24292E">(</span><span style="color: #032F62">"..</span><span style="color: #005CC5">\\</span><span style="color: #032F62">..</span><span style="color: #005CC5">\\</span><span style="color: #032F62">..</span><span style="color: #005CC5">\\</span><span style="color: #032F62">..</span><span style="color: #005CC5">\\</span><span style="color: #032F62">..</span><span style="color: #005CC5">\\</span><span style="color: #032F62">demo</span><span style="color: #005CC5">\\</span><span style="color: #032F62">dist</span><span style="color: #005CC5">\\</span><span style="color: #032F62">bundle.js"</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">engine.DocumentSettings.</span><span style="color: #6F42C1">AddSystemDocument</span><span style="color: #24292E">(</span><span style="color: #032F62">"bundle"</span><span style="color: #24292E">, ModuleCategory.Standard, js);</span></span>
<span class="line"><span style="color: #D73A49">dynamic</span><span style="color: #24292E"> </span><span style="color: #6F42C1">exports</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> engine.</span><span style="color: #6F42C1">Evaluate</span><span style="color: #24292E">(</span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #6F42C1">DocumentInfo</span><span style="color: #24292E"> { Category </span><span style="color: #D73A49">=</span><span style="color: #24292E"> ModuleCategory.Standard }, </span><span style="color: #032F62">"import * as exports from 'bundle'; exports"</span><span style="color: #24292E">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">Console.</span><span style="color: #6F42C1">WriteLine</span><span style="color: #24292E">(</span><span style="color: #032F62">"Open your debugger and hit enter"</span><span style="color: #24292E">);</span></span>
<span class="line"><span style="color: #24292E">Console.</span><span style="color: #6F42C1">ReadLine</span><span style="color: #24292E">();</span></span>
<span class="line"><span style="color: #24292E">exports.</span><span style="color: #6F42C1">run</span><span style="color: #24292E">();</span></span></code></pre><pre data-language="csharp" data-theme="dark"><code data-language="csharp" data-theme="dark"><span class="line"><span style="color: #6A737D">// Program.cs</span></span>
<span class="line"><span style="color: #F97583">using</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Microsoft</span><span style="color: #E1E4E8">.</span><span style="color: #B392F0">ClearScript</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #F97583">using</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Microsoft</span><span style="color: #E1E4E8">.</span><span style="color: #B392F0">ClearScript</span><span style="color: #E1E4E8">.</span><span style="color: #B392F0">JavaScript</span><span style="color: #E1E4E8">;</span></span>
<span class="line"><span style="color: #F97583">using</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Microsoft</span><span style="color: #E1E4E8">.</span><span style="color: #B392F0">ClearScript</span><span style="color: #E1E4E8">.</span><span style="color: #B392F0">V8</span><span style="color: #E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">var</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">engine</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">V8ScriptEngine</span><span style="color: #E1E4E8">(V8ScriptEngineFlags.EnableDebugging, </span><span style="color: #79B8FF">9222</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #F97583">dynamic</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">setupConsole</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> engine.</span><span style="color: #B392F0">Evaluate</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"writeLine => console = { log: message => writeLine(message) }"</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #B392F0">setupConsole</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Action</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #F97583">string</span><span style="color: #E1E4E8">>(Console.WriteLine));</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">var</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">js</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> File.</span><span style="color: #B392F0">ReadAllText</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"..</span><span style="color: #79B8FF">\\</span><span style="color: #9ECBFF">..</span><span style="color: #79B8FF">\\</span><span style="color: #9ECBFF">..</span><span style="color: #79B8FF">\\</span><span style="color: #9ECBFF">..</span><span style="color: #79B8FF">\\</span><span style="color: #9ECBFF">..</span><span style="color: #79B8FF">\\</span><span style="color: #9ECBFF">demo</span><span style="color: #79B8FF">\\</span><span style="color: #9ECBFF">dist</span><span style="color: #79B8FF">\\</span><span style="color: #9ECBFF">bundle.js"</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #E1E4E8">engine.DocumentSettings.</span><span style="color: #B392F0">AddSystemDocument</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"bundle"</span><span style="color: #E1E4E8">, ModuleCategory.Standard, js);</span></span>
<span class="line"><span style="color: #F97583">dynamic</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">exports</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> engine.</span><span style="color: #B392F0">Evaluate</span><span style="color: #E1E4E8">(</span><span style="color: #F97583">new</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">DocumentInfo</span><span style="color: #E1E4E8"> { Category </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> ModuleCategory.Standard }, </span><span style="color: #9ECBFF">"import * as exports from 'bundle'; exports"</span><span style="color: #E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">Console.</span><span style="color: #B392F0">WriteLine</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"Open your debugger and hit enter"</span><span style="color: #E1E4E8">);</span></span>
<span class="line"><span style="color: #E1E4E8">Console.</span><span style="color: #B392F0">ReadLine</span><span style="color: #E1E4E8">();</span></span>
<span class="line"><span style="color: #E1E4E8">exports.</span><span style="color: #B392F0">run</span><span style="color: #E1E4E8">();</span></span></code></pre></div>
<ul>
<li><strong>Line 6</strong>: Set up the ClearScript V8 with <code>ScriptEngineFlags.EnableDebugging</code>, which starts a listener on port <code>9222</code>, the standard port for debugging Node.js.</li>
<li><strong>Lines 7-8</strong>: Create the global <code>console</code> object so that <code>console.log</code> will <code>Console.WriteLine</code>. Note that we could have also used <code>engine.AddHostObject("console", ...)</code> to create the <code>console</code> object, but this would have also exposed the standard <code>System.Object</code> members such as <code>GetHashCode</code> to the script. We prefer not having those as part of our API that we provide to our customizers.</li>
<li><strong>Lines 10-12</strong>: Load the previously generated bundle and then import and export it in an inline code block so that it can be marshaled with a CLR object <code>dynamic exports</code>.</li>
<li><strong>Lines 14-16</strong>: Wait for a debugger to attach to the listener. Depending on the debugger, it may take a second or two. Once the debugger has been attached, the user should hit ENTER, and then the <code>run()</code> function exported by our TypeScript module will be executed.</li>
</ul>
<h2 id="debug-the-script"><a href="#debug-the-script">Debug the script</a></h2>
<p>Finally, let's try debugging:</p>
<ol>
<li>Open up Edge Remote Targets by browsing to <code>edge://inspect</code>.</li>
<li>Run the .NET console app.</li>
<li>Wait for Edge to locate the listener and then click <code>inspect</code>.</li>
<li>Hit ENTER in the console app.</li>
<li>Wait for Edge DevTools debugger to attach to the process.</li>
</ol>
<p>Then, the debugger in Edge DevTools will break at the <code>debugger</code> statement of the original TypeScript code! <em>And</em> the inspected function has the <code>: number</code> return type üòé.</p>
<p><img src="/debuggable-scripting-edge.png" alt=""></p>
<h2 id="considerations"><a href="#considerations">Considerations</a></h2>
<p>As we can see, ClearScript supports the desired flow. However, as explained earlier, there are some caveats too. Besides the mentioned risks in executing untrusted code, one has to be aware that V8 is not Node.js and therefore ClearScript doesn't include Node's event loop. This means that the hypothetical script host would be single-threaded per <code>V8ScriptEngine</code> instance (and each instance has a non-trivial memory overhead). But one could work around this to some extent by <a href="https://github.com/Microsoft/ClearScript/issues/53#issuecomment-387387543">pooling <code>V8ScriptEngine</code> instances</a>.</p>
<p>Also, in a real-life debugging scenario, the customizer would use <em>remote debugging</em>, which is enabled in ClearScript with the <code>V8ScriptEngineFlags.EnableRemoteDebugging</code> flag. This naturally exposes new attack vectors that must be addressed appropriately. <a href="https://nodejs.org/en/docs/guides/debugging-getting-started/#enabling-remote-debugging-scenarios">The official Node.js guide for remote debugging</a> is a good starting point.</p></div></div></article></div></div></main><script src="/_next/static/chunks/webpack-b2aba447c1dc2205.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/media/3d9ea938b6afa941-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n2:HL[\"/_next/static/media/7eaa4a2482b4df1a-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n3:HL[\"/_next/static/css/488301a2e2aae266.css\",{\"as\":\"style\"}]\n0:\"$L4\"\n"])</script><script>self.__next_f.push([1,"5:HL[\"/_next/static/css/301e7291452e98cd.css\",{\"as\":\"style\"}]\n"])</script><script>self.__next_f.push([1,"6:I{\"id\":7948,\"chunks\":[\"272:static/chunks/webpack-b2aba447c1dc2205.js\",\"971:static/chunks/fd9d1056-a99b58d3cc150217.js\",\"596:static/chunks/596-9d43875837bd0b65.js\"],\"name\":\"default\",\"async\":false}\n8:I{\"id\":6628,\"chunks\":[\"272:static/chunks/webpack-b2aba447c1dc2205.js\",\"971:static/chunks/fd9d1056-a99b58d3cc150217.js\",\"596:static/chunks/596-9d43875837bd0b65.js\"],\"name\":\"\",\"async\":false}\n9:I{\"id\":6685,\"chunks\":[\"685:static/chunks/685-a8c11ad368fada34.js\",\"185:static/chunks/app/layout-0afbb0e01943be7f.js\"],\"na"])</script><script>self.__next_f.push([1,"me\":\"\",\"async\":false}\na:I{\"id\":7767,\"chunks\":[\"272:static/chunks/webpack-b2aba447c1dc2205.js\",\"971:static/chunks/fd9d1056-a99b58d3cc150217.js\",\"596:static/chunks/596-9d43875837bd0b65.js\"],\"name\":\"default\",\"async\":false}\nb:I{\"id\":7920,\"chunks\":[\"272:static/chunks/webpack-b2aba447c1dc2205.js\",\"971:static/chunks/fd9d1056-a99b58d3cc150217.js\",\"596:static/chunks/596-9d43875837bd0b65.js\"],\"name\":\"default\",\"async\":false}\n"])</script><script>self.__next_f.push([1,"4:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/488301a2e2aae266.css\",\"precedence\":\"next\"}]],[\"$\",\"$L6\",null,{\"buildId\":\"7qqd27EZmvDSdxWKQ8e4J\",\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/2022/11/28/Debuggable-Scripting-with-TypeScript-and-ClearScript\",\"initialTree\":[\"\",{\"children\":[[\"id\",\"2022/11/28/Debuggable-Scripting-with-TypeScript-and-ClearScript\",\"c\"],{\"children\":[\"__PAGE__?{\\\"id\\\":[\\\"2022\\\",\\\"11\\\",\\\"28\\\",\\\"Debuggable-Scripting-with-TypeScript-and-ClearScript\\\"]}\",{}]}]},\"$undefined\",\"$undefined\",true],\"initialHead\":[false,\"$L7\"],\"globalErrorComponent\":\"$8\",\"children\":[null,[\"$\",\"html\",null,{\"lang\":\"en\",\"className\":\"__variable_965427 __variable_9c011f\",\"children\":[\"$\",\"body\",null,{\"className\":\"bg-slate-200 dark:bg-slate-700\",\"children\":[[\"$\",\"nav\",null,{\"className\":\"w-full flex flex-row justify-between bg-indigo-600 shadow-indigo-300 dark:shadow-indigo-800 shadow-2xl font-sans\",\"children\":[\"$\",\"div\",null,{\"className\":\"p-2\",\"children\":[\"$\",\"$L9\",null,{\"className\":\"text-2xl font-semibold text-neutral-100 dark:text-neutral-200\",\"href\":\"/\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"inline\",\"children\":\"üçî food for ai\"}],\" \",[\"$\",\"span\",null,{\"className\":\"font-mono font-light text-xs\",\"children\":\"food.joona.cloud\"}]]}]}]}],[\"$\",\"main\",null,{\"className\":\"mt-4\",\"children\":[\"$\",\"$La\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[],\"childProp\":{\"current\":[\"$\",\"$La\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",[\"id\",\"2022/11/28/Debuggable-Scripting-with-TypeScript-and-ClearScript\",\"c\"],\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$Lc\",\"$Ld\",null],\"segment\":\"__PAGE__?{\\\"id\\\":[\\\"2022\\\",\\\"11\\\",\\\"28\\\",\\\"Debuggable-Scripting-with-TypeScript-and-ClearScript\\\"]}\"},\"styles\":[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/301e7291452e98cd.css\",\"precedence\":\"next\"}]]}],\"segment\":[\"id\",\"2022/11/28/Debuggable-Scripting-with-TypeScript-and-ClearScript\",\"c\"]},\"styles\":[]}]}]]}]}],null]}]]\n"])</script><script>self.__next_f.push([1,"e:T889d,"])</script><script>self.__next_f.push([1,"\u003cp\u003eWhen a system grows, you may want to consider supporting scripting for more dynamic and advanced customization. Ideally, an untrusted developer or customizer should be able to upload a script to the system, which becomes part of the final flow of execution.\u003c/p\u003e\n\u003cp\u003eAlthough JavaScript is a popular choice for a scripting language, when there are complex contracts that the customizer must comply with and rely on, having types can save you from a world of pain. It wouldn't be too much to ask if we required our customizers to use TypeScript instead.\u003c/p\u003e\n\u003cp\u003eBesides types and choosing a language, it is also necessary to offer the customizers a way to debug their scripts, especially once the script logic has evolved into a no-longer-trivial state. In this blog post, we will explore a way to potentially achieve this:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eUse TypeScript as the scripting language\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUse .NET and ClearScript to run the scripts\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eUse Edge DevTools for debugging them\u003c/strong\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/microsoft/ClearScript\"\u003eClearScript\u003c/a\u003e is a seemingly well-supported .NET-based wrapper around V8, Google's JavaScript engine. This means that ClearScript supports ECMAScript just as much as V8 implements it. There are several other means for running JavaScript on .NET, such as \u003ca href=\"https://github.com/sebastienros/jint\"\u003eJint\u003c/a\u003e, which is a JavaScript interpreter and in many situations faster than ClearScript. However, in our scenario, we want to be able to leverage existing tooling around V8 such as debuggers supporting the \u003ca href=\"https://v8.dev/docs/inspector\"\u003eV8 Inspector Protocol\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eClearScript does not implement Node APIs or Web APIs, which in itself offers us a relatively closed sandbox. However, a buggy or malicious script could still hog all the CPU and memory or simply run in a loop forever. These things are not discussed in this blog post, but they should be considered for a production-ready solution.\u003c/p\u003e\n\u003ch2 id=\"create-a-script\"\u003e\u003ca href=\"#create-a-script\"\u003eCreate a script\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eFirst, let's create a simple piece of TypeScript that we'd like to run on our hypothetical service:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre data-language=\"ts\" data-theme=\"light\"\u003e\u003ccode data-language=\"ts\" data-theme=\"light\"\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #6A737D\"\u003e// index.ts\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D73A49\"\u003eexport\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003econst\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003erun\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e ()\u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e:\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003enumber\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e=\u003e\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  console.\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003elog\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e\"Enter run\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003elet\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e value \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003e5\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  console.\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003elog\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e\"Break\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003edebugger\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  value \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e+=\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003e2\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  console.\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003elog\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e\"Exit run\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003ereturn\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e value\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cpre data-language=\"ts\" data-theme=\"dark\"\u003e\u003ccode data-language=\"ts\" data-theme=\"dark\"\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #6A737D\"\u003e// index.ts\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #F97583\"\u003eexport\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003econst\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003erun\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e ()\u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e:\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003enumber\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e=\u003e\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  console.\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003elog\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e\"Enter run\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003elet\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e value \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003e5\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  console.\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003elog\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e\"Break\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003edebugger\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  value \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e+=\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003e2\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  console.\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003elog\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e\"Exit run\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003ereturn\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e value\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eOur sample here doesn't utilize the type system that much, but at least it has the return type \u003ccode\u003e: number\u003c/code\u003e set. That's enough for us for now. Also, we will use ES6-style modules for our purposes. Ideally, the customizer would create and publish a module as a package, and then our system would be able to import it.\u003c/p\u003e\n\u003cp\u003eNote that the script uses \u003ccode\u003econsole\u003c/code\u003e, which is part of the Web API but not V8. Therefore, the platform that we will create must provide the global \u003ccode\u003econsole\u003c/code\u003e object, or it will be \u003ccode\u003eundefined\u003c/code\u003e.\u003c/p\u003e\n\u003ch2 id=\"build-the-script\"\u003e\u003ca href=\"#build-the-script\"\u003eBuild the script\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eNext, let¬¥s add \u003ccode\u003etsconfig.json\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre data-language=\"json\" data-theme=\"light\"\u003e\u003ccode data-language=\"json\" data-theme=\"light\"\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #6A737D\"\u003e// tsconfig.json\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003e\"compilerOptions\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e: {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003e\"outDir\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e\"./dist/\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003e\"sourceMap\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003etrue\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003e\"target\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e\"es5\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003e\"module\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e\"es6\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003e\"moduleResolution\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e\"node\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cpre data-language=\"json\" data-theme=\"dark\"\u003e\u003ccode data-language=\"json\" data-theme=\"dark\"\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #6A737D\"\u003e// tsconfig.json\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003e\"compilerOptions\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e: {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003e\"outDir\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e\"./dist/\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003e\"sourceMap\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003etrue\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003e\"target\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e\"es5\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003e\"module\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e\"es6\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003e\"moduleResolution\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e\"node\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe transpiled JavaScript should contain an ES6-style module. Notice that we enable \u003cem\u003esource map\u003c/em\u003e file generation with \u003ccode\u003e\"sourceMap\": true\u003c/code\u003e. The source map files will contain a mapping between the TypeScript source code and the transpiled JavaScript \"binary\". V8 knows only JavaScript so source maps can be used to tell debuggers how the executed JavaScript is connected to the TypeScript source code. The output will essentially be two files: \u003ccode\u003eindex.js\u003c/code\u003e and \u003ccode\u003eindex.js.map\u003c/code\u003e, but both of them are immediately consumed by Webpack.\u003c/p\u003e\n\u003cp\u003eSo Webpack is the build tool of our choice (could have used e.g. \u003ccode\u003eesbuild\u003c/code\u003e as well):\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre data-language=\"js\" data-theme=\"light\"\u003e\u003ccode data-language=\"js\" data-theme=\"light\"\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #6A737D\"\u003e// webpack.config.js\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D73A49\"\u003eimport\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e path \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003efrom\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e\"path\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D73A49\"\u003eimport\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e { fileURLToPath } \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003efrom\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e\"url\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D73A49\"\u003econst\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003e__dirname\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e path.\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003edirname\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003efileURLToPath\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003eimport\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003emeta\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e.url))\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D73A49\"\u003eexport\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003edefault\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  mode: \u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e\"development\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  entry: \u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e\"./src/index.ts\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  devtool: \u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e\"inline-source-map\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  module: {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e    rules: [\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e      {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e        test:\u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e /\u003c/span\u003e\u003cspan style=\"color: #22863A; font-weight: bold\"\u003e\\.\u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003ets\u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e$\u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e/\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e        use: \u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e\"ts-loader\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e        exclude:\u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e /node_modules/\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e      }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e    ]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  },\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  resolve: {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e    extensions: [\u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e\".ts\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e, \u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e\".js\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  },\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  output: {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e    filename: \u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e\"bundle.js\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e    path: path.\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eresolve\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(__dirname, \u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e\"dist\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e    library: {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e      type: \u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e\"module\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  },\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  experiments: {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e    outputModule: \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003etrue\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cpre data-language=\"js\" data-theme=\"dark\"\u003e\u003ccode data-language=\"js\" data-theme=\"dark\"\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #6A737D\"\u003e// webpack.config.js\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #F97583\"\u003eimport\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e path \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003efrom\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e\"path\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #F97583\"\u003eimport\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e { fileURLToPath } \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003efrom\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e\"url\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #F97583\"\u003econst\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003e__dirname\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e path.\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003edirname\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003efileURLToPath\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003eimport\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003emeta\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e.url))\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #F97583\"\u003eexport\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003edefault\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  mode: \u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e\"development\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  entry: \u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e\"./src/index.ts\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  devtool: \u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e\"inline-source-map\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  module: {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e    rules: [\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e      {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e        test:\u003c/span\u003e\u003cspan style=\"color: #DBEDFF\"\u003e \u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e/\u003c/span\u003e\u003cspan style=\"color: #85E89D; font-weight: bold\"\u003e\\.\u003c/span\u003e\u003cspan style=\"color: #DBEDFF\"\u003ets\u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e$\u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e/\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e        use: \u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e\"ts-loader\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e        exclude:\u003c/span\u003e\u003cspan style=\"color: #DBEDFF\"\u003e \u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e/\u003c/span\u003e\u003cspan style=\"color: #DBEDFF\"\u003enode_modules\u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e/\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e      }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e    ]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  },\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  resolve: {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e    extensions: [\u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e\".ts\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e, \u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e\".js\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  },\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  output: {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e    filename: \u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e\"bundle.js\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e    path: path.\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eresolve\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(__dirname, \u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e\"dist\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e    library: {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e      type: \u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e\"module\"\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  },\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  experiments: {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e    outputModule: \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003etrue\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eWe use \u003ccode\u003ets-loader\u003c/code\u003e to load the TypeScript files and finally output \u003ccode\u003ebundle.js\u003c/code\u003e, which exports a module. Notice the line \u003ccode\u003edevtool: inline-source-map\u003c/code\u003e: we bundle the previously generated \u003ccode\u003e.js.map\u003c/code\u003e files into \u003ccode\u003ebundle.js\u003c/code\u003e so that the debugger will later be able to catch the source map from \u003ccode\u003ebundle.js\u003c/code\u003e. We could have also used just \u003ccode\u003edevtools: source-map\u003c/code\u003e to generate a separate \u003ccode\u003ebundle.js.map\u003c/code\u003e, but we'll use the inline version for simplicity.\u003c/p\u003e\n\u003cp\u003eAfter running \u003ccode\u003enpx webpack\u003c/code\u003e, \u003ccode\u003ebundle.js\u003c/code\u003e is generated under \u003ccode\u003e/dist/\u003c/code\u003e, and the file contains the inline source maps as expected.\u003c/p\u003e\n\u003ch2 id=\"implementing-the-host\"\u003e\u003ca href=\"#implementing-the-host\"\u003eImplementing the host\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eNext, let¬¥s create a ClearScript V8 host that will run the script:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre data-language=\"csharp\" data-theme=\"light\"\u003e\u003ccode data-language=\"csharp\" data-theme=\"light\"\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #6A737D\"\u003e// Program.cs\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D73A49\"\u003eusing\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eMicrosoft\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eClearScript\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D73A49\"\u003eusing\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eMicrosoft\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eClearScript\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eJavaScript\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D73A49\"\u003eusing\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eMicrosoft\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eClearScript\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eV8\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D73A49\"\u003evar\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eengine\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003enew\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eV8ScriptEngine\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(V8ScriptEngineFlags.EnableDebugging, \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003e9222\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D73A49\"\u003edynamic\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003esetupConsole\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e engine.\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eEvaluate\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e\"writeLine =\u003e console = { log: message =\u003e writeLine(message) }\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #6F42C1\"\u003esetupConsole\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003enew\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eAction\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003estring\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e\u003e(Console.WriteLine));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D73A49\"\u003evar\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003ejs\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e File.\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eReadAllText\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e\"..\u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003e\\\\\u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e..\u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003e\\\\\u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e..\u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003e\\\\\u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e..\u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003e\\\\\u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e..\u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003e\\\\\u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003edemo\u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003e\\\\\u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003edist\u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003e\\\\\u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003ebundle.js\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003eengine.DocumentSettings.\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eAddSystemDocument\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e\"bundle\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e, ModuleCategory.Standard, js);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D73A49\"\u003edynamic\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eexports\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e engine.\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eEvaluate\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003enew\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eDocumentInfo\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e { Category \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e ModuleCategory.Standard }, \u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e\"import * as exports from 'bundle'; exports\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003eConsole.\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eWriteLine\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e\"Open your debugger and hit enter\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003eConsole.\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eReadLine\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003eexports.\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003erun\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cpre data-language=\"csharp\" data-theme=\"dark\"\u003e\u003ccode data-language=\"csharp\" data-theme=\"dark\"\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #6A737D\"\u003e// Program.cs\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #F97583\"\u003eusing\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eMicrosoft\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eClearScript\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #F97583\"\u003eusing\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eMicrosoft\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eClearScript\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eJavaScript\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #F97583\"\u003eusing\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eMicrosoft\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eClearScript\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e.\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eV8\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #F97583\"\u003evar\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eengine\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003enew\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eV8ScriptEngine\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(V8ScriptEngineFlags.EnableDebugging, \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003e9222\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #F97583\"\u003edynamic\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003esetupConsole\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e engine.\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eEvaluate\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e\"writeLine =\u003e console = { log: message =\u003e writeLine(message) }\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #B392F0\"\u003esetupConsole\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003enew\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eAction\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003estring\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e\u003e(Console.WriteLine));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #F97583\"\u003evar\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003ejs\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e File.\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eReadAllText\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e\"..\u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003e\\\\\u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e..\u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003e\\\\\u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e..\u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003e\\\\\u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e..\u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003e\\\\\u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e..\u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003e\\\\\u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003edemo\u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003e\\\\\u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003edist\u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003e\\\\\u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003ebundle.js\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003eengine.DocumentSettings.\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eAddSystemDocument\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e\"bundle\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e, ModuleCategory.Standard, js);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #F97583\"\u003edynamic\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eexports\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e engine.\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eEvaluate\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003enew\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eDocumentInfo\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e { Category \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e ModuleCategory.Standard }, \u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e\"import * as exports from 'bundle'; exports\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003eConsole.\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eWriteLine\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e\"Open your debugger and hit enter\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003eConsole.\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eReadLine\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003eexports.\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003erun\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e();\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eLine 6\u003c/strong\u003e: Set up the ClearScript V8 with \u003ccode\u003eScriptEngineFlags.EnableDebugging\u003c/code\u003e, which starts a listener on port \u003ccode\u003e9222\u003c/code\u003e, the standard port for debugging Node.js.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eLines 7-8\u003c/strong\u003e: Create the global \u003ccode\u003econsole\u003c/code\u003e object so that \u003ccode\u003econsole.log\u003c/code\u003e will \u003ccode\u003eConsole.WriteLine\u003c/code\u003e. Note that we could have also used \u003ccode\u003eengine.AddHostObject(\"console\", ...)\u003c/code\u003e to create the \u003ccode\u003econsole\u003c/code\u003e object, but this would have also exposed the standard \u003ccode\u003eSystem.Object\u003c/code\u003e members such as \u003ccode\u003eGetHashCode\u003c/code\u003e to the script. We prefer not having those as part of our API that we provide to our customizers.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eLines 10-12\u003c/strong\u003e: Load the previously generated bundle and then import and export it in an inline code block so that it can be marshaled with a CLR object \u003ccode\u003edynamic exports\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eLines 14-16\u003c/strong\u003e: Wait for a debugger to attach to the listener. Depending on the debugger, it may take a second or two. Once the debugger has been attached, the user should hit ENTER, and then the \u003ccode\u003erun()\u003c/code\u003e function exported by our TypeScript module will be executed.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"debug-the-script\"\u003e\u003ca href=\"#debug-the-script\"\u003eDebug the script\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eFinally, let's try debugging:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eOpen up Edge Remote Targets by browsing to \u003ccode\u003eedge://inspect\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eRun the .NET console app.\u003c/li\u003e\n\u003cli\u003eWait for Edge to locate the listener and then click \u003ccode\u003einspect\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eHit ENTER in the console app.\u003c/li\u003e\n\u003cli\u003eWait for Edge DevTools debugger to attach to the process.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eThen, the debugger in Edge DevTools will break at the \u003ccode\u003edebugger\u003c/code\u003e statement of the original TypeScript code! \u003cem\u003eAnd\u003c/em\u003e the inspected function has the \u003ccode\u003e: number\u003c/code\u003e return type üòé.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/debuggable-scripting-edge.png\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch2 id=\"considerations\"\u003e\u003ca href=\"#considerations\"\u003eConsiderations\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eAs we can see, ClearScript supports the desired flow. However, as explained earlier, there are some caveats too. Besides the mentioned risks in executing untrusted code, one has to be aware that V8 is not Node.js and therefore ClearScript doesn't include Node's event loop. This means that the hypothetical script host would be single-threaded per \u003ccode\u003eV8ScriptEngine\u003c/code\u003e instance (and each instance has a non-trivial memory overhead). But one could work around this to some extent by \u003ca href=\"https://github.com/Microsoft/ClearScript/issues/53#issuecomment-387387543\"\u003epooling \u003ccode\u003eV8ScriptEngine\u003c/code\u003e instances\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eAlso, in a real-life debugging scenario, the customizer would use \u003cem\u003eremote debugging\u003c/em\u003e, which is enabled in ClearScript with the \u003ccode\u003eV8ScriptEngineFlags.EnableRemoteDebugging\u003c/code\u003e flag. This naturally exposes new attack vectors that must be addressed appropriately. \u003ca href=\"https://nodejs.org/en/docs/guides/debugging-getting-started/#enabling-remote-debugging-scenarios\"\u003eThe official Node.js guide for remote debugging\u003c/a\u003e is a good starting point.\u003c/p\u003e"])</script><script>self.__next_f.push([1,"d:[\"$\",\"div\",null,{\"className\":\"flex justify-center\",\"children\":[\"$\",\"div\",null,{\"className\":\"md:px-10 min-w-0 max-w-7xl mb-12\",\"children\":[\"$\",\"article\",null,{\"children\":[[\"$\",\"header\",null,{\"className\":\"px-5 mb-4 py-10 relative\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"text-3xl leading-none tracking-tight text-gray-900 md:text-4xl lg:text-5xl dark:text-gray-100\",\"children\":\"Debuggable Scripting with TypeScript and ClearScript\"}],[\"$\",\"time\",null,{\"dateTime\":\"2022-11-28 21:00\",\"className\":\"pl-1 font-serif text-slate-400 bottom-0 absolute\",\"children\":[[\"$\",\"svg\",null,{\"className\":\"h-4 w-4 inline-block\",\"width\":\"24\",\"height\":\"24\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"viewBox\":\"0 0 24 24\",\"fill\":\"none\",\"stroke\":\"currentColor\",\"strokeWidth\":\"2\",\"strokeLinecap\":\"round\",\"strokeLinejoin\":\"round\",\"children\":[[\"$\",\"path\",null,{\"d\":\"M12 19l7-7 3 3-7 7-3-3z\"}],\" \",[\"$\",\"path\",null,{\"d\":\"M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z\"}],\" \",[\"$\",\"path\",null,{\"d\":\"M2 2l7.586 7.586\"}],\" \",[\"$\",\"circle\",null,{\"cx\":\"11\",\"cy\":\"11\",\"r\":\"2\"}]]}],\" \",\"2022-11-28 21:00\"]}]]}],[\"$\",\"div\",null,{\"className\":\"bg-slate-100 dark:bg-slate-800 p-5 pb-12 rounded shadow-lg\",\"children\":[[[\"$\",\"p\",null,{\"className\":\"italic text-slate-400 p-4\",\"dangerouslySetInnerHTML\":{\"__html\":\"The code samples provided in this blog post are available at \u003ca href=\\\"https://github.com/iotalambda/ClearScriptV8Poc\\\"\u003eClearScriptV8Poc\u003c/a\u003e.\"}}],[\"$\",\"hr\",null,{\"className\":\"h-px my-4 bg-gray-200 border-0 dark:bg-gray-700\"}]],[\"$\",\"div\",null,{\"className\":\"space-y-4\",\"dangerouslySetInnerHTML\":{\"__html\":\"$e\"}}]]}]]}]}]}]\n"])</script><script>self.__next_f.push([1,"7:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"1\",{\"children\":\"Debuggable Scripting with TypeScript and ClearScript | Food for AI blog\"}],[\"$\",\"meta\",\"2\",{\"name\":\"description\",\"content\":\"Blog about .NET, Azure, React and whatever comes to mind.\"}],[\"$\",\"meta\",\"3\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"link\",\"4\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"16x16\"}],[\"$\",\"meta\",\"5\",{\"name\":\"next-size-adjust\"}]]\nc:null\n"])</script></body></html>