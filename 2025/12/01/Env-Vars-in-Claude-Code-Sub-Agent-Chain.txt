1:HL["/_next/static/media/583a894d7b920fb7-s.p.woff2",{"as":"font","type":"font/woff2"}]
2:HL["/_next/static/media/e807dee2426166ad-s.p.woff2",{"as":"font","type":"font/woff2"}]
3:HL["/_next/static/css/cf6d346f04b2f900.css",{"as":"style"}]
0:["VCasLb-gA5eaYkvFoeITl",[[["",{"children":[["id","2025/12/01/Env-Vars-in-Claude-Code-Sub-Agent-Chain","c"],{"children":["__PAGE__?{\"id\":[\"2025\",\"12\",\"01\",\"Env-Vars-in-Claude-Code-Sub-Agent-Chain\"]}",{}]}]},"$undefined","$undefined",true],"$L4",[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/cf6d346f04b2f900.css","precedence":"next"}]],"$L5"]]]]
6:HL["/_next/static/css/4823b726c835f640.css",{"as":"style"}]
7:I{"id":6685,"chunks":["685:static/chunks/685-8c2a2ee442f8842a.js","185:static/chunks/app/layout-4978ca41370bd554.js"],"name":"","async":false}
8:I{"id":6112,"chunks":["685:static/chunks/685-8c2a2ee442f8842a.js","185:static/chunks/app/layout-4978ca41370bd554.js"],"name":"","async":false}
9:I{"id":7767,"chunks":["272:static/chunks/webpack-efd16f5debe934f5.js","971:static/chunks/fd9d1056-9200b628bfbdc6da.js","596:static/chunks/596-98393ace57ba3968.js"],"name":"default","async":false}
a:I{"id":7920,"chunks":["272:static/chunks/webpack-efd16f5debe934f5.js","971:static/chunks/fd9d1056-9200b628bfbdc6da.js","596:static/chunks/596-98393ace57ba3968.js"],"name":"default","async":false}
4:[null,["$","html",null,{"lang":"en","className":"__variable_eb9fb7 __variable_2fad4c","children":["$","body",null,{"className":"bg-slate-200 dark:bg-slate-700","children":[["$","nav",null,{"className":"w-full flex flex-row justify-between items-center bg-indigo-600 shadow-indigo-300 dark:shadow-indigo-800 shadow-2xl font-sans","children":[["$","div",null,{"className":"p-2","children":["$","$L7",null,{"className":"text-2xl font-semibold text-neutral-100 dark:text-neutral-200","href":"/","children":[["$","h1",null,{"className":"inline","children":"üçî food for ai"}]," ",["$","span",null,{"className":"font-mono font-light text-xs","children":"food.joona.cloud"}]]}]}],["$","$L8",null,{"className":"mr-2"}]]}],["$","main",null,{"className":"mt-4","children":["$","$L9",null,{"parallelRouterKey":"children","segmentPath":["children"],"loading":"$undefined","loadingStyles":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","template":["$","$La",null,{}],"templateStyles":"$undefined","notFound":[["$","title",null,{"children":"404: This page could not be found."}],["$","div",null,{"style":{"fontFamily":"system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"","height":"100vh","textAlign":"center","display":"flex","flexDirection":"column","alignItems":"center","justifyContent":"center"},"children":["$","div",null,{"children":[["$","style",null,{"dangerouslySetInnerHTML":{"__html":"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}"}}],["$","h1",null,{"className":"next-error-h1","style":{"display":"inline-block","margin":"0 20px 0 0","padding":"0 23px 0 0","fontSize":24,"fontWeight":500,"verticalAlign":"top","lineHeight":"49px"},"children":"404"}],["$","div",null,{"style":{"display":"inline-block"},"children":["$","h2",null,{"style":{"fontSize":14,"fontWeight":400,"lineHeight":"49px","margin":0},"children":"This page could not be found."}]}]]}]}]],"notFoundStyles":[],"childProp":{"current":["$","$L9",null,{"parallelRouterKey":"children","segmentPath":["children",["id","2025/12/01/Env-Vars-in-Claude-Code-Sub-Agent-Chain","c"],"children"],"loading":"$undefined","loadingStyles":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","template":["$","$La",null,{}],"templateStyles":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","childProp":{"current":["$Lb","$Lc",null],"segment":"__PAGE__?{\"id\":[\"2025\",\"12\",\"01\",\"Env-Vars-in-Claude-Code-Sub-Agent-Chain\"]}"},"styles":[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/4823b726c835f640.css","precedence":"next"}]]}],"segment":["id","2025/12/01/Env-Vars-in-Claude-Code-Sub-Agent-Chain","c"]},"styles":[]}]}]]}]}],null]
5:[["$","meta","0",{"charSet":"utf-8"}],["$","title","1",{"children":"Env Vars in Claude Code Sub-Agent Chain | Food for AI blog"}],["$","meta","2",{"name":"description","content":"Blog about .NET, Azure, React and whatever comes to mind."}],["$","meta","3",{"name":"viewport","content":"width=device-width, initial-scale=1"}],["$","link","4",{"rel":"icon","href":"/favicon.ico","type":"image/x-icon","sizes":"16x16"}],["$","meta","5",{"name":"next-size-adjust"}]]
d:Tf8a7,<p><a href="https://docs.anthropic.com/en/docs/claude-code/overview">Claude Code</a>'s <a href="https://code.claude.com/docs/en/sub-agents">sub-agent</a> system is powerful for breaking down complex tasks, but there's a gap: environment variables set in a parent agent don't automatically propagate to child sub-agents. This article presents a hooks-based solution that enables environment variable inheritance across the entire agent chain.</p>
<h2 id="the-problem"><a href="#the-problem">The Problem</a></h2>
<p>Consider this scenario: you ask Claude Code to set an environment variable and then spawn a sub-agent, expecting the sub-agent to read that variable:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="bash" data-theme="light"><code data-language="bash" data-theme="light"><span class="line"><span style="color: #6F42C1">USER:</span></span>
<span class="line"><span style="color: #032F62">"Hi! Please set env var MYSTERY to 42 and then spawn a sub-agent and ask them</span></span>
<span class="line"><span style="color: #032F62"> to check what value they have in their MYSTERY env var."</span></span></code></pre><pre data-language="bash" data-theme="dark"><code data-language="bash" data-theme="dark"><span class="line"><span style="color: #B392F0">USER:</span></span>
<span class="line"><span style="color: #9ECBFF">"Hi! Please set env var MYSTERY to 42 and then spawn a sub-agent and ask them</span></span>
<span class="line"><span style="color: #9ECBFF"> to check what value they have in their MYSTERY env var."</span></span></code></pre></div>
<p>The sub-agent won't see <code>MYSTERY=42</code>. Sub-agents are separate processes ‚Äî when Claude Code spawns one, it creates a new instance with a fresh environment. Variables set in the parent exist only in that parent's memory space and don't propagate to children created later.</p>
<p>This creates friction in agent orchestration. Without variable inheritance, passing context and parameters to sub-agents requires either including them in downstream prompts or adding instructions to sub-agent workflows ‚Äî both of which <strong>waste inference time and tokens</strong>.</p>
<h2 id="the-solution-a-file-based-environment-stack"><a href="#the-solution-a-file-based-environment-stack">The Solution: A File-Based Environment Stack</a></h2>
<p>The key insight is to use the filesystem as a shared state mechanism, combined with Claude Code's <a href="https://docs.claude.com/en/docs/claude-code/hooks">hooks</a> system to manage the lifecycle. Here's the high-level approach:</p>
<ol>
<li><strong>A working directory</strong> (<code>.claude/env-vars/</code>) stores environment variable files</li>
<li><strong>A helper script</strong> writes variables to the current env file</li>
<li><strong>Hooks</strong> manage the stack of env files and inject them into Bash commands</li>
</ol>
<p>Hooks are shell commands that Claude Code executes automatically at specific lifecycle events ‚Äî when the user submits a prompt, before a tool runs, or when a sub-agent completes. They can inspect and modify tool inputs, block actions, or perform side effects. This makes them ideal for injecting our environment variable logic at exactly the right moments.</p>
<p>The "stack" is crucial for nested sub-agents. When a root agent spawns a sub-agent (level 1), which then spawns another sub-agent (level 2), we need separate env files for each level. The stack ensures that:</p>
<ul>
<li>Each agent writes to its own file (avoiding conflicts)</li>
<li>All agents see variables from parent agents (via sourcing all files in order)</li>
<li>When an agent completes, only its file is removed (preserving parent state)</li>
</ul>
<h2 id="implementation"><a href="#implementation">Implementation</a></h2>
<h3 id="directory-structure"><a href="#directory-structure">Directory Structure</a></h3>
<pre><code>your-project/
  .claude/
    settings.local.json
    env-vars/
      env-vars1
      env-vars2
      ...
    hooks/
      user-prompt-submit.sh
      pre-tool-use-task.sh
      pre-tool-use-bash.sh
      subagent-stop.sh
  setenv.sh
</code></pre>
<h3 id="hook-configuration"><a href="#hook-configuration">Hook Configuration</a></h3>
<p>In <code>.claude/settings.local.json</code>:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="json" data-theme="light"><code data-language="json" data-theme="light"><span class="line"><span style="color: #24292E">{</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #005CC5">"hooks"</span><span style="color: #24292E">: {</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #005CC5">"UserPromptSubmit"</span><span style="color: #24292E">: [</span></span>
<span class="line"><span style="color: #24292E">      {</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #005CC5">"matcher"</span><span style="color: #24292E">: </span><span style="color: #032F62">""</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #005CC5">"hooks"</span><span style="color: #24292E">: [</span></span>
<span class="line"><span style="color: #24292E">          {</span></span>
<span class="line"><span style="color: #24292E">            </span><span style="color: #005CC5">"type"</span><span style="color: #24292E">: </span><span style="color: #032F62">"command"</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">            </span><span style="color: #005CC5">"command"</span><span style="color: #24292E">: </span><span style="color: #032F62">"./.claude/hooks/user-prompt-submit.sh"</span></span>
<span class="line"><span style="color: #24292E">          }</span></span>
<span class="line"><span style="color: #24292E">        ]</span></span>
<span class="line"><span style="color: #24292E">      }</span></span>
<span class="line"><span style="color: #24292E">    ],</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #005CC5">"PreToolUse"</span><span style="color: #24292E">: [</span></span>
<span class="line"><span style="color: #24292E">      {</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #005CC5">"matcher"</span><span style="color: #24292E">: </span><span style="color: #032F62">"Task"</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #005CC5">"hooks"</span><span style="color: #24292E">: [</span></span>
<span class="line"><span style="color: #24292E">          {</span></span>
<span class="line"><span style="color: #24292E">            </span><span style="color: #005CC5">"type"</span><span style="color: #24292E">: </span><span style="color: #032F62">"command"</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">            </span><span style="color: #005CC5">"command"</span><span style="color: #24292E">: </span><span style="color: #032F62">"./.claude/hooks/pre-tool-use-task.sh"</span></span>
<span class="line"><span style="color: #24292E">          }</span></span>
<span class="line"><span style="color: #24292E">        ]</span></span>
<span class="line"><span style="color: #24292E">      },</span></span>
<span class="line"><span style="color: #24292E">      {</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #005CC5">"matcher"</span><span style="color: #24292E">: </span><span style="color: #032F62">"Bash"</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #005CC5">"hooks"</span><span style="color: #24292E">: [</span></span>
<span class="line"><span style="color: #24292E">          {</span></span>
<span class="line"><span style="color: #24292E">            </span><span style="color: #005CC5">"type"</span><span style="color: #24292E">: </span><span style="color: #032F62">"command"</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">            </span><span style="color: #005CC5">"command"</span><span style="color: #24292E">: </span><span style="color: #032F62">"./.claude/hooks/pre-tool-use-bash.sh"</span></span>
<span class="line"><span style="color: #24292E">          }</span></span>
<span class="line"><span style="color: #24292E">        ]</span></span>
<span class="line"><span style="color: #24292E">      }</span></span>
<span class="line"><span style="color: #24292E">    ],</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #005CC5">"SubagentStop"</span><span style="color: #24292E">: [</span></span>
<span class="line"><span style="color: #24292E">      {</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #005CC5">"matcher"</span><span style="color: #24292E">: </span><span style="color: #032F62">""</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">        </span><span style="color: #005CC5">"hooks"</span><span style="color: #24292E">: [</span></span>
<span class="line"><span style="color: #24292E">          {</span></span>
<span class="line"><span style="color: #24292E">            </span><span style="color: #005CC5">"type"</span><span style="color: #24292E">: </span><span style="color: #032F62">"command"</span><span style="color: #24292E">,</span></span>
<span class="line"><span style="color: #24292E">            </span><span style="color: #005CC5">"command"</span><span style="color: #24292E">: </span><span style="color: #032F62">"./.claude/hooks/subagent-stop.sh"</span></span>
<span class="line"><span style="color: #24292E">          }</span></span>
<span class="line"><span style="color: #24292E">        ]</span></span>
<span class="line"><span style="color: #24292E">      }</span></span>
<span class="line"><span style="color: #24292E">    ]</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre><pre data-language="json" data-theme="dark"><code data-language="json" data-theme="dark"><span class="line"><span style="color: #E1E4E8">{</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #79B8FF">"hooks"</span><span style="color: #E1E4E8">: {</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">"UserPromptSubmit"</span><span style="color: #E1E4E8">: [</span></span>
<span class="line"><span style="color: #E1E4E8">      {</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #79B8FF">"matcher"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">""</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #79B8FF">"hooks"</span><span style="color: #E1E4E8">: [</span></span>
<span class="line"><span style="color: #E1E4E8">          {</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #79B8FF">"type"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"command"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #79B8FF">"command"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"./.claude/hooks/user-prompt-submit.sh"</span></span>
<span class="line"><span style="color: #E1E4E8">          }</span></span>
<span class="line"><span style="color: #E1E4E8">        ]</span></span>
<span class="line"><span style="color: #E1E4E8">      }</span></span>
<span class="line"><span style="color: #E1E4E8">    ],</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">"PreToolUse"</span><span style="color: #E1E4E8">: [</span></span>
<span class="line"><span style="color: #E1E4E8">      {</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #79B8FF">"matcher"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"Task"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #79B8FF">"hooks"</span><span style="color: #E1E4E8">: [</span></span>
<span class="line"><span style="color: #E1E4E8">          {</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #79B8FF">"type"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"command"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #79B8FF">"command"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"./.claude/hooks/pre-tool-use-task.sh"</span></span>
<span class="line"><span style="color: #E1E4E8">          }</span></span>
<span class="line"><span style="color: #E1E4E8">        ]</span></span>
<span class="line"><span style="color: #E1E4E8">      },</span></span>
<span class="line"><span style="color: #E1E4E8">      {</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #79B8FF">"matcher"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"Bash"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #79B8FF">"hooks"</span><span style="color: #E1E4E8">: [</span></span>
<span class="line"><span style="color: #E1E4E8">          {</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #79B8FF">"type"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"command"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #79B8FF">"command"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"./.claude/hooks/pre-tool-use-bash.sh"</span></span>
<span class="line"><span style="color: #E1E4E8">          }</span></span>
<span class="line"><span style="color: #E1E4E8">        ]</span></span>
<span class="line"><span style="color: #E1E4E8">      }</span></span>
<span class="line"><span style="color: #E1E4E8">    ],</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">"SubagentStop"</span><span style="color: #E1E4E8">: [</span></span>
<span class="line"><span style="color: #E1E4E8">      {</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #79B8FF">"matcher"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">""</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">        </span><span style="color: #79B8FF">"hooks"</span><span style="color: #E1E4E8">: [</span></span>
<span class="line"><span style="color: #E1E4E8">          {</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #79B8FF">"type"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"command"</span><span style="color: #E1E4E8">,</span></span>
<span class="line"><span style="color: #E1E4E8">            </span><span style="color: #79B8FF">"command"</span><span style="color: #E1E4E8">: </span><span style="color: #9ECBFF">"./.claude/hooks/subagent-stop.sh"</span></span>
<span class="line"><span style="color: #E1E4E8">          }</span></span>
<span class="line"><span style="color: #E1E4E8">        ]</span></span>
<span class="line"><span style="color: #E1E4E8">      }</span></span>
<span class="line"><span style="color: #E1E4E8">    ]</span></span>
<span class="line"><span style="color: #E1E4E8">  }</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre></div>
<p>The hooks serve distinct purposes:</p>
<ul>
<li><a href="https://docs.claude.com/en/docs/claude-code/hooks#hook-events"><strong>UserPromptSubmit</strong></a>: Fires when the user sends a message; we use it to reset state for new conversations</li>
<li><a href="https://docs.claude.com/en/docs/claude-code/hooks#hook-events"><strong>PreToolUse</strong></a>(Task): Fires before spawning a sub-agent; we push a new env file onto the stack</li>
<li><strong>PreToolUse</strong>(Bash): Fires before every Bash command; we inject env vars by modifying the command</li>
<li><a href="https://docs.claude.com/en/docs/claude-code/hooks#hook-events"><strong>SubagentStop</strong></a>: Fires when a sub-agent completes; we pop its env file from the stack</li>
</ul>
<h3 id="the-hooks"><a href="#the-hooks">The Hooks</a></h3>
<h4 id="1-userpromptsubmit-hook---session-reset"><a href="#1-userpromptsubmit-hook---session-reset"><strong>1. UserPromptSubmit Hook - Session Reset</strong></a></h4>
<p>This hook clears the working directory when a new user prompt is submitted, ensuring a fresh start:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="bash" data-theme="light"><code data-language="bash" data-theme="light"><span class="line"><span style="color: #6A737D">#!/bin/bash</span></span>
<span class="line"><span style="color: #6A737D"># Hook: UserPromptSubmit - clears env-vars directory</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">if</span><span style="color: #24292E"> [ </span><span style="color: #D73A49">-d</span><span style="color: #032F62"> ".claude/env-vars"</span><span style="color: #24292E"> ]; </span><span style="color: #D73A49">then</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">rm</span><span style="color: #24292E"> </span><span style="color: #005CC5">-rf</span><span style="color: #24292E"> </span><span style="color: #032F62">.claude/env-vars</span></span>
<span class="line"><span style="color: #D73A49">fi</span></span></code></pre><pre data-language="bash" data-theme="dark"><code data-language="bash" data-theme="dark"><span class="line"><span style="color: #6A737D">#!/bin/bash</span></span>
<span class="line"><span style="color: #6A737D"># Hook: UserPromptSubmit - clears env-vars directory</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">if</span><span style="color: #E1E4E8"> [ </span><span style="color: #F97583">-d</span><span style="color: #9ECBFF"> ".claude/env-vars"</span><span style="color: #E1E4E8"> ]; </span><span style="color: #F97583">then</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">rm</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">-rf</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">.claude/env-vars</span></span>
<span class="line"><span style="color: #F97583">fi</span></span></code></pre></div>
<p>This reset ensures that each new conversation starts with a clean slate.</p>
<h4 id="2-pretoolusetask-hook---stack-push"><a href="#2-pretoolusetask-hook---stack-push"><strong>2. PreToolUse(Task) Hook - Stack Push</strong></a></h4>
<p>When a sub-agent is spawned, create a new env file for that level:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="bash" data-theme="light"><code data-language="bash" data-theme="light"><span class="line"><span style="color: #6A737D">#!/bin/bash</span></span>
<span class="line"><span style="color: #6A737D"># Hook: PreToolUse(Task) - adds new env file for sub-agent</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">if</span><span style="color: #24292E"> [ </span><span style="color: #D73A49">!</span><span style="color: #24292E"> </span><span style="color: #D73A49">-d</span><span style="color: #032F62"> ".claude/env-vars"</span><span style="color: #24292E"> ]; </span><span style="color: #D73A49">then</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #005CC5">exit</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span></span>
<span class="line"><span style="color: #D73A49">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D"># Find the last env file number and create the next one</span></span>
<span class="line"><span style="color: #24292E">last_file</span><span style="color: #D73A49">=</span><span style="color: #032F62">$(</span><span style="color: #6F42C1">ls</span><span style="color: #032F62"> </span><span style="color: #005CC5">-1</span><span style="color: #032F62"> .claude/env-vars/env-vars</span><span style="color: #005CC5">*</span><span style="color: #032F62"> </span><span style="color: #D73A49">2></span><span style="color: #032F62">/dev/null </span><span style="color: #D73A49">|</span><span style="color: #032F62"> </span><span style="color: #6F42C1">sort</span><span style="color: #032F62"> </span><span style="color: #005CC5">-V</span><span style="color: #032F62"> </span><span style="color: #D73A49">|</span><span style="color: #032F62"> </span><span style="color: #6F42C1">tail</span><span style="color: #032F62"> </span><span style="color: #005CC5">-1</span><span style="color: #032F62">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">if</span><span style="color: #24292E"> [ </span><span style="color: #D73A49">-z</span><span style="color: #032F62"> "</span><span style="color: #24292E">$last_file</span><span style="color: #032F62">"</span><span style="color: #24292E"> ]; </span><span style="color: #D73A49">then</span></span>
<span class="line"><span style="color: #24292E">    next_num</span><span style="color: #D73A49">=</span><span style="color: #005CC5">1</span></span>
<span class="line"><span style="color: #D73A49">else</span></span>
<span class="line"><span style="color: #24292E">    last_num</span><span style="color: #D73A49">=</span><span style="color: #032F62">$(</span><span style="color: #6F42C1">basename</span><span style="color: #032F62"> "</span><span style="color: #24292E">$last_file</span><span style="color: #032F62">" </span><span style="color: #D73A49">|</span><span style="color: #032F62"> </span><span style="color: #6F42C1">sed</span><span style="color: #032F62"> 's/env-vars//')</span></span>
<span class="line"><span style="color: #24292E">    next_num</span><span style="color: #D73A49">=</span><span style="color: #032F62">$((last_num </span><span style="color: #D73A49">+</span><span style="color: #032F62"> </span><span style="color: #005CC5">1</span><span style="color: #032F62">))</span></span>
<span class="line"><span style="color: #D73A49">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6F42C1">touch</span><span style="color: #24292E"> </span><span style="color: #032F62">".claude/env-vars/env-vars${next_num}"</span></span></code></pre><pre data-language="bash" data-theme="dark"><code data-language="bash" data-theme="dark"><span class="line"><span style="color: #6A737D">#!/bin/bash</span></span>
<span class="line"><span style="color: #6A737D"># Hook: PreToolUse(Task) - adds new env file for sub-agent</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">if</span><span style="color: #E1E4E8"> [ </span><span style="color: #F97583">!</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">-d</span><span style="color: #9ECBFF"> ".claude/env-vars"</span><span style="color: #E1E4E8"> ]; </span><span style="color: #F97583">then</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">exit</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0</span></span>
<span class="line"><span style="color: #F97583">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D"># Find the last env file number and create the next one</span></span>
<span class="line"><span style="color: #E1E4E8">last_file</span><span style="color: #F97583">=</span><span style="color: #9ECBFF">$(</span><span style="color: #B392F0">ls</span><span style="color: #9ECBFF"> </span><span style="color: #79B8FF">-1</span><span style="color: #9ECBFF"> .claude/env-vars/env-vars</span><span style="color: #79B8FF">*</span><span style="color: #9ECBFF"> </span><span style="color: #F97583">2></span><span style="color: #9ECBFF">/dev/null </span><span style="color: #F97583">|</span><span style="color: #9ECBFF"> </span><span style="color: #B392F0">sort</span><span style="color: #9ECBFF"> </span><span style="color: #79B8FF">-V</span><span style="color: #9ECBFF"> </span><span style="color: #F97583">|</span><span style="color: #9ECBFF"> </span><span style="color: #B392F0">tail</span><span style="color: #9ECBFF"> </span><span style="color: #79B8FF">-1</span><span style="color: #9ECBFF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">if</span><span style="color: #E1E4E8"> [ </span><span style="color: #F97583">-z</span><span style="color: #9ECBFF"> "</span><span style="color: #E1E4E8">$last_file</span><span style="color: #9ECBFF">"</span><span style="color: #E1E4E8"> ]; </span><span style="color: #F97583">then</span></span>
<span class="line"><span style="color: #E1E4E8">    next_num</span><span style="color: #F97583">=</span><span style="color: #79B8FF">1</span></span>
<span class="line"><span style="color: #F97583">else</span></span>
<span class="line"><span style="color: #E1E4E8">    last_num</span><span style="color: #F97583">=</span><span style="color: #9ECBFF">$(</span><span style="color: #B392F0">basename</span><span style="color: #9ECBFF"> "</span><span style="color: #E1E4E8">$last_file</span><span style="color: #9ECBFF">" </span><span style="color: #F97583">|</span><span style="color: #9ECBFF"> </span><span style="color: #B392F0">sed</span><span style="color: #9ECBFF"> 's/env-vars//')</span></span>
<span class="line"><span style="color: #E1E4E8">    next_num</span><span style="color: #F97583">=</span><span style="color: #9ECBFF">$((last_num </span><span style="color: #F97583">+</span><span style="color: #9ECBFF"> </span><span style="color: #79B8FF">1</span><span style="color: #9ECBFF">))</span></span>
<span class="line"><span style="color: #F97583">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B392F0">touch</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">".claude/env-vars/env-vars${next_num}"</span></span></code></pre></div>
<h4 id="3-pretoolusebash-hook---environment-injection"><a href="#3-pretoolusebash-hook---environment-injection"><strong>3. PreToolUse(Bash) Hook - Environment Injection</strong></a></h4>
<p>This hook prepends sourcing of all env files to <em>every Bash command</em>:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="bash" data-theme="light"><code data-language="bash" data-theme="light"><span class="line"><span style="color: #6A737D">#!/bin/bash</span></span>
<span class="line"><span style="color: #6A737D"># Hook: PreToolUse(Bash) - injects env vars into commands</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">if</span><span style="color: #24292E"> [ </span><span style="color: #D73A49">!</span><span style="color: #24292E"> </span><span style="color: #D73A49">-d</span><span style="color: #032F62"> ".claude/env-vars"</span><span style="color: #24292E"> ]; </span><span style="color: #D73A49">then</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #005CC5">exit</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span></span>
<span class="line"><span style="color: #D73A49">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">envvars_files</span><span style="color: #D73A49">=</span><span style="color: #032F62">$(</span><span style="color: #6F42C1">ls</span><span style="color: #032F62"> </span><span style="color: #005CC5">-1</span><span style="color: #032F62"> .claude/env-vars/env-vars</span><span style="color: #005CC5">*</span><span style="color: #032F62"> </span><span style="color: #D73A49">2></span><span style="color: #032F62">/dev/null </span><span style="color: #D73A49">|</span><span style="color: #032F62"> </span><span style="color: #6F42C1">sort</span><span style="color: #032F62"> </span><span style="color: #005CC5">-V</span><span style="color: #032F62">)</span></span>
<span class="line"><span style="color: #D73A49">if</span><span style="color: #24292E"> [ </span><span style="color: #D73A49">-z</span><span style="color: #032F62"> "</span><span style="color: #24292E">$envvars_files</span><span style="color: #032F62">"</span><span style="color: #24292E"> ]; </span><span style="color: #D73A49">then</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #005CC5">exit</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span></span>
<span class="line"><span style="color: #D73A49">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">input</span><span style="color: #D73A49">=</span><span style="color: #032F62">$(</span><span style="color: #6F42C1">cat</span><span style="color: #032F62">)</span></span>
<span class="line"><span style="color: #24292E">command</span><span style="color: #D73A49">=</span><span style="color: #032F62">$(</span><span style="color: #005CC5">echo</span><span style="color: #032F62"> "</span><span style="color: #24292E">$input</span><span style="color: #032F62">" </span><span style="color: #D73A49">|</span><span style="color: #032F62"> </span><span style="color: #6F42C1">jq</span><span style="color: #032F62"> </span><span style="color: #005CC5">-r</span><span style="color: #032F62"> '.tool_input.command // empty')</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">if</span><span style="color: #24292E"> [ </span><span style="color: #D73A49">-z</span><span style="color: #032F62"> "</span><span style="color: #24292E">$command</span><span style="color: #032F62">"</span><span style="color: #24292E"> ]; </span><span style="color: #D73A49">then</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #005CC5">exit</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span></span>
<span class="line"><span style="color: #D73A49">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D"># Build source prefix for all env files</span></span>
<span class="line"><span style="color: #24292E">source_prefix</span><span style="color: #D73A49">=</span><span style="color: #032F62">""</span></span>
<span class="line"><span style="color: #D73A49">for</span><span style="color: #24292E"> envvars_file </span><span style="color: #D73A49">in</span><span style="color: #24292E"> $envvars_files; </span><span style="color: #D73A49">do</span></span>
<span class="line"><span style="color: #24292E">    source_prefix</span><span style="color: #D73A49">=</span><span style="color: #032F62">"${source_prefix}set -a; source </span><span style="color: #005CC5">\"</span><span style="color: #24292E">$envvars_file</span><span style="color: #005CC5">\"</span><span style="color: #032F62">; set +a; "</span></span>
<span class="line"><span style="color: #D73A49">done</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">new_command</span><span style="color: #D73A49">=</span><span style="color: #032F62">"${source_prefix}${command}"</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6F42C1">jq</span><span style="color: #24292E"> </span><span style="color: #005CC5">-n</span><span style="color: #24292E"> </span><span style="color: #005CC5">--arg</span><span style="color: #24292E"> </span><span style="color: #032F62">cmd</span><span style="color: #24292E"> </span><span style="color: #032F62">"</span><span style="color: #24292E">$new_command</span><span style="color: #032F62">"</span><span style="color: #24292E"> </span><span style="color: #032F62">'{</span></span>
<span class="line"><span style="color: #032F62">  "hookSpecificOutput": {</span></span>
<span class="line"><span style="color: #032F62">    "hookEventName": "PreToolUse",</span></span>
<span class="line"><span style="color: #032F62">    "permissionDecision": "allow",</span></span>
<span class="line"><span style="color: #032F62">    "updatedInput": {"command": $cmd}</span></span>
<span class="line"><span style="color: #032F62">  }</span></span>
<span class="line"><span style="color: #032F62">}'</span></span></code></pre><pre data-language="bash" data-theme="dark"><code data-language="bash" data-theme="dark"><span class="line"><span style="color: #6A737D">#!/bin/bash</span></span>
<span class="line"><span style="color: #6A737D"># Hook: PreToolUse(Bash) - injects env vars into commands</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">if</span><span style="color: #E1E4E8"> [ </span><span style="color: #F97583">!</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">-d</span><span style="color: #9ECBFF"> ".claude/env-vars"</span><span style="color: #E1E4E8"> ]; </span><span style="color: #F97583">then</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">exit</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0</span></span>
<span class="line"><span style="color: #F97583">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">envvars_files</span><span style="color: #F97583">=</span><span style="color: #9ECBFF">$(</span><span style="color: #B392F0">ls</span><span style="color: #9ECBFF"> </span><span style="color: #79B8FF">-1</span><span style="color: #9ECBFF"> .claude/env-vars/env-vars</span><span style="color: #79B8FF">*</span><span style="color: #9ECBFF"> </span><span style="color: #F97583">2></span><span style="color: #9ECBFF">/dev/null </span><span style="color: #F97583">|</span><span style="color: #9ECBFF"> </span><span style="color: #B392F0">sort</span><span style="color: #9ECBFF"> </span><span style="color: #79B8FF">-V</span><span style="color: #9ECBFF">)</span></span>
<span class="line"><span style="color: #F97583">if</span><span style="color: #E1E4E8"> [ </span><span style="color: #F97583">-z</span><span style="color: #9ECBFF"> "</span><span style="color: #E1E4E8">$envvars_files</span><span style="color: #9ECBFF">"</span><span style="color: #E1E4E8"> ]; </span><span style="color: #F97583">then</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">exit</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0</span></span>
<span class="line"><span style="color: #F97583">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">input</span><span style="color: #F97583">=</span><span style="color: #9ECBFF">$(</span><span style="color: #B392F0">cat</span><span style="color: #9ECBFF">)</span></span>
<span class="line"><span style="color: #E1E4E8">command</span><span style="color: #F97583">=</span><span style="color: #9ECBFF">$(</span><span style="color: #79B8FF">echo</span><span style="color: #9ECBFF"> "</span><span style="color: #E1E4E8">$input</span><span style="color: #9ECBFF">" </span><span style="color: #F97583">|</span><span style="color: #9ECBFF"> </span><span style="color: #B392F0">jq</span><span style="color: #9ECBFF"> </span><span style="color: #79B8FF">-r</span><span style="color: #9ECBFF"> '.tool_input.command // empty')</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">if</span><span style="color: #E1E4E8"> [ </span><span style="color: #F97583">-z</span><span style="color: #9ECBFF"> "</span><span style="color: #E1E4E8">$command</span><span style="color: #9ECBFF">"</span><span style="color: #E1E4E8"> ]; </span><span style="color: #F97583">then</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">exit</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0</span></span>
<span class="line"><span style="color: #F97583">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A737D"># Build source prefix for all env files</span></span>
<span class="line"><span style="color: #E1E4E8">source_prefix</span><span style="color: #F97583">=</span><span style="color: #9ECBFF">""</span></span>
<span class="line"><span style="color: #F97583">for</span><span style="color: #E1E4E8"> envvars_file </span><span style="color: #F97583">in</span><span style="color: #E1E4E8"> $envvars_files; </span><span style="color: #F97583">do</span></span>
<span class="line"><span style="color: #E1E4E8">    source_prefix</span><span style="color: #F97583">=</span><span style="color: #9ECBFF">"${source_prefix}set -a; source </span><span style="color: #79B8FF">\"</span><span style="color: #E1E4E8">$envvars_file</span><span style="color: #79B8FF">\"</span><span style="color: #9ECBFF">; set +a; "</span></span>
<span class="line"><span style="color: #F97583">done</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">new_command</span><span style="color: #F97583">=</span><span style="color: #9ECBFF">"${source_prefix}${command}"</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B392F0">jq</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">-n</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">--arg</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">cmd</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"</span><span style="color: #E1E4E8">$new_command</span><span style="color: #9ECBFF">"</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">'{</span></span>
<span class="line"><span style="color: #9ECBFF">  "hookSpecificOutput": {</span></span>
<span class="line"><span style="color: #9ECBFF">    "hookEventName": "PreToolUse",</span></span>
<span class="line"><span style="color: #9ECBFF">    "permissionDecision": "allow",</span></span>
<span class="line"><span style="color: #9ECBFF">    "updatedInput": {"command": $cmd}</span></span>
<span class="line"><span style="color: #9ECBFF">  }</span></span>
<span class="line"><span style="color: #9ECBFF">}'</span></span></code></pre></div>
<p>If a child agent redefines a parent's variable, the child's value takes precedence. Since we source files in order (parent first, then children), later assignments override earlier ones.</p>
<h4 id="4-subagentstop-hook---stack-pop"><a href="#4-subagentstop-hook---stack-pop"><strong>4. SubagentStop Hook - Stack Pop</strong></a></h4>
<p>When a sub-agent completes, remove its env file:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="bash" data-theme="light"><code data-language="bash" data-theme="light"><span class="line"><span style="color: #6A737D">#!/bin/bash</span></span>
<span class="line"><span style="color: #6A737D"># Hook: SubagentStop - removes the sub-agent's env file</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">if</span><span style="color: #24292E"> [ </span><span style="color: #D73A49">!</span><span style="color: #24292E"> </span><span style="color: #D73A49">-d</span><span style="color: #032F62"> ".claude/env-vars"</span><span style="color: #24292E"> ]; </span><span style="color: #D73A49">then</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #005CC5">exit</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span></span>
<span class="line"><span style="color: #D73A49">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">last_file</span><span style="color: #D73A49">=</span><span style="color: #032F62">$(</span><span style="color: #6F42C1">ls</span><span style="color: #032F62"> </span><span style="color: #005CC5">-1</span><span style="color: #032F62"> .claude/env-vars/env-vars</span><span style="color: #005CC5">*</span><span style="color: #032F62"> </span><span style="color: #D73A49">2></span><span style="color: #032F62">/dev/null </span><span style="color: #D73A49">|</span><span style="color: #032F62"> </span><span style="color: #6F42C1">sort</span><span style="color: #032F62"> </span><span style="color: #005CC5">-V</span><span style="color: #032F62"> </span><span style="color: #D73A49">|</span><span style="color: #032F62"> </span><span style="color: #6F42C1">tail</span><span style="color: #032F62"> </span><span style="color: #005CC5">-1</span><span style="color: #032F62">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">if</span><span style="color: #24292E"> [ </span><span style="color: #D73A49">-n</span><span style="color: #032F62"> "</span><span style="color: #24292E">$last_file</span><span style="color: #032F62">"</span><span style="color: #24292E"> ]; </span><span style="color: #D73A49">then</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">rm</span><span style="color: #24292E"> </span><span style="color: #032F62">"</span><span style="color: #24292E">$last_file</span><span style="color: #032F62">"</span></span>
<span class="line"><span style="color: #D73A49">fi</span></span></code></pre><pre data-language="bash" data-theme="dark"><code data-language="bash" data-theme="dark"><span class="line"><span style="color: #6A737D">#!/bin/bash</span></span>
<span class="line"><span style="color: #6A737D"># Hook: SubagentStop - removes the sub-agent's env file</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">if</span><span style="color: #E1E4E8"> [ </span><span style="color: #F97583">!</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">-d</span><span style="color: #9ECBFF"> ".claude/env-vars"</span><span style="color: #E1E4E8"> ]; </span><span style="color: #F97583">then</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">exit</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">0</span></span>
<span class="line"><span style="color: #F97583">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">last_file</span><span style="color: #F97583">=</span><span style="color: #9ECBFF">$(</span><span style="color: #B392F0">ls</span><span style="color: #9ECBFF"> </span><span style="color: #79B8FF">-1</span><span style="color: #9ECBFF"> .claude/env-vars/env-vars</span><span style="color: #79B8FF">*</span><span style="color: #9ECBFF"> </span><span style="color: #F97583">2></span><span style="color: #9ECBFF">/dev/null </span><span style="color: #F97583">|</span><span style="color: #9ECBFF"> </span><span style="color: #B392F0">sort</span><span style="color: #9ECBFF"> </span><span style="color: #79B8FF">-V</span><span style="color: #9ECBFF"> </span><span style="color: #F97583">|</span><span style="color: #9ECBFF"> </span><span style="color: #B392F0">tail</span><span style="color: #9ECBFF"> </span><span style="color: #79B8FF">-1</span><span style="color: #9ECBFF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">if</span><span style="color: #E1E4E8"> [ </span><span style="color: #F97583">-n</span><span style="color: #9ECBFF"> "</span><span style="color: #E1E4E8">$last_file</span><span style="color: #9ECBFF">"</span><span style="color: #E1E4E8"> ]; </span><span style="color: #F97583">then</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">rm</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"</span><span style="color: #E1E4E8">$last_file</span><span style="color: #9ECBFF">"</span></span>
<span class="line"><span style="color: #F97583">fi</span></span></code></pre></div>
<p>This implements a classic stack "pop" operation ‚Äî the last file always belongs to the most recently spawned sub-agent.</p>
<h3 id="the-setenv-script"><a href="#the-setenv-script">The Setenv Script</a></h3>
<p>A helper script to write variables to the current agent's env file:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="bash" data-theme="light"><code data-language="bash" data-theme="light"><span class="line"><span style="color: #6A737D">#!/bin/bash</span></span>
<span class="line"><span style="color: #6A737D"># Sets a variable in the current agent's env file</span></span>
<span class="line"><span style="color: #6A737D"># Usage: ./setenv.sh VAR_NAME "value"</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">if</span><span style="color: #24292E"> [ </span><span style="color: #005CC5">$#</span><span style="color: #24292E"> </span><span style="color: #D73A49">-lt</span><span style="color: #24292E"> </span><span style="color: #005CC5">2</span><span style="color: #24292E"> ]; </span><span style="color: #D73A49">then</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #005CC5">echo</span><span style="color: #24292E"> </span><span style="color: #032F62">"Usage: </span><span style="color: #005CC5">$0</span><span style="color: #032F62"> VAR_NAME value"</span><span style="color: #24292E"> </span><span style="color: #D73A49">>&#x26;2</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #005CC5">exit</span><span style="color: #24292E"> </span><span style="color: #005CC5">1</span></span>
<span class="line"><span style="color: #D73A49">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">var_name</span><span style="color: #D73A49">=</span><span style="color: #032F62">"</span><span style="color: #005CC5">$1</span><span style="color: #032F62">"</span></span>
<span class="line"><span style="color: #24292E">var_value</span><span style="color: #D73A49">=</span><span style="color: #032F62">"</span><span style="color: #005CC5">$2</span><span style="color: #032F62">"</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">SCRIPT_DIR</span><span style="color: #D73A49">=</span><span style="color: #032F62">"$(</span><span style="color: #005CC5">cd</span><span style="color: #032F62"> "$(</span><span style="color: #6F42C1">dirname</span><span style="color: #032F62"> "${BASH_SOURCE[0]}")" &#x26;&#x26; </span><span style="color: #005CC5">pwd</span><span style="color: #032F62">)"</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6F42C1">mkdir</span><span style="color: #24292E"> </span><span style="color: #005CC5">-p</span><span style="color: #24292E"> </span><span style="color: #032F62">"</span><span style="color: #24292E">$SCRIPT_DIR</span><span style="color: #032F62">/.claude/env-vars"</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">last_file</span><span style="color: #D73A49">=</span><span style="color: #032F62">$(</span><span style="color: #6F42C1">ls</span><span style="color: #032F62"> </span><span style="color: #005CC5">-1</span><span style="color: #032F62"> "</span><span style="color: #24292E">$SCRIPT_DIR</span><span style="color: #032F62">/.claude/env-vars"/env-vars</span><span style="color: #005CC5">*</span><span style="color: #032F62"> </span><span style="color: #D73A49">2></span><span style="color: #032F62">/dev/null </span><span style="color: #D73A49">|</span><span style="color: #032F62"> </span><span style="color: #6F42C1">sort</span><span style="color: #032F62"> </span><span style="color: #005CC5">-V</span><span style="color: #032F62"> </span><span style="color: #D73A49">|</span><span style="color: #032F62"> </span><span style="color: #6F42C1">tail</span><span style="color: #032F62"> </span><span style="color: #005CC5">-1</span><span style="color: #032F62">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">if</span><span style="color: #24292E"> [ </span><span style="color: #D73A49">-z</span><span style="color: #032F62"> "</span><span style="color: #24292E">$last_file</span><span style="color: #032F62">"</span><span style="color: #24292E"> ]; </span><span style="color: #D73A49">then</span></span>
<span class="line"><span style="color: #24292E">    last_file</span><span style="color: #D73A49">=</span><span style="color: #032F62">"</span><span style="color: #24292E">$SCRIPT_DIR</span><span style="color: #032F62">/.claude/env-vars/env-vars1"</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">touch</span><span style="color: #24292E"> </span><span style="color: #032F62">"</span><span style="color: #24292E">$last_file</span><span style="color: #032F62">"</span></span>
<span class="line"><span style="color: #D73A49">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D73A49">if</span><span style="color: #24292E"> grep -q</span><span style="color: #032F62"> "^${var_name}=" "</span><span style="color: #24292E">$last_file</span><span style="color: #032F62">"</span><span style="color: #24292E"> </span><span style="color: #005CC5">2</span><span style="color: #D73A49">></span><span style="color: #24292E">/dev/null; </span><span style="color: #D73A49">then</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #6F42C1">sed</span><span style="color: #24292E"> </span><span style="color: #005CC5">-i</span><span style="color: #24292E"> </span><span style="color: #032F62">"s|^${var_name}=.*|${var_name}=${var_value}|"</span><span style="color: #24292E"> </span><span style="color: #032F62">"</span><span style="color: #24292E">$last_file</span><span style="color: #032F62">"</span></span>
<span class="line"><span style="color: #D73A49">else</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #005CC5">echo</span><span style="color: #24292E"> </span><span style="color: #032F62">"${var_name}=${var_value}"</span><span style="color: #24292E"> </span><span style="color: #D73A49">>></span><span style="color: #24292E"> </span><span style="color: #032F62">"</span><span style="color: #24292E">$last_file</span><span style="color: #032F62">"</span></span>
<span class="line"><span style="color: #D73A49">fi</span></span></code></pre><pre data-language="bash" data-theme="dark"><code data-language="bash" data-theme="dark"><span class="line"><span style="color: #6A737D">#!/bin/bash</span></span>
<span class="line"><span style="color: #6A737D"># Sets a variable in the current agent's env file</span></span>
<span class="line"><span style="color: #6A737D"># Usage: ./setenv.sh VAR_NAME "value"</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">if</span><span style="color: #E1E4E8"> [ </span><span style="color: #79B8FF">$#</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">-lt</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">2</span><span style="color: #E1E4E8"> ]; </span><span style="color: #F97583">then</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">echo</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"Usage: </span><span style="color: #79B8FF">$0</span><span style="color: #9ECBFF"> VAR_NAME value"</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">>&#x26;2</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">exit</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">1</span></span>
<span class="line"><span style="color: #F97583">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">var_name</span><span style="color: #F97583">=</span><span style="color: #9ECBFF">"</span><span style="color: #79B8FF">$1</span><span style="color: #9ECBFF">"</span></span>
<span class="line"><span style="color: #E1E4E8">var_value</span><span style="color: #F97583">=</span><span style="color: #9ECBFF">"</span><span style="color: #79B8FF">$2</span><span style="color: #9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">SCRIPT_DIR</span><span style="color: #F97583">=</span><span style="color: #9ECBFF">"$(</span><span style="color: #79B8FF">cd</span><span style="color: #9ECBFF"> "$(</span><span style="color: #B392F0">dirname</span><span style="color: #9ECBFF"> "${BASH_SOURCE[0]}")" &#x26;&#x26; </span><span style="color: #79B8FF">pwd</span><span style="color: #9ECBFF">)"</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B392F0">mkdir</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">-p</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"</span><span style="color: #E1E4E8">$SCRIPT_DIR</span><span style="color: #9ECBFF">/.claude/env-vars"</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">last_file</span><span style="color: #F97583">=</span><span style="color: #9ECBFF">$(</span><span style="color: #B392F0">ls</span><span style="color: #9ECBFF"> </span><span style="color: #79B8FF">-1</span><span style="color: #9ECBFF"> "</span><span style="color: #E1E4E8">$SCRIPT_DIR</span><span style="color: #9ECBFF">/.claude/env-vars"/env-vars</span><span style="color: #79B8FF">*</span><span style="color: #9ECBFF"> </span><span style="color: #F97583">2></span><span style="color: #9ECBFF">/dev/null </span><span style="color: #F97583">|</span><span style="color: #9ECBFF"> </span><span style="color: #B392F0">sort</span><span style="color: #9ECBFF"> </span><span style="color: #79B8FF">-V</span><span style="color: #9ECBFF"> </span><span style="color: #F97583">|</span><span style="color: #9ECBFF"> </span><span style="color: #B392F0">tail</span><span style="color: #9ECBFF"> </span><span style="color: #79B8FF">-1</span><span style="color: #9ECBFF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">if</span><span style="color: #E1E4E8"> [ </span><span style="color: #F97583">-z</span><span style="color: #9ECBFF"> "</span><span style="color: #E1E4E8">$last_file</span><span style="color: #9ECBFF">"</span><span style="color: #E1E4E8"> ]; </span><span style="color: #F97583">then</span></span>
<span class="line"><span style="color: #E1E4E8">    last_file</span><span style="color: #F97583">=</span><span style="color: #9ECBFF">"</span><span style="color: #E1E4E8">$SCRIPT_DIR</span><span style="color: #9ECBFF">/.claude/env-vars/env-vars1"</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">touch</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"</span><span style="color: #E1E4E8">$last_file</span><span style="color: #9ECBFF">"</span></span>
<span class="line"><span style="color: #F97583">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F97583">if</span><span style="color: #E1E4E8"> grep -q</span><span style="color: #9ECBFF"> "^${var_name}=" "</span><span style="color: #E1E4E8">$last_file</span><span style="color: #9ECBFF">"</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">2</span><span style="color: #F97583">></span><span style="color: #E1E4E8">/dev/null; </span><span style="color: #F97583">then</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #B392F0">sed</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">-i</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"s|^${var_name}=.*|${var_name}=${var_value}|"</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"</span><span style="color: #E1E4E8">$last_file</span><span style="color: #9ECBFF">"</span></span>
<span class="line"><span style="color: #F97583">else</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #79B8FF">echo</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"${var_name}=${var_value}"</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">>></span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"</span><span style="color: #E1E4E8">$last_file</span><span style="color: #9ECBFF">"</span></span>
<span class="line"><span style="color: #F97583">fi</span></span></code></pre></div>
<p>Don't forget to make this script executable: <code>chmod +x ./setenv.sh</code>. All hook scripts in <code>.claude/hooks/</code> also need execute permissions.</p>
<h2 id="example"><a href="#example">Example</a></h2>
<p>Here's a conversation demonstrating the environment variable inheritance:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="bash" data-theme="light"><code data-language="bash" data-theme="light"><span class="line"><span style="color: #6F42C1">USER:</span></span>
<span class="line"><span style="color: #032F62">"Set MYSTERY to 42 using setenv.sh, then spawn a sub-agent. The sub-agent</span></span>
<span class="line"><span style="color: #032F62"> should check the MYSTERY value, set ANOTHER to 67, then complete. After that,</span></span>
<span class="line"><span style="color: #032F62"> check if ANOTHER is still available."</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6F42C1">AGENT:</span></span>
<span class="line"><span style="color: #032F62">"I'll set MYSTERY and spawn a sub-agent."</span></span>
<span class="line"><span style="color: #6F42C1">$</span><span style="color: #24292E"> </span><span style="color: #032F62">./setenv.sh</span><span style="color: #24292E"> </span><span style="color: #032F62">MYSTERY</span><span style="color: #24292E"> </span><span style="color: #005CC5">42</span></span>
<span class="line"><span style="color: #032F62">"Now spawning a sub-agent to check MYSTERY and set ANOTHER..."</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6F42C1">SUB-AGENT:</span></span>
<span class="line"><span style="color: #6F42C1">$</span><span style="color: #24292E"> </span><span style="color: #032F62">echo</span><span style="color: #24292E"> $MYSTERY</span></span>
<span class="line"><span style="color: #005CC5">42</span></span>
<span class="line"><span style="color: #6F42C1">$</span><span style="color: #24292E"> </span><span style="color: #032F62">./setenv.sh</span><span style="color: #24292E"> </span><span style="color: #032F62">ANOTHER</span><span style="color: #24292E"> </span><span style="color: #005CC5">67</span></span>
<span class="line"><span style="color: #6F42C1">$</span><span style="color: #24292E"> </span><span style="color: #032F62">echo</span><span style="color: #24292E"> $ANOTHER</span></span>
<span class="line"><span style="color: #005CC5">67</span></span>
<span class="line"><span style="color: #6A737D"># Task complete.</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6F42C1">AGENT:</span></span>
<span class="line"><span style="color: #032F62">"The sub-agent confirmed MYSTERY=42 and set ANOTHER=67. Let me check if</span></span>
<span class="line"><span style="color: #032F62"> ANOTHER persists:"</span></span>
<span class="line"><span style="color: #6F42C1">$</span><span style="color: #24292E"> </span><span style="color: #032F62">echo</span><span style="color: #24292E"> $ANOTHER</span></span>
<span class="line"><span style="color: #6A737D"># (empty)</span></span></code></pre><pre data-language="bash" data-theme="dark"><code data-language="bash" data-theme="dark"><span class="line"><span style="color: #B392F0">USER:</span></span>
<span class="line"><span style="color: #9ECBFF">"Set MYSTERY to 42 using setenv.sh, then spawn a sub-agent. The sub-agent</span></span>
<span class="line"><span style="color: #9ECBFF"> should check the MYSTERY value, set ANOTHER to 67, then complete. After that,</span></span>
<span class="line"><span style="color: #9ECBFF"> check if ANOTHER is still available."</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B392F0">AGENT:</span></span>
<span class="line"><span style="color: #9ECBFF">"I'll set MYSTERY and spawn a sub-agent."</span></span>
<span class="line"><span style="color: #B392F0">$</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">./setenv.sh</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">MYSTERY</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">42</span></span>
<span class="line"><span style="color: #9ECBFF">"Now spawning a sub-agent to check MYSTERY and set ANOTHER..."</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B392F0">SUB-AGENT:</span></span>
<span class="line"><span style="color: #B392F0">$</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">echo</span><span style="color: #E1E4E8"> $MYSTERY</span></span>
<span class="line"><span style="color: #79B8FF">42</span></span>
<span class="line"><span style="color: #B392F0">$</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">./setenv.sh</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">ANOTHER</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">67</span></span>
<span class="line"><span style="color: #B392F0">$</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">echo</span><span style="color: #E1E4E8"> $ANOTHER</span></span>
<span class="line"><span style="color: #79B8FF">67</span></span>
<span class="line"><span style="color: #6A737D"># Task complete.</span></span>
<span class="line"></span>
<span class="line"><span style="color: #B392F0">AGENT:</span></span>
<span class="line"><span style="color: #9ECBFF">"The sub-agent confirmed MYSTERY=42 and set ANOTHER=67. Let me check if</span></span>
<span class="line"><span style="color: #9ECBFF"> ANOTHER persists:"</span></span>
<span class="line"><span style="color: #B392F0">$</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">echo</span><span style="color: #E1E4E8"> $ANOTHER</span></span>
<span class="line"><span style="color: #6A737D"># (empty)</span></span></code></pre></div>
<p>As expected, <code>ANOTHER</code> is not available. When the sub-agent completed, its env file (containing <code>ANOTHER=67</code>) was removed by the SubagentStop hook. Only the parent's variables persist.</p>
<h2 id="conclusion"><a href="#conclusion">Conclusion</a></h2>
<p>We achieved transparent environment variable inheritance across the agent hierarchy without modifying prompts or wasting tokens on parameter passing. The stack-based approach correctly handles nested sub-agents and ensures proper cleanup when agents complete.</p>
<p>Note that this solution is simplified and supports only one Claude Code session at a time.</p>c:["$","div",null,{"className":"flex justify-center","children":["$","div",null,{"className":"md:px-10 min-w-0 max-w-7xl mb-12","children":["$","article",null,{"children":[["$","header",null,{"className":"px-5 mb-4 py-10 relative","children":[["$","h1",null,{"className":"text-3xl leading-none tracking-tight text-gray-900 md:text-4xl lg:text-5xl dark:text-gray-100","children":"Env Vars in Claude Code Sub-Agent Chain"}],["$","time",null,{"dateTime":"2025-12-01 16:00","className":"pl-1 font-serif text-slate-400 bottom-0 absolute","children":[["$","svg",null,{"className":"h-4 w-4 inline-block","width":"24","height":"24","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 24 24","fill":"none","stroke":"currentColor","strokeWidth":"2","strokeLinecap":"round","strokeLinejoin":"round","children":[["$","path",null,{"d":"M12 19l7-7 3 3-7 7-3-3z"}]," ",["$","path",null,{"d":"M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"}]," ",["$","path",null,{"d":"M2 2l7.586 7.586"}]," ",["$","circle",null,{"cx":"11","cy":"11","r":"2"}]]}]," ","2025-12-01 16:00"]}]]}],["$","div",null,{"className":"bg-slate-100 dark:bg-slate-800 p-5 pb-12 rounded shadow-lg","children":[[["$","p",null,{"className":"italic text-slate-400 p-4","dangerouslySetInnerHTML":{"__html":"This article was written based on Claude Code v2.0.55."}}],["$","hr",null,{"className":"h-px my-4 bg-gray-200 border-0 dark:bg-gray-700"}]],["$","div",null,{"className":"space-y-4","dangerouslySetInnerHTML":{"__html":"$d"}}]]}]]}]}]}]
b:null
