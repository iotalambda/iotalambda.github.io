1:HL["/_next/static/media/583a894d7b920fb7-s.p.woff2",{"as":"font","type":"font/woff2"}]
2:HL["/_next/static/media/e807dee2426166ad-s.p.woff2",{"as":"font","type":"font/woff2"}]
3:HL["/_next/static/css/cf6d346f04b2f900.css",{"as":"style"}]
0:["VCasLb-gA5eaYkvFoeITl",[[["",{"children":[["id","2025/12/17/Claude-Code-Agent-Chaining-with-Async-Interventions","c"],{"children":["__PAGE__?{\"id\":[\"2025\",\"12\",\"17\",\"Claude-Code-Agent-Chaining-with-Async-Interventions\"]}",{}]}]},"$undefined","$undefined",true],"$L4",[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/cf6d346f04b2f900.css","precedence":"next"}]],"$L5"]]]]
6:HL["/_next/static/css/4823b726c835f640.css",{"as":"style"}]
7:I{"id":6685,"chunks":["685:static/chunks/685-8c2a2ee442f8842a.js","185:static/chunks/app/layout-4978ca41370bd554.js"],"name":"","async":false}
8:I{"id":6112,"chunks":["685:static/chunks/685-8c2a2ee442f8842a.js","185:static/chunks/app/layout-4978ca41370bd554.js"],"name":"","async":false}
9:I{"id":7767,"chunks":["272:static/chunks/webpack-efd16f5debe934f5.js","971:static/chunks/fd9d1056-9200b628bfbdc6da.js","596:static/chunks/596-98393ace57ba3968.js"],"name":"default","async":false}
a:I{"id":7920,"chunks":["272:static/chunks/webpack-efd16f5debe934f5.js","971:static/chunks/fd9d1056-9200b628bfbdc6da.js","596:static/chunks/596-98393ace57ba3968.js"],"name":"default","async":false}
4:[null,["$","html",null,{"lang":"en","className":"__variable_eb9fb7 __variable_2fad4c","children":["$","body",null,{"className":"bg-slate-200 dark:bg-slate-700","children":[["$","nav",null,{"className":"w-full flex flex-row justify-between items-center bg-indigo-600 shadow-indigo-300 dark:shadow-indigo-800 shadow-2xl font-sans","children":[["$","div",null,{"className":"p-2","children":["$","$L7",null,{"className":"text-2xl font-semibold text-neutral-100 dark:text-neutral-200","href":"/","children":[["$","h1",null,{"className":"inline","children":"üçî food for ai"}]," ",["$","span",null,{"className":"font-mono font-light text-xs","children":"food.joona.cloud"}]]}]}],["$","$L8",null,{"className":"mr-2"}]]}],["$","main",null,{"className":"mt-4","children":["$","$L9",null,{"parallelRouterKey":"children","segmentPath":["children"],"loading":"$undefined","loadingStyles":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","template":["$","$La",null,{}],"templateStyles":"$undefined","notFound":[["$","title",null,{"children":"404: This page could not be found."}],["$","div",null,{"style":{"fontFamily":"system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"","height":"100vh","textAlign":"center","display":"flex","flexDirection":"column","alignItems":"center","justifyContent":"center"},"children":["$","div",null,{"children":[["$","style",null,{"dangerouslySetInnerHTML":{"__html":"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}"}}],["$","h1",null,{"className":"next-error-h1","style":{"display":"inline-block","margin":"0 20px 0 0","padding":"0 23px 0 0","fontSize":24,"fontWeight":500,"verticalAlign":"top","lineHeight":"49px"},"children":"404"}],["$","div",null,{"style":{"display":"inline-block"},"children":["$","h2",null,{"style":{"fontSize":14,"fontWeight":400,"lineHeight":"49px","margin":0},"children":"This page could not be found."}]}]]}]}]],"notFoundStyles":[],"childProp":{"current":["$","$L9",null,{"parallelRouterKey":"children","segmentPath":["children",["id","2025/12/17/Claude-Code-Agent-Chaining-with-Async-Interventions","c"],"children"],"loading":"$undefined","loadingStyles":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","template":["$","$La",null,{}],"templateStyles":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","childProp":{"current":["$Lb","$Lc",null],"segment":"__PAGE__?{\"id\":[\"2025\",\"12\",\"17\",\"Claude-Code-Agent-Chaining-with-Async-Interventions\"]}"},"styles":[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/4823b726c835f640.css","precedence":"next"}]]}],"segment":["id","2025/12/17/Claude-Code-Agent-Chaining-with-Async-Interventions","c"]},"styles":[]}]}]]}]}],null]
5:[["$","meta","0",{"charSet":"utf-8"}],["$","title","1",{"children":"Claude Code Agent Chaining with Async Interventions | Food for AI blog"}],["$","meta","2",{"name":"description","content":"Blog about .NET, Azure, React and whatever comes to mind."}],["$","meta","3",{"name":"viewport","content":"width=device-width, initial-scale=1"}],["$","link","4",{"rel":"icon","href":"/favicon.ico","type":"image/x-icon","sizes":"16x16"}],["$","meta","5",{"name":"next-size-adjust"}]]
d:T75fb,<p>The <a href="https://platform.claude.com/docs/en/agent-sdk/overview">Claude Agent SDK</a> allows building deeply nested sub-agent chains. An agent spawns a sub-agent, which spawns a sub-sub-agent, which spawns a sub-sub-sub-agent ‚Äì each level delegating work downward. But what if a sub-agent deep down needs to ask something from the user?</p>
<p>Claude Code has an <a href="https://code.claude.com/docs/en/settings#tools-available-to-claude">AskUserQuestion</a> tool, but it can't be used by sub-agents, only the main one.</p>
<p>Even if we could surface inquiries through the chain, it would be even more useful if every agent in the chain could end their turn while waiting for the user to respond (they might need hours or days), and then resume later from wherever the work was left.</p>
<h2 id="a-custom-spawn-convention"><a href="#a-custom-spawn-convention">A Custom Spawn Convention</a></h2>
<p>The idea is to define a simple convention in <code>CLAUDE.md</code> that agents follow. We create a <code>_spawn_</code> keyword that starts a sub-agent via a custom CLI (simplified here ‚Äì see <a href="https://github.com/iotalambda/claude-code-async-chain">the repo</a> for full implementation):</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="markdown" data-theme="light"><code data-language="markdown" data-theme="light"><span class="line"><span style="color: #005CC5; font-weight: bold">## Actions</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">| Keyword             | Action                                         |</span></span>
<span class="line"><span style="color: #24292E">| ------------------- | ---------------------------------------------- |</span></span>
<span class="line"><span style="color: #24292E">| </span><span style="color: #24292E; font-style: italic">_spawn_</span><span style="color: #24292E"> </span><span style="color: #005CC5">`{f}.md`</span><span style="color: #24292E">    | Run </span><span style="color: #005CC5">`$PWD/agent-cli spawn $PWD/{f}.md`</span><span style="color: #24292E">         |</span></span>
<span class="line"><span style="color: #24292E">| </span><span style="color: #24292E; font-style: italic">_terminate_</span><span style="color: #24292E"> "{msg}" | Stop immediately, reply exactly "{msg}"        |</span></span>
<span class="line"><span style="color: #24292E">| </span><span style="color: #24292E; font-style: italic">_ask_</span><span style="color: #24292E"> "{q}"         | Create question.md, then terminate with signal |</span></span></code></pre><pre data-language="markdown" data-theme="dark"><code data-language="markdown" data-theme="dark"><span class="line"><span style="color: #79B8FF; font-weight: bold">## Actions</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">| Keyword             | Action                                         |</span></span>
<span class="line"><span style="color: #E1E4E8">| ------------------- | ---------------------------------------------- |</span></span>
<span class="line"><span style="color: #E1E4E8">| </span><span style="color: #E1E4E8; font-style: italic">_spawn_</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">`{f}.md`</span><span style="color: #E1E4E8">    | Run </span><span style="color: #79B8FF">`$PWD/agent-cli spawn $PWD/{f}.md`</span><span style="color: #E1E4E8">         |</span></span>
<span class="line"><span style="color: #E1E4E8">| </span><span style="color: #E1E4E8; font-style: italic">_terminate_</span><span style="color: #E1E4E8"> "{msg}" | Stop immediately, reply exactly "{msg}"        |</span></span>
<span class="line"><span style="color: #E1E4E8">| </span><span style="color: #E1E4E8; font-style: italic">_ask_</span><span style="color: #E1E4E8"> "{q}"         | Create question.md, then terminate with signal |</span></span></code></pre></div>
<p>The CLI wraps the Agent SDK's <code>query()</code> function:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="typescript" data-theme="light"><code data-language="typescript" data-theme="light"><span class="line"><span style="color: #D73A49">async</span><span style="color: #24292E"> </span><span style="color: #D73A49">function</span><span style="color: #24292E"> </span><span style="color: #6F42C1">spawn</span><span style="color: #24292E">(</span><span style="color: #E36209">instructionFile</span><span style="color: #D73A49">:</span><span style="color: #24292E"> </span><span style="color: #005CC5">string</span><span style="color: #24292E">)</span><span style="color: #D73A49">:</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Promise</span><span style="color: #24292E">&#x3C;</span><span style="color: #005CC5">void</span><span style="color: #24292E">> {</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">prompt</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #032F62">`Read ${</span><span style="color: #24292E">instructionFile</span><span style="color: #032F62">} and follow its instructions.`</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> { </span><span style="color: #005CC5">output</span><span style="color: #24292E">, </span><span style="color: #005CC5">sessionId</span><span style="color: #24292E"> } </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">await</span><span style="color: #24292E"> </span><span style="color: #6F42C1">runAgent</span><span style="color: #24292E">(prompt)</span></span>
<span class="line"><span style="color: #24292E">  console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #6F42C1">formatOutput</span><span style="color: #24292E">(output, sessionId))</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre><pre data-language="typescript" data-theme="dark"><code data-language="typescript" data-theme="dark"><span class="line"><span style="color: #F97583">async</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">function</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">spawn</span><span style="color: #E1E4E8">(</span><span style="color: #FFAB70">instructionFile</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">string</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Promise</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #79B8FF">void</span><span style="color: #E1E4E8">> {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">prompt</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">`Read ${</span><span style="color: #E1E4E8">instructionFile</span><span style="color: #9ECBFF">} and follow its instructions.`</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> { </span><span style="color: #79B8FF">output</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">sessionId</span><span style="color: #E1E4E8"> } </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">runAgent</span><span style="color: #E1E4E8">(prompt)</span></span>
<span class="line"><span style="color: #E1E4E8">  console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">formatOutput</span><span style="color: #E1E4E8">(output, sessionId))</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre></div>
<p>Now we can create a 4-deep chain with simple instruction files:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="markdown" data-theme="light"><code data-language="markdown" data-theme="light"><span class="line"><span style="color: #005CC5; font-weight: bold"># ins1-a.md (Agent)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E; font-style: italic">_spawn_</span><span style="color: #24292E"> </span><span style="color: #005CC5">`ins2-sa.md`</span><span style="color: #24292E">, then </span><span style="color: #24292E; font-style: italic">_terminate_</span><span style="color: #24292E"> with the sub-agent's reply.</span></span>
<span class="line"></span>
<span class="line"><span style="color: #005CC5; font-weight: bold"># ins2-sa.md (Sub-agent)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E; font-style: italic">_spawn_</span><span style="color: #24292E"> </span><span style="color: #005CC5">`ins3-ssa.md`</span><span style="color: #24292E">, then </span><span style="color: #24292E; font-style: italic">_terminate_</span><span style="color: #24292E"> with the sub-agent's reply.</span></span>
<span class="line"></span>
<span class="line"><span style="color: #005CC5; font-weight: bold"># ins3-ssa.md (Sub-sub-agent)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E; font-style: italic">_spawn_</span><span style="color: #24292E"> </span><span style="color: #005CC5">`ins4-sssa.md`</span><span style="color: #24292E">, then </span><span style="color: #24292E; font-style: italic">_terminate_</span><span style="color: #24292E"> with the sub-agent's reply.</span></span>
<span class="line"></span>
<span class="line"><span style="color: #005CC5; font-weight: bold"># ins4-sssa.md (Sub-sub-sub-agent)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E; font-style: italic">_ask_</span><span style="color: #24292E"> "When is your birthday?", then </span><span style="color: #24292E; font-style: italic">_terminate_</span><span style="color: #24292E"> with the answer.</span></span></code></pre><pre data-language="markdown" data-theme="dark"><code data-language="markdown" data-theme="dark"><span class="line"><span style="color: #79B8FF; font-weight: bold"># ins1-a.md (Agent)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8; font-style: italic">_spawn_</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">`ins2-sa.md`</span><span style="color: #E1E4E8">, then </span><span style="color: #E1E4E8; font-style: italic">_terminate_</span><span style="color: #E1E4E8"> with the sub-agent's reply.</span></span>
<span class="line"></span>
<span class="line"><span style="color: #79B8FF; font-weight: bold"># ins2-sa.md (Sub-agent)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8; font-style: italic">_spawn_</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">`ins3-ssa.md`</span><span style="color: #E1E4E8">, then </span><span style="color: #E1E4E8; font-style: italic">_terminate_</span><span style="color: #E1E4E8"> with the sub-agent's reply.</span></span>
<span class="line"></span>
<span class="line"><span style="color: #79B8FF; font-weight: bold"># ins3-ssa.md (Sub-sub-agent)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8; font-style: italic">_spawn_</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">`ins4-sssa.md`</span><span style="color: #E1E4E8">, then </span><span style="color: #E1E4E8; font-style: italic">_terminate_</span><span style="color: #E1E4E8"> with the sub-agent's reply.</span></span>
<span class="line"></span>
<span class="line"><span style="color: #79B8FF; font-weight: bold"># ins4-sssa.md (Sub-sub-sub-agent)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8; font-style: italic">_ask_</span><span style="color: #E1E4E8"> "When is your birthday?", then </span><span style="color: #E1E4E8; font-style: italic">_terminate_</span><span style="color: #E1E4E8"> with the answer.</span></span></code></pre></div>
<p>When the deepest agent needs to wait, it terminates with <code>SGN_PEND_STARTED</code>. Each parent sees this signal and propagates it upward. Every agent in the chain <strong>ends their turn right there</strong>.</p>
<p>The signals follow a simple protocol:</p>
<ul>
<li><code>SGN_PEND_STARTED</code> ‚Äì "I started waiting for something." Propagates upward, each agent stores its sub-agent's session ID before passing the signal up.</li>
<li><code>SGN_PEND_ONGOING</code> ‚Äì "Still waiting." When resumed, if the wait condition isn't met yet, this bubbles up unchanged.</li>
<li><code>SGN_RESUME</code> ‚Äì "Check if you can proceed." Sent downward on resume. Each agent forwards it to its sub-agent until reaching the one that's waiting.</li>
</ul>
<p>When an agent receives <code>SGN_RESUME</code>, it checks: did I already finish? Then return my previous result. Was I waiting for something? Check if it's ready. Was my sub-agent pending? Forward <code>SGN_RESUME</code> to them. (See the <a href="https://github.com/iotalambda/claude-code-async-chain/blob/main/CLAUDE.md?plain=1#standard-operating-procedure-sop">full SOP in CLAUDE.md</a>.)</p>
<h2 id="cracks-in-the-chain"><a href="#cracks-in-the-chain">Cracks in the Chain</a></h2>
<p>Claude Code <a href="https://www.reddit.com/r/ClaudeAI/comments/1phj60q/news_resumable_subagents_in_claude_code_v2060/">started supporting resumable sub-agents in v2.0.60</a>, but only natively. So that doesn't help our custom Agent SDK based <code>_spawn_</code> ‚Äì we need our own way to resume. Why not use native sub-agents? Because <a href="https://www.reddit.com/r/ClaudeAI/comments/1maeefc/se_puede_ejecutar_un_agente_dentro_de_un/?tl=en">sub-agents via the Task tool cannot spawn further sub-agents</a>, so the max depth would be 2, and we must go deeper.</p>
<p>The naive solution is straightforward ‚Äì just resume the session:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="typescript" data-theme="light"><code data-language="typescript" data-theme="light"><span class="line"><span style="color: #D73A49">async</span><span style="color: #24292E"> </span><span style="color: #D73A49">function</span><span style="color: #24292E"> </span><span style="color: #6F42C1">resume</span><span style="color: #24292E">(</span><span style="color: #E36209">sessionId</span><span style="color: #D73A49">:</span><span style="color: #24292E"> </span><span style="color: #005CC5">string</span><span style="color: #24292E">)</span><span style="color: #D73A49">:</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Promise</span><span style="color: #24292E">&#x3C;</span><span style="color: #005CC5">void</span><span style="color: #24292E">> {</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> { </span><span style="color: #005CC5">output</span><span style="color: #24292E">, </span><span style="color: #E36209">sessionId</span><span style="color: #24292E">: </span><span style="color: #005CC5">newId</span><span style="color: #24292E"> } </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">await</span><span style="color: #24292E"> </span><span style="color: #6F42C1">runAgent</span><span style="color: #24292E">(</span><span style="color: #032F62">"SGN_RESUME"</span><span style="color: #24292E">, sessionId)</span></span>
<span class="line"><span style="color: #24292E">  console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #6F42C1">formatOutput</span><span style="color: #24292E">(output, newId))</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre><pre data-language="typescript" data-theme="dark"><code data-language="typescript" data-theme="dark"><span class="line"><span style="color: #F97583">async</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">function</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">resume</span><span style="color: #E1E4E8">(</span><span style="color: #FFAB70">sessionId</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">string</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Promise</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #79B8FF">void</span><span style="color: #E1E4E8">> {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> { </span><span style="color: #79B8FF">output</span><span style="color: #E1E4E8">, </span><span style="color: #FFAB70">sessionId</span><span style="color: #E1E4E8">: </span><span style="color: #79B8FF">newId</span><span style="color: #E1E4E8"> } </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">runAgent</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"SGN_RESUME"</span><span style="color: #E1E4E8">, sessionId)</span></span>
<span class="line"><span style="color: #E1E4E8">  console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">formatOutput</span><span style="color: #E1E4E8">(output, newId))</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre></div>
<p>The flow works: we send <code>SGN_RESUME</code>, each agent checks if it can proceed, and either the result or <code>SGN_PEND_ONGOING</code> bubbles back up.</p>
<p>But there's a problem. If resume is called multiple times ‚Äì say, polling every minute to check if the user has responded ‚Äì each attempt adds messages to every agent's context, wasting tokens:</p>
<pre><code>Attempt 1: SGN_RESUME ‚Üí SGN_PEND_ONGOING
Attempt 2: SGN_RESUME ‚Üí SGN_PEND_ONGOING
Attempt 3: SGN_RESUME ‚Üí SGN_PEND_ONGOING
...
</code></pre>
<p>Poll 50 times and you've added 100 messages to each agent. <strong>The context explodes.</strong></p>
<p><a href="https://code.claude.com/docs/en/costs#reduce-token-usage">Conversation compacting</a> would help, but then you risk losing actual important details from earlier ‚Äì the original instructions, intermediate results, things the agent needs to remember.</p>
<h2 id="better-solution-fork-on-resume"><a href="#better-solution-fork-on-resume">Better Solution: Fork on Resume</a></h2>
<p>The <a href="https://platform.claude.com/docs/en/agent-sdk/sessions#forking-sessions">Claude Agent SDK supports session forking</a> ‚Äì creating a new branch from an existing session <em>without modifying the original</em>:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="typescript" data-theme="light"><code data-language="typescript" data-theme="light"><span class="line"><span style="color: #D73A49">async</span><span style="color: #24292E"> </span><span style="color: #D73A49">function</span><span style="color: #24292E"> </span><span style="color: #6F42C1">resume</span><span style="color: #24292E">(</span><span style="color: #E36209">sessionId</span><span style="color: #D73A49">:</span><span style="color: #24292E"> </span><span style="color: #005CC5">string</span><span style="color: #24292E">)</span><span style="color: #D73A49">:</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Promise</span><span style="color: #24292E">&#x3C;</span><span style="color: #005CC5">void</span><span style="color: #24292E">> {</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> { </span><span style="color: #005CC5">output</span><span style="color: #24292E">, </span><span style="color: #E36209">sessionId</span><span style="color: #24292E">: </span><span style="color: #005CC5">forkedId</span><span style="color: #24292E"> } </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">await</span><span style="color: #24292E"> </span><span style="color: #6F42C1">runAgent</span><span style="color: #24292E">(</span><span style="color: #032F62">"SGN_RESUME"</span><span style="color: #24292E">, sessionId, { fork: </span><span style="color: #005CC5">true</span><span style="color: #24292E"> })</span></span>
<span class="line"><span style="color: #24292E">  console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #6F42C1">formatOutput</span><span style="color: #24292E">(output, forkedId))</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre><pre data-language="typescript" data-theme="dark"><code data-language="typescript" data-theme="dark"><span class="line"><span style="color: #F97583">async</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">function</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">resume</span><span style="color: #E1E4E8">(</span><span style="color: #FFAB70">sessionId</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">string</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Promise</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #79B8FF">void</span><span style="color: #E1E4E8">> {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> { </span><span style="color: #79B8FF">output</span><span style="color: #E1E4E8">, </span><span style="color: #FFAB70">sessionId</span><span style="color: #E1E4E8">: </span><span style="color: #79B8FF">forkedId</span><span style="color: #E1E4E8"> } </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">runAgent</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"SGN_RESUME"</span><span style="color: #E1E4E8">, sessionId, { fork: </span><span style="color: #79B8FF">true</span><span style="color: #E1E4E8"> })</span></span>
<span class="line"><span style="color: #E1E4E8">  console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">formatOutput</span><span style="color: #E1E4E8">(output, forkedId))</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre></div>
<p>Every resume creates a fork. What happens to it depends on the outcome:</p>
<ul>
<li>
<p><strong>If still pending</strong> (<code>SGN_PEND_ONGOING</code>): The fork is <em>discarded</em>. We return the original session ID, keeping the checkpoint clean for the next attempt.</p>
</li>
<li>
<p><strong>If progress was made</strong>: The fork becomes the <em>new checkpoint</em>. We return the forked session ID for future resumes.</p>
</li>
<li>
<p><strong>If a new pending started</strong>: Some agent in the chain started pending for something new, so <code>SGN_PEND_STARTED</code> bubbles up with fresh session IDs on all levels. We return the forked session ID as the new checkpoint.</p>
</li>
</ul>
<p>The <code>formatOutput</code> function handles this logic:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="typescript" data-theme="light"><code data-language="typescript" data-theme="light"><span class="line"><span style="color: #D73A49">function</span><span style="color: #24292E"> </span><span style="color: #6F42C1">formatOutput</span><span style="color: #24292E">(</span><span style="color: #E36209">output</span><span style="color: #D73A49">:</span><span style="color: #24292E"> </span><span style="color: #005CC5">string</span><span style="color: #24292E">, </span><span style="color: #E36209">sessionId</span><span style="color: #D73A49">:</span><span style="color: #24292E"> </span><span style="color: #005CC5">string</span><span style="color: #24292E">)</span><span style="color: #D73A49">:</span><span style="color: #24292E"> </span><span style="color: #005CC5">string</span><span style="color: #24292E"> {</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (output.</span><span style="color: #6F42C1">includes</span><span style="color: #24292E">(</span><span style="color: #032F62">"SGN_PEND_ONGOING"</span><span style="color: #24292E">)) {</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #032F62">"SGN_PEND_ONGOING"</span><span style="color: #24292E"> </span><span style="color: #6A737D">// Discard fork, keep original</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (output.</span><span style="color: #6F42C1">includes</span><span style="color: #24292E">(</span><span style="color: #032F62">"SGN_PEND_STARTED"</span><span style="color: #24292E">)) {</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #032F62">`SGN_PEND_STARTED (${</span><span style="color: #24292E">sessionId</span><span style="color: #032F62">})`</span><span style="color: #24292E"> </span><span style="color: #6A737D">// New checkpoint</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> output </span><span style="color: #6A737D">// Actual result, fork kept</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre><pre data-language="typescript" data-theme="dark"><code data-language="typescript" data-theme="dark"><span class="line"><span style="color: #F97583">function</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">formatOutput</span><span style="color: #E1E4E8">(</span><span style="color: #FFAB70">output</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">string</span><span style="color: #E1E4E8">, </span><span style="color: #FFAB70">sessionId</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">string</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">string</span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (output.</span><span style="color: #B392F0">includes</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"SGN_PEND_ONGOING"</span><span style="color: #E1E4E8">)) {</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"SGN_PEND_ONGOING"</span><span style="color: #E1E4E8"> </span><span style="color: #6A737D">// Discard fork, keep original</span></span>
<span class="line"><span style="color: #E1E4E8">  }</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (output.</span><span style="color: #B392F0">includes</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"SGN_PEND_STARTED"</span><span style="color: #E1E4E8">)) {</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">`SGN_PEND_STARTED (${</span><span style="color: #E1E4E8">sessionId</span><span style="color: #9ECBFF">})`</span><span style="color: #E1E4E8"> </span><span style="color: #6A737D">// New checkpoint</span></span>
<span class="line"><span style="color: #E1E4E8">  }</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> output </span><span style="color: #6A737D">// Actual result, fork kept</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre></div>
<p>Now you can poll as aggressively as you want! (Well, the inference still costs, so not too agressively.) Each unsuccessful attempt is just a throwaway fork and the original session's token budget is not wasted.</p>
<h2 id="achievements"><a href="#achievements">Achievements</a></h2>
<ol>
<li><strong>Arbitrarily deep agent chains</strong> ‚Äì not limited to the native 2-level depth</li>
<li><strong>Async interventions</strong> ‚Äì sub-agents can pause for external input</li>
<li><strong>Full end turn/resume</strong> ‚Äì agents can end their turn and resume later</li>
<li><strong>Polling w/o wasting $$$</strong> ‚Äì fork-based resumption prevents context pollution</li>
</ol>
<p>The <code>question.md</code> centered approach in the example is simplified for demonstration, and probably shouldn't be hard-coded in <code>CLAUDE.md</code>.</p>c:["$","div",null,{"className":"flex justify-center","children":["$","div",null,{"className":"md:px-10 min-w-0 max-w-7xl mb-12","children":["$","article",null,{"children":[["$","header",null,{"className":"px-5 mb-4 py-10 relative","children":[["$","h1",null,{"className":"text-3xl leading-none tracking-tight text-gray-900 md:text-4xl lg:text-5xl dark:text-gray-100","children":"Claude Code Agent Chaining with Async Interventions"}],["$","time",null,{"dateTime":"2025-12-17 12:00","className":"pl-1 font-serif text-slate-400 bottom-0 absolute","children":[["$","svg",null,{"className":"h-4 w-4 inline-block","width":"24","height":"24","xmlns":"http://www.w3.org/2000/svg","viewBox":"0 0 24 24","fill":"none","stroke":"currentColor","strokeWidth":"2","strokeLinecap":"round","strokeLinejoin":"round","children":[["$","path",null,{"d":"M12 19l7-7 3 3-7 7-3-3z"}]," ",["$","path",null,{"d":"M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"}]," ",["$","path",null,{"d":"M2 2l7.586 7.586"}]," ",["$","circle",null,{"cx":"11","cy":"11","r":"2"}]]}]," ","2025-12-17 12:00"]}]]}],["$","div",null,{"className":"bg-slate-100 dark:bg-slate-800 p-5 pb-12 rounded shadow-lg","children":[[["$","p",null,{"className":"italic text-slate-400 p-4","dangerouslySetInnerHTML":{"__html":"This article was written based on Claude Code v2.0.70. The full example is available in its <a href=\"https://github.com/iotalambda/claude-code-async-chain#readme\">GitHub repo</a>."}}],["$","hr",null,{"className":"h-px my-4 bg-gray-200 border-0 dark:bg-gray-700"}]],["$","div",null,{"className":"space-y-4","dangerouslySetInnerHTML":{"__html":"$d"}}]]}]]}]}]}]
b:null
