<!DOCTYPE html><html lang="en" class="__variable_eb9fb7 __variable_2fad4c"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" as="font" href="/_next/static/media/583a894d7b920fb7-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="preload" as="font" href="/_next/static/media/e807dee2426166ad-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/_next/static/css/cf6d346f04b2f900.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/4823b726c835f640.css" data-precedence="next"/><link rel="preload" href="/_next/static/chunks/webpack-efd16f5debe934f5.js" as="script" fetchPriority="low"/><script src="/_next/static/chunks/fd9d1056-9200b628bfbdc6da.js" async=""></script><script src="/_next/static/chunks/596-98393ace57ba3968.js" async=""></script><script src="/_next/static/chunks/main-app-d44f2405d2730b2d.js" async=""></script><title>Claude Code Agent Chaining with Async Interventions | Food for AI blog</title><meta name="description" content="Blog about .NET, Azure, React and whatever comes to mind."/><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="16x16"/><meta name="next-size-adjust"/><script src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js" noModule=""></script></head><body class="bg-slate-200 dark:bg-slate-700"><nav class="w-full flex flex-row justify-between items-center bg-indigo-600 shadow-indigo-300 dark:shadow-indigo-800 shadow-2xl font-sans"><div class="p-2"><a class="text-2xl font-semibold text-neutral-100 dark:text-neutral-200" href="/"><h1 class="inline">üçî food for ai</h1> <span class="font-mono font-light text-xs">food.joona.cloud</span></a></div></nav><main class="mt-4"><div class="flex justify-center"><div class="md:px-10 min-w-0 max-w-7xl mb-12"><article><header class="px-5 mb-4 py-10 relative"><h1 class="text-3xl leading-none tracking-tight text-gray-900 md:text-4xl lg:text-5xl dark:text-gray-100">Claude Code Agent Chaining with Async Interventions</h1><time dateTime="2025-12-17 12:00" class="pl-1 font-serif text-slate-400 bottom-0 absolute"><svg class="h-4 w-4 inline-block" width="24" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"></path> <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path> <path d="M2 2l7.586 7.586"></path> <circle cx="11" cy="11" r="2"></circle></svg> <!-- -->2025-12-17 12:00</time></header><div class="bg-slate-100 dark:bg-slate-800 p-5 pb-12 rounded shadow-lg"><p class="italic text-slate-400 p-4">This article was written based on Claude Code v2.0.70. The full example is available in its <a href="https://github.com/iotalambda/claude-code-async-chain#readme">GitHub repo</a>.</p><hr class="h-px my-4 bg-gray-200 border-0 dark:bg-gray-700"/><div class="space-y-4"><p>The <a href="https://platform.claude.com/docs/en/agent-sdk/overview">Claude Agent SDK</a> allows building deeply nested sub-agent chains. An agent spawns a sub-agent, which spawns a sub-sub-agent, which spawns a sub-sub-sub-agent ‚Äì each level delegating work downward. But what if a sub-agent deep down needs to ask something from the user?</p>
<p>Claude Code has an <a href="https://code.claude.com/docs/en/settings#tools-available-to-claude">AskUserQuestion</a> tool, but it can't be used by sub-agents, only the main one.</p>
<p>Even if we could surface inquiries through the chain, it would be even more useful if every agent in the chain could end their turn while waiting for the user to respond (they might need hours or days), and then resume later from wherever the work was left.</p>
<h2 id="a-custom-spawn-convention"><a href="#a-custom-spawn-convention">A Custom Spawn Convention</a></h2>
<p>The idea is to define a simple convention in <code>CLAUDE.md</code> that agents follow. We create a <code>_spawn_</code> keyword that starts a sub-agent via a custom CLI (simplified here ‚Äì see <a href="https://github.com/iotalambda/claude-code-async-chain">the repo</a> for full implementation):</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="markdown" data-theme="light"><code data-language="markdown" data-theme="light"><span class="line"><span style="color: #005CC5; font-weight: bold">## Actions</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E">| Keyword             | Action                                         |</span></span>
<span class="line"><span style="color: #24292E">| ------------------- | ---------------------------------------------- |</span></span>
<span class="line"><span style="color: #24292E">| </span><span style="color: #24292E; font-style: italic">_spawn_</span><span style="color: #24292E"> </span><span style="color: #005CC5">`{f}.md`</span><span style="color: #24292E">    | Run </span><span style="color: #005CC5">`$PWD/agent-cli spawn $PWD/{f}.md`</span><span style="color: #24292E">         |</span></span>
<span class="line"><span style="color: #24292E">| </span><span style="color: #24292E; font-style: italic">_terminate_</span><span style="color: #24292E"> "{msg}" | Stop immediately, reply exactly "{msg}"        |</span></span>
<span class="line"><span style="color: #24292E">| </span><span style="color: #24292E; font-style: italic">_ask_</span><span style="color: #24292E"> "{q}"         | Create question.md, then terminate with signal |</span></span></code></pre><pre data-language="markdown" data-theme="dark"><code data-language="markdown" data-theme="dark"><span class="line"><span style="color: #79B8FF; font-weight: bold">## Actions</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8">| Keyword             | Action                                         |</span></span>
<span class="line"><span style="color: #E1E4E8">| ------------------- | ---------------------------------------------- |</span></span>
<span class="line"><span style="color: #E1E4E8">| </span><span style="color: #E1E4E8; font-style: italic">_spawn_</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">`{f}.md`</span><span style="color: #E1E4E8">    | Run </span><span style="color: #79B8FF">`$PWD/agent-cli spawn $PWD/{f}.md`</span><span style="color: #E1E4E8">         |</span></span>
<span class="line"><span style="color: #E1E4E8">| </span><span style="color: #E1E4E8; font-style: italic">_terminate_</span><span style="color: #E1E4E8"> "{msg}" | Stop immediately, reply exactly "{msg}"        |</span></span>
<span class="line"><span style="color: #E1E4E8">| </span><span style="color: #E1E4E8; font-style: italic">_ask_</span><span style="color: #E1E4E8"> "{q}"         | Create question.md, then terminate with signal |</span></span></code></pre></div>
<p>The CLI wraps the Agent SDK's <code>query()</code> function:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="typescript" data-theme="light"><code data-language="typescript" data-theme="light"><span class="line"><span style="color: #D73A49">async</span><span style="color: #24292E"> </span><span style="color: #D73A49">function</span><span style="color: #24292E"> </span><span style="color: #6F42C1">spawn</span><span style="color: #24292E">(</span><span style="color: #E36209">instructionFile</span><span style="color: #D73A49">:</span><span style="color: #24292E"> </span><span style="color: #005CC5">string</span><span style="color: #24292E">)</span><span style="color: #D73A49">:</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Promise</span><span style="color: #24292E">&#x3C;</span><span style="color: #005CC5">void</span><span style="color: #24292E">> {</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">prompt</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #032F62">`Read ${</span><span style="color: #24292E">instructionFile</span><span style="color: #032F62">} and follow its instructions.`</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> { </span><span style="color: #005CC5">output</span><span style="color: #24292E">, </span><span style="color: #005CC5">sessionId</span><span style="color: #24292E"> } </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">await</span><span style="color: #24292E"> </span><span style="color: #6F42C1">runAgent</span><span style="color: #24292E">(prompt)</span></span>
<span class="line"><span style="color: #24292E">  console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #6F42C1">formatOutput</span><span style="color: #24292E">(output, sessionId))</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre><pre data-language="typescript" data-theme="dark"><code data-language="typescript" data-theme="dark"><span class="line"><span style="color: #F97583">async</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">function</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">spawn</span><span style="color: #E1E4E8">(</span><span style="color: #FFAB70">instructionFile</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">string</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Promise</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #79B8FF">void</span><span style="color: #E1E4E8">> {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">prompt</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">`Read ${</span><span style="color: #E1E4E8">instructionFile</span><span style="color: #9ECBFF">} and follow its instructions.`</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> { </span><span style="color: #79B8FF">output</span><span style="color: #E1E4E8">, </span><span style="color: #79B8FF">sessionId</span><span style="color: #E1E4E8"> } </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">runAgent</span><span style="color: #E1E4E8">(prompt)</span></span>
<span class="line"><span style="color: #E1E4E8">  console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">formatOutput</span><span style="color: #E1E4E8">(output, sessionId))</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre></div>
<p>Now we can create a 4-deep chain with simple instruction files:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="markdown" data-theme="light"><code data-language="markdown" data-theme="light"><span class="line"><span style="color: #005CC5; font-weight: bold"># ins1-a.md (Agent)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E; font-style: italic">_spawn_</span><span style="color: #24292E"> </span><span style="color: #005CC5">`ins2-sa.md`</span><span style="color: #24292E">, then </span><span style="color: #24292E; font-style: italic">_terminate_</span><span style="color: #24292E"> with the sub-agent's reply.</span></span>
<span class="line"></span>
<span class="line"><span style="color: #005CC5; font-weight: bold"># ins2-sa.md (Sub-agent)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E; font-style: italic">_spawn_</span><span style="color: #24292E"> </span><span style="color: #005CC5">`ins3-ssa.md`</span><span style="color: #24292E">, then </span><span style="color: #24292E; font-style: italic">_terminate_</span><span style="color: #24292E"> with the sub-agent's reply.</span></span>
<span class="line"></span>
<span class="line"><span style="color: #005CC5; font-weight: bold"># ins3-ssa.md (Sub-sub-agent)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E; font-style: italic">_spawn_</span><span style="color: #24292E"> </span><span style="color: #005CC5">`ins4-sssa.md`</span><span style="color: #24292E">, then </span><span style="color: #24292E; font-style: italic">_terminate_</span><span style="color: #24292E"> with the sub-agent's reply.</span></span>
<span class="line"></span>
<span class="line"><span style="color: #005CC5; font-weight: bold"># ins4-sssa.md (Sub-sub-sub-agent)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #24292E; font-style: italic">_ask_</span><span style="color: #24292E"> "When is your birthday?", then </span><span style="color: #24292E; font-style: italic">_terminate_</span><span style="color: #24292E"> with the answer.</span></span></code></pre><pre data-language="markdown" data-theme="dark"><code data-language="markdown" data-theme="dark"><span class="line"><span style="color: #79B8FF; font-weight: bold"># ins1-a.md (Agent)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8; font-style: italic">_spawn_</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">`ins2-sa.md`</span><span style="color: #E1E4E8">, then </span><span style="color: #E1E4E8; font-style: italic">_terminate_</span><span style="color: #E1E4E8"> with the sub-agent's reply.</span></span>
<span class="line"></span>
<span class="line"><span style="color: #79B8FF; font-weight: bold"># ins2-sa.md (Sub-agent)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8; font-style: italic">_spawn_</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">`ins3-ssa.md`</span><span style="color: #E1E4E8">, then </span><span style="color: #E1E4E8; font-style: italic">_terminate_</span><span style="color: #E1E4E8"> with the sub-agent's reply.</span></span>
<span class="line"></span>
<span class="line"><span style="color: #79B8FF; font-weight: bold"># ins3-ssa.md (Sub-sub-agent)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8; font-style: italic">_spawn_</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">`ins4-sssa.md`</span><span style="color: #E1E4E8">, then </span><span style="color: #E1E4E8; font-style: italic">_terminate_</span><span style="color: #E1E4E8"> with the sub-agent's reply.</span></span>
<span class="line"></span>
<span class="line"><span style="color: #79B8FF; font-weight: bold"># ins4-sssa.md (Sub-sub-sub-agent)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E1E4E8; font-style: italic">_ask_</span><span style="color: #E1E4E8"> "When is your birthday?", then </span><span style="color: #E1E4E8; font-style: italic">_terminate_</span><span style="color: #E1E4E8"> with the answer.</span></span></code></pre></div>
<p>When the deepest agent needs to wait, it terminates with <code>SGN_PEND_STARTED</code>. Each parent sees this signal and propagates it upward. Every agent in the chain <strong>ends their turn right there</strong>.</p>
<p>The signals follow a simple protocol:</p>
<ul>
<li><code>SGN_PEND_STARTED</code> ‚Äì "I started waiting for something." Propagates upward, each agent stores its sub-agent's session ID before passing the signal up.</li>
<li><code>SGN_PEND_ONGOING</code> ‚Äì "Still waiting." When resumed, if the wait condition isn't met yet, this bubbles up unchanged.</li>
<li><code>SGN_RESUME</code> ‚Äì "Check if you can proceed." Sent downward on resume. Each agent forwards it to its sub-agent until reaching the one that's waiting.</li>
</ul>
<p>When an agent receives <code>SGN_RESUME</code>, it checks: did I already finish? Then return my previous result. Was I waiting for something? Check if it's ready. Was my sub-agent pending? Forward <code>SGN_RESUME</code> to them. (See the <a href="https://github.com/iotalambda/claude-code-async-chain/blob/main/CLAUDE.md?plain=1#standard-operating-procedure-sop">full SOP in CLAUDE.md</a>.)</p>
<h2 id="cracks-in-the-chain"><a href="#cracks-in-the-chain">Cracks in the Chain</a></h2>
<p>Claude Code <a href="https://www.reddit.com/r/ClaudeAI/comments/1phj60q/news_resumable_subagents_in_claude_code_v2060/">started supporting resumable sub-agents in v2.0.60</a>, but only natively. So that doesn't help our custom Agent SDK based <code>_spawn_</code> ‚Äì we need our own way to resume. Why not use native sub-agents? Because <a href="https://www.reddit.com/r/ClaudeAI/comments/1maeefc/se_puede_ejecutar_un_agente_dentro_de_un/?tl=en">sub-agents via the Task tool cannot spawn further sub-agents</a>, so the max depth would be 2, and we must go deeper.</p>
<p>The naive solution is straightforward ‚Äì just resume the session:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="typescript" data-theme="light"><code data-language="typescript" data-theme="light"><span class="line"><span style="color: #D73A49">async</span><span style="color: #24292E"> </span><span style="color: #D73A49">function</span><span style="color: #24292E"> </span><span style="color: #6F42C1">resume</span><span style="color: #24292E">(</span><span style="color: #E36209">sessionId</span><span style="color: #D73A49">:</span><span style="color: #24292E"> </span><span style="color: #005CC5">string</span><span style="color: #24292E">)</span><span style="color: #D73A49">:</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Promise</span><span style="color: #24292E">&#x3C;</span><span style="color: #005CC5">void</span><span style="color: #24292E">> {</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> { </span><span style="color: #005CC5">output</span><span style="color: #24292E">, </span><span style="color: #E36209">sessionId</span><span style="color: #24292E">: </span><span style="color: #005CC5">newId</span><span style="color: #24292E"> } </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">await</span><span style="color: #24292E"> </span><span style="color: #6F42C1">runAgent</span><span style="color: #24292E">(</span><span style="color: #032F62">"SGN_RESUME"</span><span style="color: #24292E">, sessionId)</span></span>
<span class="line"><span style="color: #24292E">  console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #6F42C1">formatOutput</span><span style="color: #24292E">(output, newId))</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre><pre data-language="typescript" data-theme="dark"><code data-language="typescript" data-theme="dark"><span class="line"><span style="color: #F97583">async</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">function</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">resume</span><span style="color: #E1E4E8">(</span><span style="color: #FFAB70">sessionId</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">string</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Promise</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #79B8FF">void</span><span style="color: #E1E4E8">> {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> { </span><span style="color: #79B8FF">output</span><span style="color: #E1E4E8">, </span><span style="color: #FFAB70">sessionId</span><span style="color: #E1E4E8">: </span><span style="color: #79B8FF">newId</span><span style="color: #E1E4E8"> } </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">runAgent</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"SGN_RESUME"</span><span style="color: #E1E4E8">, sessionId)</span></span>
<span class="line"><span style="color: #E1E4E8">  console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">formatOutput</span><span style="color: #E1E4E8">(output, newId))</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre></div>
<p>The flow works: we send <code>SGN_RESUME</code>, each agent checks if it can proceed, and either the result or <code>SGN_PEND_ONGOING</code> bubbles back up.</p>
<p>But there's a problem. If resume is called multiple times ‚Äì say, polling every minute to check if the user has responded ‚Äì each attempt adds messages to every agent's context, wasting tokens:</p>
<pre><code>Attempt 1: SGN_RESUME ‚Üí SGN_PEND_ONGOING
Attempt 2: SGN_RESUME ‚Üí SGN_PEND_ONGOING
Attempt 3: SGN_RESUME ‚Üí SGN_PEND_ONGOING
...
</code></pre>
<p>Poll 50 times and you've added 100 messages to each agent. <strong>The context explodes.</strong></p>
<p><a href="https://code.claude.com/docs/en/costs#reduce-token-usage">Conversation compacting</a> would help, but then you risk losing actual important details from earlier ‚Äì the original instructions, intermediate results, things the agent needs to remember.</p>
<h2 id="better-solution-fork-on-resume"><a href="#better-solution-fork-on-resume">Better Solution: Fork on Resume</a></h2>
<p>The <a href="https://platform.claude.com/docs/en/agent-sdk/sessions#forking-sessions">Claude Agent SDK supports session forking</a> ‚Äì creating a new branch from an existing session <em>without modifying the original</em>:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="typescript" data-theme="light"><code data-language="typescript" data-theme="light"><span class="line"><span style="color: #D73A49">async</span><span style="color: #24292E"> </span><span style="color: #D73A49">function</span><span style="color: #24292E"> </span><span style="color: #6F42C1">resume</span><span style="color: #24292E">(</span><span style="color: #E36209">sessionId</span><span style="color: #D73A49">:</span><span style="color: #24292E"> </span><span style="color: #005CC5">string</span><span style="color: #24292E">)</span><span style="color: #D73A49">:</span><span style="color: #24292E"> </span><span style="color: #6F42C1">Promise</span><span style="color: #24292E">&#x3C;</span><span style="color: #005CC5">void</span><span style="color: #24292E">> {</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> { </span><span style="color: #005CC5">output</span><span style="color: #24292E">, </span><span style="color: #E36209">sessionId</span><span style="color: #24292E">: </span><span style="color: #005CC5">forkedId</span><span style="color: #24292E"> } </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">await</span><span style="color: #24292E"> </span><span style="color: #6F42C1">runAgent</span><span style="color: #24292E">(</span><span style="color: #032F62">"SGN_RESUME"</span><span style="color: #24292E">, sessionId, { fork: </span><span style="color: #005CC5">true</span><span style="color: #24292E"> })</span></span>
<span class="line"><span style="color: #24292E">  console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #6F42C1">formatOutput</span><span style="color: #24292E">(output, forkedId))</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre><pre data-language="typescript" data-theme="dark"><code data-language="typescript" data-theme="dark"><span class="line"><span style="color: #F97583">async</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">function</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">resume</span><span style="color: #E1E4E8">(</span><span style="color: #FFAB70">sessionId</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">string</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">Promise</span><span style="color: #E1E4E8">&#x3C;</span><span style="color: #79B8FF">void</span><span style="color: #E1E4E8">> {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">const</span><span style="color: #E1E4E8"> { </span><span style="color: #79B8FF">output</span><span style="color: #E1E4E8">, </span><span style="color: #FFAB70">sessionId</span><span style="color: #E1E4E8">: </span><span style="color: #79B8FF">forkedId</span><span style="color: #E1E4E8"> } </span><span style="color: #F97583">=</span><span style="color: #E1E4E8"> </span><span style="color: #F97583">await</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">runAgent</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"SGN_RESUME"</span><span style="color: #E1E4E8">, sessionId, { fork: </span><span style="color: #79B8FF">true</span><span style="color: #E1E4E8"> })</span></span>
<span class="line"><span style="color: #E1E4E8">  console.</span><span style="color: #B392F0">log</span><span style="color: #E1E4E8">(</span><span style="color: #B392F0">formatOutput</span><span style="color: #E1E4E8">(output, forkedId))</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre></div>
<p>Every resume creates a fork. What happens to it depends on the outcome:</p>
<ul>
<li>
<p><strong>If still pending</strong> (<code>SGN_PEND_ONGOING</code>): The fork is <em>discarded</em>. We return the original session ID, keeping the checkpoint clean for the next attempt.</p>
</li>
<li>
<p><strong>If progress was made</strong>: The fork becomes the <em>new checkpoint</em>. We return the forked session ID for future resumes.</p>
</li>
<li>
<p><strong>If a new pending started</strong>: Some agent in the chain started pending for something new, so <code>SGN_PEND_STARTED</code> bubbles up with fresh session IDs on all levels. We return the forked session ID as the new checkpoint.</p>
</li>
</ul>
<p>The <code>formatOutput</code> function handles this logic:</p>
<div data-rehype-pretty-code-fragment=""><pre data-language="typescript" data-theme="light"><code data-language="typescript" data-theme="light"><span class="line"><span style="color: #D73A49">function</span><span style="color: #24292E"> </span><span style="color: #6F42C1">formatOutput</span><span style="color: #24292E">(</span><span style="color: #E36209">output</span><span style="color: #D73A49">:</span><span style="color: #24292E"> </span><span style="color: #005CC5">string</span><span style="color: #24292E">, </span><span style="color: #E36209">sessionId</span><span style="color: #D73A49">:</span><span style="color: #24292E"> </span><span style="color: #005CC5">string</span><span style="color: #24292E">)</span><span style="color: #D73A49">:</span><span style="color: #24292E"> </span><span style="color: #005CC5">string</span><span style="color: #24292E"> {</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (output.</span><span style="color: #6F42C1">includes</span><span style="color: #24292E">(</span><span style="color: #032F62">"SGN_PEND_ONGOING"</span><span style="color: #24292E">)) {</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #032F62">"SGN_PEND_ONGOING"</span><span style="color: #24292E"> </span><span style="color: #6A737D">// Discard fork, keep original</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (output.</span><span style="color: #6F42C1">includes</span><span style="color: #24292E">(</span><span style="color: #032F62">"SGN_PEND_STARTED"</span><span style="color: #24292E">)) {</span></span>
<span class="line"><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #032F62">`SGN_PEND_STARTED (${</span><span style="color: #24292E">sessionId</span><span style="color: #032F62">})`</span><span style="color: #24292E"> </span><span style="color: #6A737D">// New checkpoint</span></span>
<span class="line"><span style="color: #24292E">  }</span></span>
<span class="line"><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> output </span><span style="color: #6A737D">// Actual result, fork kept</span></span>
<span class="line"><span style="color: #24292E">}</span></span></code></pre><pre data-language="typescript" data-theme="dark"><code data-language="typescript" data-theme="dark"><span class="line"><span style="color: #F97583">function</span><span style="color: #E1E4E8"> </span><span style="color: #B392F0">formatOutput</span><span style="color: #E1E4E8">(</span><span style="color: #FFAB70">output</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">string</span><span style="color: #E1E4E8">, </span><span style="color: #FFAB70">sessionId</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">string</span><span style="color: #E1E4E8">)</span><span style="color: #F97583">:</span><span style="color: #E1E4E8"> </span><span style="color: #79B8FF">string</span><span style="color: #E1E4E8"> {</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (output.</span><span style="color: #B392F0">includes</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"SGN_PEND_ONGOING"</span><span style="color: #E1E4E8">)) {</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">"SGN_PEND_ONGOING"</span><span style="color: #E1E4E8"> </span><span style="color: #6A737D">// Discard fork, keep original</span></span>
<span class="line"><span style="color: #E1E4E8">  }</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">if</span><span style="color: #E1E4E8"> (output.</span><span style="color: #B392F0">includes</span><span style="color: #E1E4E8">(</span><span style="color: #9ECBFF">"SGN_PEND_STARTED"</span><span style="color: #E1E4E8">)) {</span></span>
<span class="line"><span style="color: #E1E4E8">    </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> </span><span style="color: #9ECBFF">`SGN_PEND_STARTED (${</span><span style="color: #E1E4E8">sessionId</span><span style="color: #9ECBFF">})`</span><span style="color: #E1E4E8"> </span><span style="color: #6A737D">// New checkpoint</span></span>
<span class="line"><span style="color: #E1E4E8">  }</span></span>
<span class="line"><span style="color: #E1E4E8">  </span><span style="color: #F97583">return</span><span style="color: #E1E4E8"> output </span><span style="color: #6A737D">// Actual result, fork kept</span></span>
<span class="line"><span style="color: #E1E4E8">}</span></span></code></pre></div>
<p>Now you can poll as aggressively as you want! (Well, the inference still costs, so not too agressively.) Each unsuccessful attempt is just a throwaway fork and the original session's token budget is not wasted.</p>
<h2 id="achievements"><a href="#achievements">Achievements</a></h2>
<ol>
<li><strong>Arbitrarily deep agent chains</strong> ‚Äì not limited to the native 2-level depth</li>
<li><strong>Async interventions</strong> ‚Äì sub-agents can pause for external input</li>
<li><strong>Full end turn/resume</strong> ‚Äì agents can end their turn and resume later</li>
<li><strong>Polling w/o wasting $$$</strong> ‚Äì fork-based resumption prevents context pollution</li>
</ol>
<p>The <code>question.md</code> centered approach in the example is simplified for demonstration, and probably shouldn't be hard-coded in <code>CLAUDE.md</code>.</p></div></div></article></div></div></main><script src="/_next/static/chunks/webpack-efd16f5debe934f5.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/media/583a894d7b920fb7-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n2:HL[\"/_next/static/media/e807dee2426166ad-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n3:HL[\"/_next/static/css/cf6d346f04b2f900.css\",{\"as\":\"style\"}]\n0:\"$L4\"\n"])</script><script>self.__next_f.push([1,"5:HL[\"/_next/static/css/4823b726c835f640.css\",{\"as\":\"style\"}]\n"])</script><script>self.__next_f.push([1,"6:I{\"id\":7948,\"chunks\":[\"272:static/chunks/webpack-efd16f5debe934f5.js\",\"971:static/chunks/fd9d1056-9200b628bfbdc6da.js\",\"596:static/chunks/596-98393ace57ba3968.js\"],\"name\":\"default\",\"async\":false}\n8:I{\"id\":6628,\"chunks\":[\"272:static/chunks/webpack-efd16f5debe934f5.js\",\"971:static/chunks/fd9d1056-9200b628bfbdc6da.js\",\"596:static/chunks/596-98393ace57ba3968.js\"],\"name\":\"\",\"async\":false}\n9:I{\"id\":6685,\"chunks\":[\"685:static/chunks/685-8c2a2ee442f8842a.js\",\"185:static/chunks/app/layout-4978ca41370bd554.js\"],\"na"])</script><script>self.__next_f.push([1,"me\":\"\",\"async\":false}\na:I{\"id\":6112,\"chunks\":[\"685:static/chunks/685-8c2a2ee442f8842a.js\",\"185:static/chunks/app/layout-4978ca41370bd554.js\"],\"name\":\"\",\"async\":false}\nb:I{\"id\":7767,\"chunks\":[\"272:static/chunks/webpack-efd16f5debe934f5.js\",\"971:static/chunks/fd9d1056-9200b628bfbdc6da.js\",\"596:static/chunks/596-98393ace57ba3968.js\"],\"name\":\"default\",\"async\":false}\nc:I{\"id\":7920,\"chunks\":[\"272:static/chunks/webpack-efd16f5debe934f5.js\",\"971:static/chunks/fd9d1056-9200b628bfbdc6da.js\",\"596:static/chunks/596-983"])</script><script>self.__next_f.push([1,"93ace57ba3968.js\"],\"name\":\"default\",\"async\":false}\n"])</script><script>self.__next_f.push([1,"4:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/cf6d346f04b2f900.css\",\"precedence\":\"next\"}]],[\"$\",\"$L6\",null,{\"buildId\":\"VCasLb-gA5eaYkvFoeITl\",\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/2025/12/17/Claude-Code-Agent-Chaining-with-Async-Interventions\",\"initialTree\":[\"\",{\"children\":[[\"id\",\"2025/12/17/Claude-Code-Agent-Chaining-with-Async-Interventions\",\"c\"],{\"children\":[\"__PAGE__?{\\\"id\\\":[\\\"2025\\\",\\\"12\\\",\\\"17\\\",\\\"Claude-Code-Agent-Chaining-with-Async-Interventions\\\"]}\",{}]}]},\"$undefined\",\"$undefined\",true],\"initialHead\":[false,\"$L7\"],\"globalErrorComponent\":\"$8\",\"children\":[null,[\"$\",\"html\",null,{\"lang\":\"en\",\"className\":\"__variable_eb9fb7 __variable_2fad4c\",\"children\":[\"$\",\"body\",null,{\"className\":\"bg-slate-200 dark:bg-slate-700\",\"children\":[[\"$\",\"nav\",null,{\"className\":\"w-full flex flex-row justify-between items-center bg-indigo-600 shadow-indigo-300 dark:shadow-indigo-800 shadow-2xl font-sans\",\"children\":[[\"$\",\"div\",null,{\"className\":\"p-2\",\"children\":[\"$\",\"$L9\",null,{\"className\":\"text-2xl font-semibold text-neutral-100 dark:text-neutral-200\",\"href\":\"/\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"inline\",\"children\":\"üçî food for ai\"}],\" \",[\"$\",\"span\",null,{\"className\":\"font-mono font-light text-xs\",\"children\":\"food.joona.cloud\"}]]}]}],[\"$\",\"$La\",null,{\"className\":\"mr-2\"}]]}],[\"$\",\"main\",null,{\"className\":\"mt-4\",\"children\":[\"$\",\"$Lb\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"template\":[\"$\",\"$Lc\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[],\"childProp\":{\"current\":[\"$\",\"$Lb\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",[\"id\",\"2025/12/17/Claude-Code-Agent-Chaining-with-Async-Interventions\",\"c\"],\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"template\":[\"$\",\"$Lc\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$Ld\",\"$Le\",null],\"segment\":\"__PAGE__?{\\\"id\\\":[\\\"2025\\\",\\\"12\\\",\\\"17\\\",\\\"Claude-Code-Agent-Chaining-with-Async-Interventions\\\"]}\"},\"styles\":[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/4823b726c835f640.css\",\"precedence\":\"next\"}]]}],\"segment\":[\"id\",\"2025/12/17/Claude-Code-Agent-Chaining-with-Async-Interventions\",\"c\"]},\"styles\":[]}]}]]}]}],null]}]]\n"])</script><script>self.__next_f.push([1,"f:T75fb,"])</script><script>self.__next_f.push([1,"\u003cp\u003eThe \u003ca href=\"https://platform.claude.com/docs/en/agent-sdk/overview\"\u003eClaude Agent SDK\u003c/a\u003e allows building deeply nested sub-agent chains. An agent spawns a sub-agent, which spawns a sub-sub-agent, which spawns a sub-sub-sub-agent ‚Äì each level delegating work downward. But what if a sub-agent deep down needs to ask something from the user?\u003c/p\u003e\n\u003cp\u003eClaude Code has an \u003ca href=\"https://code.claude.com/docs/en/settings#tools-available-to-claude\"\u003eAskUserQuestion\u003c/a\u003e tool, but it can't be used by sub-agents, only the main one.\u003c/p\u003e\n\u003cp\u003eEven if we could surface inquiries through the chain, it would be even more useful if every agent in the chain could end their turn while waiting for the user to respond (they might need hours or days), and then resume later from wherever the work was left.\u003c/p\u003e\n\u003ch2 id=\"a-custom-spawn-convention\"\u003e\u003ca href=\"#a-custom-spawn-convention\"\u003eA Custom Spawn Convention\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eThe idea is to define a simple convention in \u003ccode\u003eCLAUDE.md\u003c/code\u003e that agents follow. We create a \u003ccode\u003e_spawn_\u003c/code\u003e keyword that starts a sub-agent via a custom CLI (simplified here ‚Äì see \u003ca href=\"https://github.com/iotalambda/claude-code-async-chain\"\u003ethe repo\u003c/a\u003e for full implementation):\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre data-language=\"markdown\" data-theme=\"light\"\u003e\u003ccode data-language=\"markdown\" data-theme=\"light\"\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #005CC5; font-weight: bold\"\u003e## Actions\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e| Keyword             | Action                                         |\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e| ------------------- | ---------------------------------------------- |\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e| \u003c/span\u003e\u003cspan style=\"color: #24292E; font-style: italic\"\u003e_spawn_\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003e`{f}.md`\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e    | Run \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003e`$PWD/agent-cli spawn $PWD/{f}.md`\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e         |\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e| \u003c/span\u003e\u003cspan style=\"color: #24292E; font-style: italic\"\u003e_terminate_\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \"{msg}\" | Stop immediately, reply exactly \"{msg}\"        |\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e| \u003c/span\u003e\u003cspan style=\"color: #24292E; font-style: italic\"\u003e_ask_\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \"{q}\"         | Create question.md, then terminate with signal |\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cpre data-language=\"markdown\" data-theme=\"dark\"\u003e\u003ccode data-language=\"markdown\" data-theme=\"dark\"\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #79B8FF; font-weight: bold\"\u003e## Actions\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e| Keyword             | Action                                         |\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e| ------------------- | ---------------------------------------------- |\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e| \u003c/span\u003e\u003cspan style=\"color: #E1E4E8; font-style: italic\"\u003e_spawn_\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003e`{f}.md`\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e    | Run \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003e`$PWD/agent-cli spawn $PWD/{f}.md`\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e         |\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e| \u003c/span\u003e\u003cspan style=\"color: #E1E4E8; font-style: italic\"\u003e_terminate_\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \"{msg}\" | Stop immediately, reply exactly \"{msg}\"        |\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e| \u003c/span\u003e\u003cspan style=\"color: #E1E4E8; font-style: italic\"\u003e_ask_\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \"{q}\"         | Create question.md, then terminate with signal |\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe CLI wraps the Agent SDK's \u003ccode\u003equery()\u003c/code\u003e function:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre data-language=\"typescript\" data-theme=\"light\"\u003e\u003ccode data-language=\"typescript\" data-theme=\"light\"\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D73A49\"\u003easync\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003efunction\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003espawn\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #E36209\"\u003einstructionFile\u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e:\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003estring\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e)\u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e:\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003ePromise\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003evoid\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003econst\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003eprompt\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e`Read ${\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003einstructionFile\u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e} and follow its instructions.`\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003econst\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e { \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003eoutput\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e, \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003esessionId\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e } \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003eawait\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003erunAgent\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(prompt)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  console.\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003elog\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eformatOutput\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(output, sessionId))\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cpre data-language=\"typescript\" data-theme=\"dark\"\u003e\u003ccode data-language=\"typescript\" data-theme=\"dark\"\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #F97583\"\u003easync\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003efunction\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003espawn\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #FFAB70\"\u003einstructionFile\u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e:\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003estring\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e)\u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e:\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003ePromise\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003evoid\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003econst\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003eprompt\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e`Read ${\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003einstructionFile\u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e} and follow its instructions.`\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003econst\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e { \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003eoutput\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e, \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003esessionId\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e } \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003eawait\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003erunAgent\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(prompt)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  console.\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003elog\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eformatOutput\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(output, sessionId))\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eNow we can create a 4-deep chain with simple instruction files:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre data-language=\"markdown\" data-theme=\"light\"\u003e\u003ccode data-language=\"markdown\" data-theme=\"light\"\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #005CC5; font-weight: bold\"\u003e# ins1-a.md (Agent)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E; font-style: italic\"\u003e_spawn_\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003e`ins2-sa.md`\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e, then \u003c/span\u003e\u003cspan style=\"color: #24292E; font-style: italic\"\u003e_terminate_\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e with the sub-agent's reply.\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #005CC5; font-weight: bold\"\u003e# ins2-sa.md (Sub-agent)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E; font-style: italic\"\u003e_spawn_\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003e`ins3-ssa.md`\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e, then \u003c/span\u003e\u003cspan style=\"color: #24292E; font-style: italic\"\u003e_terminate_\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e with the sub-agent's reply.\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #005CC5; font-weight: bold\"\u003e# ins3-ssa.md (Sub-sub-agent)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E; font-style: italic\"\u003e_spawn_\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003e`ins4-sssa.md`\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e, then \u003c/span\u003e\u003cspan style=\"color: #24292E; font-style: italic\"\u003e_terminate_\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e with the sub-agent's reply.\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #005CC5; font-weight: bold\"\u003e# ins4-sssa.md (Sub-sub-sub-agent)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E; font-style: italic\"\u003e_ask_\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \"When is your birthday?\", then \u003c/span\u003e\u003cspan style=\"color: #24292E; font-style: italic\"\u003e_terminate_\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e with the answer.\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cpre data-language=\"markdown\" data-theme=\"dark\"\u003e\u003ccode data-language=\"markdown\" data-theme=\"dark\"\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #79B8FF; font-weight: bold\"\u003e# ins1-a.md (Agent)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8; font-style: italic\"\u003e_spawn_\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003e`ins2-sa.md`\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e, then \u003c/span\u003e\u003cspan style=\"color: #E1E4E8; font-style: italic\"\u003e_terminate_\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e with the sub-agent's reply.\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #79B8FF; font-weight: bold\"\u003e# ins2-sa.md (Sub-agent)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8; font-style: italic\"\u003e_spawn_\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003e`ins3-ssa.md`\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e, then \u003c/span\u003e\u003cspan style=\"color: #E1E4E8; font-style: italic\"\u003e_terminate_\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e with the sub-agent's reply.\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #79B8FF; font-weight: bold\"\u003e# ins3-ssa.md (Sub-sub-agent)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8; font-style: italic\"\u003e_spawn_\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003e`ins4-sssa.md`\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e, then \u003c/span\u003e\u003cspan style=\"color: #E1E4E8; font-style: italic\"\u003e_terminate_\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e with the sub-agent's reply.\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #79B8FF; font-weight: bold\"\u003e# ins4-sssa.md (Sub-sub-sub-agent)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8; font-style: italic\"\u003e_ask_\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \"When is your birthday?\", then \u003c/span\u003e\u003cspan style=\"color: #E1E4E8; font-style: italic\"\u003e_terminate_\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e with the answer.\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eWhen the deepest agent needs to wait, it terminates with \u003ccode\u003eSGN_PEND_STARTED\u003c/code\u003e. Each parent sees this signal and propagates it upward. Every agent in the chain \u003cstrong\u003eends their turn right there\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThe signals follow a simple protocol:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eSGN_PEND_STARTED\u003c/code\u003e ‚Äì \"I started waiting for something.\" Propagates upward, each agent stores its sub-agent's session ID before passing the signal up.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eSGN_PEND_ONGOING\u003c/code\u003e ‚Äì \"Still waiting.\" When resumed, if the wait condition isn't met yet, this bubbles up unchanged.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eSGN_RESUME\u003c/code\u003e ‚Äì \"Check if you can proceed.\" Sent downward on resume. Each agent forwards it to its sub-agent until reaching the one that's waiting.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eWhen an agent receives \u003ccode\u003eSGN_RESUME\u003c/code\u003e, it checks: did I already finish? Then return my previous result. Was I waiting for something? Check if it's ready. Was my sub-agent pending? Forward \u003ccode\u003eSGN_RESUME\u003c/code\u003e to them. (See the \u003ca href=\"https://github.com/iotalambda/claude-code-async-chain/blob/main/CLAUDE.md?plain=1#standard-operating-procedure-sop\"\u003efull SOP in CLAUDE.md\u003c/a\u003e.)\u003c/p\u003e\n\u003ch2 id=\"cracks-in-the-chain\"\u003e\u003ca href=\"#cracks-in-the-chain\"\u003eCracks in the Chain\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eClaude Code \u003ca href=\"https://www.reddit.com/r/ClaudeAI/comments/1phj60q/news_resumable_subagents_in_claude_code_v2060/\"\u003estarted supporting resumable sub-agents in v2.0.60\u003c/a\u003e, but only natively. So that doesn't help our custom Agent SDK based \u003ccode\u003e_spawn_\u003c/code\u003e ‚Äì we need our own way to resume. Why not use native sub-agents? Because \u003ca href=\"https://www.reddit.com/r/ClaudeAI/comments/1maeefc/se_puede_ejecutar_un_agente_dentro_de_un/?tl=en\"\u003esub-agents via the Task tool cannot spawn further sub-agents\u003c/a\u003e, so the max depth would be 2, and we must go deeper.\u003c/p\u003e\n\u003cp\u003eThe naive solution is straightforward ‚Äì just resume the session:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre data-language=\"typescript\" data-theme=\"light\"\u003e\u003ccode data-language=\"typescript\" data-theme=\"light\"\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D73A49\"\u003easync\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003efunction\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eresume\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #E36209\"\u003esessionId\u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e:\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003estring\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e)\u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e:\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003ePromise\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003evoid\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003econst\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e { \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003eoutput\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e, \u003c/span\u003e\u003cspan style=\"color: #E36209\"\u003esessionId\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003enewId\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e } \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003eawait\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003erunAgent\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e\"SGN_RESUME\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e, sessionId)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  console.\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003elog\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eformatOutput\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(output, newId))\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cpre data-language=\"typescript\" data-theme=\"dark\"\u003e\u003ccode data-language=\"typescript\" data-theme=\"dark\"\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #F97583\"\u003easync\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003efunction\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eresume\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #FFAB70\"\u003esessionId\u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e:\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003estring\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e)\u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e:\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003ePromise\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003evoid\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003econst\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e { \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003eoutput\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e, \u003c/span\u003e\u003cspan style=\"color: #FFAB70\"\u003esessionId\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003enewId\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e } \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003eawait\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003erunAgent\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e\"SGN_RESUME\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e, sessionId)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  console.\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003elog\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eformatOutput\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(output, newId))\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe flow works: we send \u003ccode\u003eSGN_RESUME\u003c/code\u003e, each agent checks if it can proceed, and either the result or \u003ccode\u003eSGN_PEND_ONGOING\u003c/code\u003e bubbles back up.\u003c/p\u003e\n\u003cp\u003eBut there's a problem. If resume is called multiple times ‚Äì say, polling every minute to check if the user has responded ‚Äì each attempt adds messages to every agent's context, wasting tokens:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eAttempt 1: SGN_RESUME ‚Üí SGN_PEND_ONGOING\nAttempt 2: SGN_RESUME ‚Üí SGN_PEND_ONGOING\nAttempt 3: SGN_RESUME ‚Üí SGN_PEND_ONGOING\n...\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003ePoll 50 times and you've added 100 messages to each agent. \u003cstrong\u003eThe context explodes.\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://code.claude.com/docs/en/costs#reduce-token-usage\"\u003eConversation compacting\u003c/a\u003e would help, but then you risk losing actual important details from earlier ‚Äì the original instructions, intermediate results, things the agent needs to remember.\u003c/p\u003e\n\u003ch2 id=\"better-solution-fork-on-resume\"\u003e\u003ca href=\"#better-solution-fork-on-resume\"\u003eBetter Solution: Fork on Resume\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eThe \u003ca href=\"https://platform.claude.com/docs/en/agent-sdk/sessions#forking-sessions\"\u003eClaude Agent SDK supports session forking\u003c/a\u003e ‚Äì creating a new branch from an existing session \u003cem\u003ewithout modifying the original\u003c/em\u003e:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre data-language=\"typescript\" data-theme=\"light\"\u003e\u003ccode data-language=\"typescript\" data-theme=\"light\"\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D73A49\"\u003easync\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003efunction\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eresume\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #E36209\"\u003esessionId\u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e:\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003estring\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e)\u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e:\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003ePromise\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003evoid\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003econst\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e { \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003eoutput\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e, \u003c/span\u003e\u003cspan style=\"color: #E36209\"\u003esessionId\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003eforkedId\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e } \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003eawait\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003erunAgent\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e\"SGN_RESUME\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e, sessionId, { fork: \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003etrue\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e })\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  console.\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003elog\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eformatOutput\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(output, forkedId))\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cpre data-language=\"typescript\" data-theme=\"dark\"\u003e\u003ccode data-language=\"typescript\" data-theme=\"dark\"\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #F97583\"\u003easync\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003efunction\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eresume\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #FFAB70\"\u003esessionId\u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e:\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003estring\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e)\u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e:\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003ePromise\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003evoid\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003econst\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e { \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003eoutput\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e, \u003c/span\u003e\u003cspan style=\"color: #FFAB70\"\u003esessionId\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e: \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003eforkedId\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e } \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e=\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003eawait\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003erunAgent\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e\"SGN_RESUME\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e, sessionId, { fork: \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003etrue\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e })\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  console.\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003elog\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eformatOutput\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(output, forkedId))\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eEvery resume creates a fork. What happens to it depends on the outcome:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eIf still pending\u003c/strong\u003e (\u003ccode\u003eSGN_PEND_ONGOING\u003c/code\u003e): The fork is \u003cem\u003ediscarded\u003c/em\u003e. We return the original session ID, keeping the checkpoint clean for the next attempt.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eIf progress was made\u003c/strong\u003e: The fork becomes the \u003cem\u003enew checkpoint\u003c/em\u003e. We return the forked session ID for future resumes.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eIf a new pending started\u003c/strong\u003e: Some agent in the chain started pending for something new, so \u003ccode\u003eSGN_PEND_STARTED\u003c/code\u003e bubbles up with fresh session IDs on all levels. We return the forked session ID as the new checkpoint.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThe \u003ccode\u003eformatOutput\u003c/code\u003e function handles this logic:\u003c/p\u003e\n\u003cdiv data-rehype-pretty-code-fragment=\"\"\u003e\u003cpre data-language=\"typescript\" data-theme=\"light\"\u003e\u003ccode data-language=\"typescript\" data-theme=\"light\"\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #D73A49\"\u003efunction\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eformatOutput\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #E36209\"\u003eoutput\u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e:\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003estring\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e, \u003c/span\u003e\u003cspan style=\"color: #E36209\"\u003esessionId\u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e:\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003estring\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e)\u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003e:\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #005CC5\"\u003estring\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003eif\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e (output.\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eincludes\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e\"SGN_PEND_ONGOING\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e)) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003ereturn\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e\"SGN_PEND_ONGOING\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6A737D\"\u003e// Discard fork, keep original\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003eif\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e (output.\u003c/span\u003e\u003cspan style=\"color: #6F42C1\"\u003eincludes\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e\"SGN_PEND_STARTED\"\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e)) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003ereturn\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e`SGN_PEND_STARTED (${\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003esessionId\u003c/span\u003e\u003cspan style=\"color: #032F62\"\u003e})`\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6A737D\"\u003e// New checkpoint\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #D73A49\"\u003ereturn\u003c/span\u003e\u003cspan style=\"color: #24292E\"\u003e output \u003c/span\u003e\u003cspan style=\"color: #6A737D\"\u003e// Actual result, fork kept\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #24292E\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cpre data-language=\"typescript\" data-theme=\"dark\"\u003e\u003ccode data-language=\"typescript\" data-theme=\"dark\"\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #F97583\"\u003efunction\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eformatOutput\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #FFAB70\"\u003eoutput\u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e:\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003estring\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e, \u003c/span\u003e\u003cspan style=\"color: #FFAB70\"\u003esessionId\u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e:\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003estring\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e)\u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003e:\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #79B8FF\"\u003estring\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003eif\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e (output.\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eincludes\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e\"SGN_PEND_ONGOING\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e)) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003ereturn\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e\"SGN_PEND_ONGOING\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6A737D\"\u003e// Discard fork, keep original\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003eif\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e (output.\u003c/span\u003e\u003cspan style=\"color: #B392F0\"\u003eincludes\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e(\u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e\"SGN_PEND_STARTED\"\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e)) {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e    \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003ereturn\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e`SGN_PEND_STARTED (${\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003esessionId\u003c/span\u003e\u003cspan style=\"color: #9ECBFF\"\u003e})`\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e \u003c/span\u003e\u003cspan style=\"color: #6A737D\"\u003e// New checkpoint\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e  \u003c/span\u003e\u003cspan style=\"color: #F97583\"\u003ereturn\u003c/span\u003e\u003cspan style=\"color: #E1E4E8\"\u003e output \u003c/span\u003e\u003cspan style=\"color: #6A737D\"\u003e// Actual result, fork kept\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color: #E1E4E8\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eNow you can poll as aggressively as you want! (Well, the inference still costs, so not too agressively.) Each unsuccessful attempt is just a throwaway fork and the original session's token budget is not wasted.\u003c/p\u003e\n\u003ch2 id=\"achievements\"\u003e\u003ca href=\"#achievements\"\u003eAchievements\u003c/a\u003e\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eArbitrarily deep agent chains\u003c/strong\u003e ‚Äì not limited to the native 2-level depth\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAsync interventions\u003c/strong\u003e ‚Äì sub-agents can pause for external input\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eFull end turn/resume\u003c/strong\u003e ‚Äì agents can end their turn and resume later\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003ePolling w/o wasting $$$\u003c/strong\u003e ‚Äì fork-based resumption prevents context pollution\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eThe \u003ccode\u003equestion.md\u003c/code\u003e centered approach in the example is simplified for demonstration, and probably shouldn't be hard-coded in \u003ccode\u003eCLAUDE.md\u003c/code\u003e.\u003c/p\u003e"])</script><script>self.__next_f.push([1,"e:[\"$\",\"div\",null,{\"className\":\"flex justify-center\",\"children\":[\"$\",\"div\",null,{\"className\":\"md:px-10 min-w-0 max-w-7xl mb-12\",\"children\":[\"$\",\"article\",null,{\"children\":[[\"$\",\"header\",null,{\"className\":\"px-5 mb-4 py-10 relative\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"text-3xl leading-none tracking-tight text-gray-900 md:text-4xl lg:text-5xl dark:text-gray-100\",\"children\":\"Claude Code Agent Chaining with Async Interventions\"}],[\"$\",\"time\",null,{\"dateTime\":\"2025-12-17 12:00\",\"className\":\"pl-1 font-serif text-slate-400 bottom-0 absolute\",\"children\":[[\"$\",\"svg\",null,{\"className\":\"h-4 w-4 inline-block\",\"width\":\"24\",\"height\":\"24\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"viewBox\":\"0 0 24 24\",\"fill\":\"none\",\"stroke\":\"currentColor\",\"strokeWidth\":\"2\",\"strokeLinecap\":\"round\",\"strokeLinejoin\":\"round\",\"children\":[[\"$\",\"path\",null,{\"d\":\"M12 19l7-7 3 3-7 7-3-3z\"}],\" \",[\"$\",\"path\",null,{\"d\":\"M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z\"}],\" \",[\"$\",\"path\",null,{\"d\":\"M2 2l7.586 7.586\"}],\" \",[\"$\",\"circle\",null,{\"cx\":\"11\",\"cy\":\"11\",\"r\":\"2\"}]]}],\" \",\"2025-12-17 12:00\"]}]]}],[\"$\",\"div\",null,{\"className\":\"bg-slate-100 dark:bg-slate-800 p-5 pb-12 rounded shadow-lg\",\"children\":[[[\"$\",\"p\",null,{\"className\":\"italic text-slate-400 p-4\",\"dangerouslySetInnerHTML\":{\"__html\":\"This article was written based on Claude Code v2.0.70. The full example is available in its \u003ca href=\\\"https://github.com/iotalambda/claude-code-async-chain#readme\\\"\u003eGitHub repo\u003c/a\u003e.\"}}],[\"$\",\"hr\",null,{\"className\":\"h-px my-4 bg-gray-200 border-0 dark:bg-gray-700\"}]],[\"$\",\"div\",null,{\"className\":\"space-y-4\",\"dangerouslySetInnerHTML\":{\"__html\":\"$f\"}}]]}]]}]}]}]\n"])</script><script>self.__next_f.push([1,"7:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"1\",{\"children\":\"Claude Code Agent Chaining with Async Interventions | Food for AI blog\"}],[\"$\",\"meta\",\"2\",{\"name\":\"description\",\"content\":\"Blog about .NET, Azure, React and whatever comes to mind.\"}],[\"$\",\"meta\",\"3\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"link\",\"4\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"16x16\"}],[\"$\",\"meta\",\"5\",{\"name\":\"next-size-adjust\"}]]\nd:null\n"])</script></body></html>